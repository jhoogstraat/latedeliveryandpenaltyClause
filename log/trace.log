18:23:15 - [32minfo[39m: Using current directory as template folder
18:23:15 - [32minfo[39m: Loading a default sample.txt file.
18:23:15 - [34mdebug[39m: fromDirectory
18:23:15 - [34mdebug[39m: fromDirectory
18:23:15 - [34mdebug[39m: fromDirectory
18:23:15 - [34mdebug[39m: fromDirectory
18:23:15 - [34mdebug[39m: fromDirectory
18:23:15 - [34mdebug[39m: fromDirectory
18:23:15 - [34mdebug[39m: fromDirectory
18:23:15 - [34mdebug[39m: constructor
18:23:15 - [34mdebug[39m: constructor
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: processDirectory
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: processFile
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: processFile
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: processFile
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: processFile
18:23:15 - [34mdebug[39m: fromDirectory
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: processFile
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: processFile
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: processFile
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: processFile
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: processFile
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: processFile
18:23:15 - [34mdebug[39m: isFileInNodeModuleDir
18:23:15 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: fromDirectory
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processDirectory
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: fromDirectory
18:23:18 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:23:18 - [34mdebug[39m: fromDirectory
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: isFileInNodeModuleDir
18:23:18 - [34mdebug[39m: processFile
18:23:18 - [34mdebug[39m: fromDirectory
18:23:18 - [34mdebug[39m: buildGrammar
18:23:18 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
18:23:18 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:23:18 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
18:23:18 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
18:23:18 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
18:23:18 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
18:23:18 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
18:23:18 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
18:23:18 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
18:23:18 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
18:23:18 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
18:23:18 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
18:23:18 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
18:23:18 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
18:23:18 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
18:23:18 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
18:23:18 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "f5076b55-b21a-4718-8532-921434303f9b",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        clauseId : data[12]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:23:18 - [34mdebug[39m: fromDirectory
18:23:18 - [34mdebug[39m: fromDirectory
18:23:18 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"f5076b55-b21a-4718-8532-921434303f9b","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
18:23:18 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"f5076b55-b21a-4718-8532-921434303f9b","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
18:23:18 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35mf5076b55-b21a-4718-8532-921434303f9b[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyDuration[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m2[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
[33m}[39m
18:34:34 - [32minfo[39m: Using current directory as template folder
18:34:34 - [32minfo[39m: Loading a default sample.txt file.
18:34:34 - [32minfo[39m: Loading a single default request.json file.
18:34:34 - [32minfo[39m: Loading a default state.json file.
18:34:34 - [34mdebug[39m: fromDirectory
18:34:34 - [34mdebug[39m: fromDirectory
18:34:34 - [34mdebug[39m: fromDirectory
18:34:34 - [34mdebug[39m: fromDirectory
18:34:34 - [34mdebug[39m: fromDirectory
18:34:34 - [34mdebug[39m: fromDirectory
18:34:34 - [34mdebug[39m: fromDirectory
18:34:34 - [34mdebug[39m: constructor
18:34:34 - [34mdebug[39m: constructor
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processDirectory
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:34 - [34mdebug[39m: fromDirectory
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:34 - [34mdebug[39m: isFileInNodeModuleDir
18:34:34 - [34mdebug[39m: processFile
18:34:36 - [34mdebug[39m: fromDirectory
18:34:36 - [34mdebug[39m: isFileInNodeModuleDir
18:34:36 - [34mdebug[39m: isFileInNodeModuleDir
18:34:36 - [34mdebug[39m: isFileInNodeModuleDir
18:34:36 - [34mdebug[39m: isFileInNodeModuleDir
18:34:36 - [34mdebug[39m: isFileInNodeModuleDir
18:34:36 - [34mdebug[39m: processDirectory
18:34:36 - [34mdebug[39m: isFileInNodeModuleDir
18:34:36 - [34mdebug[39m: processFile
18:34:36 - [34mdebug[39m: isFileInNodeModuleDir
18:34:36 - [34mdebug[39m: processFile
18:34:36 - [34mdebug[39m: isFileInNodeModuleDir
18:34:36 - [34mdebug[39m: processFile
18:34:36 - [34mdebug[39m: isFileInNodeModuleDir
18:34:36 - [34mdebug[39m: processFile
18:34:36 - [34mdebug[39m: fromDirectory
18:34:36 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:34:37 - [34mdebug[39m: fromDirectory
18:34:37 - [34mdebug[39m: isFileInNodeModuleDir
18:34:37 - [34mdebug[39m: processFile
18:34:37 - [34mdebug[39m: isFileInNodeModuleDir
18:34:37 - [34mdebug[39m: processFile
18:34:37 - [34mdebug[39m: isFileInNodeModuleDir
18:34:37 - [34mdebug[39m: processFile
18:34:37 - [34mdebug[39m: isFileInNodeModuleDir
18:34:37 - [34mdebug[39m: processFile
18:34:37 - [34mdebug[39m: isFileInNodeModuleDir
18:34:37 - [34mdebug[39m: processFile
18:34:37 - [34mdebug[39m: isFileInNodeModuleDir
18:34:37 - [34mdebug[39m: processFile
18:34:37 - [34mdebug[39m: isFileInNodeModuleDir
18:34:37 - [34mdebug[39m: processFile
18:34:37 - [34mdebug[39m: isFileInNodeModuleDir
18:34:37 - [34mdebug[39m: processFile
18:34:37 - [34mdebug[39m: isFileInNodeModuleDir
18:34:37 - [34mdebug[39m: processFile
18:34:37 - [34mdebug[39m: fromDirectory
18:34:37 - [34mdebug[39m: buildGrammar
18:34:37 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
18:34:37 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:34:37 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
18:34:37 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
18:34:37 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
18:34:37 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
18:34:37 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
18:34:37 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
18:34:37 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
18:34:37 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
18:34:37 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
18:34:37 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
18:34:37 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
18:34:37 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
18:34:37 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
18:34:37 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
18:34:37 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "5bf6a003-d09e-470e-823c-dda424c9f3ad",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        clauseId : data[12]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:34:37 - [34mdebug[39m: fromDirectory
18:34:37 - [34mdebug[39m: fromDirectory
18:34:37 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"5bf6a003-d09e-470e-823c-dda424c9f3ad","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
18:34:37 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"5bf6a003-d09e-470e-823c-dda424c9f3ad","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
18:34:37 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
18:34:37 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
18:34:37 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
18:34:37 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-af201de906a64acbe85b4163b5528c5d53cdfd9ee7b910836a0c68062992e9a9[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mDecember 17, 2017 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m110.00000000000001[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m3998a344-37c7-4084-ba7f-de3ddcd0923e[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-07T16:34:37.201Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
17:46:08 - [32minfo[39m: Using current directory as template folder
17:46:08 - [32minfo[39m: Loading a default sample.txt file.
17:46:08 - [32minfo[39m: Loading a single default request.json file.
17:46:08 - [32minfo[39m: Loading a default state.json file.
17:46:08 - [34mdebug[39m: fromDirectory
17:46:08 - [34mdebug[39m: fromDirectory
17:46:08 - [34mdebug[39m: fromDirectory
17:46:08 - [34mdebug[39m: fromDirectory
17:46:08 - [34mdebug[39m: fromDirectory
17:46:08 - [34mdebug[39m: fromDirectory
17:46:08 - [34mdebug[39m: fromDirectory
17:46:08 - [34mdebug[39m: constructor
17:46:08 - [34mdebug[39m: constructor
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processDirectory
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:08 - [34mdebug[39m: fromDirectory
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:08 - [34mdebug[39m: isFileInNodeModuleDir
17:46:08 - [34mdebug[39m: processFile
17:46:09 - [34mdebug[39m: fromDirectory
17:46:09 - [34mdebug[39m: isFileInNodeModuleDir
17:46:09 - [34mdebug[39m: isFileInNodeModuleDir
17:46:09 - [34mdebug[39m: isFileInNodeModuleDir
17:46:09 - [34mdebug[39m: isFileInNodeModuleDir
17:46:09 - [34mdebug[39m: isFileInNodeModuleDir
17:46:09 - [34mdebug[39m: processDirectory
17:46:09 - [34mdebug[39m: isFileInNodeModuleDir
17:46:09 - [34mdebug[39m: processFile
17:46:09 - [34mdebug[39m: isFileInNodeModuleDir
17:46:09 - [34mdebug[39m: processFile
17:46:09 - [34mdebug[39m: isFileInNodeModuleDir
17:46:09 - [34mdebug[39m: processFile
17:46:09 - [34mdebug[39m: isFileInNodeModuleDir
17:46:09 - [34mdebug[39m: processFile
17:46:09 - [34mdebug[39m: fromDirectory
17:46:10 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



17:46:10 - [34mdebug[39m: fromDirectory
17:46:10 - [34mdebug[39m: isFileInNodeModuleDir
17:46:10 - [34mdebug[39m: processFile
17:46:10 - [34mdebug[39m: isFileInNodeModuleDir
17:46:10 - [34mdebug[39m: processFile
17:46:10 - [34mdebug[39m: isFileInNodeModuleDir
17:46:10 - [34mdebug[39m: processFile
17:46:10 - [34mdebug[39m: isFileInNodeModuleDir
17:46:10 - [34mdebug[39m: processFile
17:46:10 - [34mdebug[39m: isFileInNodeModuleDir
17:46:10 - [34mdebug[39m: processFile
17:46:10 - [34mdebug[39m: isFileInNodeModuleDir
17:46:10 - [34mdebug[39m: processFile
17:46:10 - [34mdebug[39m: isFileInNodeModuleDir
17:46:10 - [34mdebug[39m: processFile
17:46:10 - [34mdebug[39m: isFileInNodeModuleDir
17:46:10 - [34mdebug[39m: processFile
17:46:10 - [34mdebug[39m: isFileInNodeModuleDir
17:46:10 - [34mdebug[39m: processFile
17:46:10 - [34mdebug[39m: fromDirectory
17:46:10 - [34mdebug[39m: buildGrammar
17:46:10 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
17:46:10 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
17:46:10 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
17:46:10 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
17:46:10 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
17:46:10 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
17:46:10 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
17:46:10 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
17:46:10 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
17:46:10 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
17:46:10 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
17:46:10 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
17:46:10 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
17:46:10 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
17:46:10 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
17:46:10 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
17:46:10 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "6059ff3b-7368-452c-a55b-05ad39e400ff",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        clauseId : data[12]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
17:46:10 - [34mdebug[39m: fromDirectory
17:46:10 - [34mdebug[39m: fromDirectory
17:46:10 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"6059ff3b-7368-452c-a55b-05ad39e400ff","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:46:10 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"6059ff3b-7368-452c-a55b-05ad39e400ff","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:46:10 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
17:46:10 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
17:46:10 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
17:46:10 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-7b2af5599c0d90507813de55e4c54793971bdefaebafa696d930f15f65b7ebb8[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mDecember 17, 2017 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m110.00000000000001[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m6ca2169c-9c04-431b-a770-04f38e1d0aea[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T15:46:10.272Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
17:46:52 - [32minfo[39m: Using current directory as template folder
17:46:52 - [32minfo[39m: Loading a default sample.txt file.
17:46:52 - [32minfo[39m: Loading a single default request.json file.
17:46:52 - [32minfo[39m: Loading a default state.json file.
17:46:52 - [34mdebug[39m: fromDirectory
17:46:52 - [34mdebug[39m: fromDirectory
17:46:52 - [34mdebug[39m: fromDirectory
17:46:52 - [34mdebug[39m: fromDirectory
17:46:52 - [34mdebug[39m: fromDirectory
17:46:52 - [34mdebug[39m: fromDirectory
17:46:52 - [34mdebug[39m: fromDirectory
17:46:52 - [34mdebug[39m: constructor
17:46:52 - [34mdebug[39m: constructor
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processDirectory
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:52 - [34mdebug[39m: fromDirectory
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:52 - [34mdebug[39m: isFileInNodeModuleDir
17:46:52 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: fromDirectory
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processDirectory
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: fromDirectory
17:46:53 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



17:46:53 - [34mdebug[39m: fromDirectory
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: isFileInNodeModuleDir
17:46:53 - [34mdebug[39m: processFile
17:46:53 - [34mdebug[39m: fromDirectory
17:46:53 - [34mdebug[39m: buildGrammar
17:46:53 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
17:46:53 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
17:46:53 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
17:46:53 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
17:46:53 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
17:46:53 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
17:46:53 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
17:46:53 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
17:46:53 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
17:46:53 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
17:46:53 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
17:46:53 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
17:46:53 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
17:46:53 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
17:46:53 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
17:46:53 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
17:46:53 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "fb2f7db6-d2dd-4875-982a-eb6fc5642a98",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        clauseId : data[12]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
17:46:53 - [34mdebug[39m: fromDirectory
17:46:53 - [34mdebug[39m: fromDirectory
17:46:53 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"fb2f7db6-d2dd-4875-982a-eb6fc5642a98","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:46:53 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"fb2f7db6-d2dd-4875-982a-eb6fc5642a98","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:46:53 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
17:46:53 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
17:46:53 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
17:46:53 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-dfc3fd96e6fb5f9a07320eb311dab4b1b56433b7815394e1f7a9431da0a23835[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mDecember 17, 2017 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m110.00000000000001[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35mdd918078-71d9-468c-b974-057eb93a18a3[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T15:46:53.620Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
17:47:12 - [32minfo[39m: Using current directory as template folder
17:47:12 - [32minfo[39m: Loading a default sample.txt file.
17:47:12 - [32minfo[39m: Loading a single default request.json file.
17:47:12 - [32minfo[39m: Loading a default state.json file.
17:47:12 - [34mdebug[39m: fromDirectory
17:47:12 - [34mdebug[39m: fromDirectory
17:47:12 - [34mdebug[39m: fromDirectory
17:47:12 - [34mdebug[39m: fromDirectory
17:47:12 - [34mdebug[39m: fromDirectory
17:47:12 - [34mdebug[39m: fromDirectory
17:47:12 - [34mdebug[39m: fromDirectory
17:47:12 - [34mdebug[39m: constructor
17:47:12 - [34mdebug[39m: constructor
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processDirectory
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:12 - [34mdebug[39m: fromDirectory
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:12 - [34mdebug[39m: isFileInNodeModuleDir
17:47:12 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: fromDirectory
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processDirectory
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: fromDirectory
17:47:13 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



17:47:13 - [34mdebug[39m: fromDirectory
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: isFileInNodeModuleDir
17:47:13 - [34mdebug[39m: processFile
17:47:13 - [34mdebug[39m: fromDirectory
17:47:13 - [34mdebug[39m: buildGrammar
17:47:13 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
17:47:13 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
17:47:13 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
17:47:13 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
17:47:13 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
17:47:13 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
17:47:13 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
17:47:13 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
17:47:13 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
17:47:13 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
17:47:13 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
17:47:13 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
17:47:13 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
17:47:13 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
17:47:13 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
17:47:13 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
17:47:13 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "098fccff-7cae-49cf-90fc-044eb3d46b0c",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        clauseId : data[12]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
17:47:13 - [34mdebug[39m: fromDirectory
17:47:13 - [34mdebug[39m: fromDirectory
17:47:13 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"098fccff-7cae-49cf-90fc-044eb3d46b0c","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:47:13 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"098fccff-7cae-49cf-90fc-044eb3d46b0c","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:47:13 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
17:47:13 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
17:47:13 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
17:47:13 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-96c9dca70c6c60b0df0c5f7b8458a29d8d8a4c2f18285f99df29a46a801d2ac5[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mDecember 17, 2017 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m0[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m5e7565b7-3566-4ea8-ba1d-d26bd5140f64[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T15:47:13.742Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
17:47:25 - [32minfo[39m: Using current directory as template folder
17:47:25 - [32minfo[39m: Loading a default sample.txt file.
17:47:25 - [32minfo[39m: Loading a single default request.json file.
17:47:25 - [32minfo[39m: Loading a default state.json file.
17:47:25 - [34mdebug[39m: fromDirectory
17:47:25 - [34mdebug[39m: fromDirectory
17:47:25 - [34mdebug[39m: fromDirectory
17:47:25 - [34mdebug[39m: fromDirectory
17:47:25 - [34mdebug[39m: fromDirectory
17:47:25 - [34mdebug[39m: fromDirectory
17:47:25 - [34mdebug[39m: fromDirectory
17:47:25 - [34mdebug[39m: constructor
17:47:25 - [34mdebug[39m: constructor
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processDirectory
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:25 - [34mdebug[39m: fromDirectory
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:25 - [34mdebug[39m: isFileInNodeModuleDir
17:47:25 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: fromDirectory
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processDirectory
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: fromDirectory
17:47:28 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



17:47:28 - [34mdebug[39m: fromDirectory
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: isFileInNodeModuleDir
17:47:28 - [34mdebug[39m: processFile
17:47:28 - [34mdebug[39m: fromDirectory
17:47:28 - [34mdebug[39m: buildGrammar
17:47:28 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
17:47:28 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
17:47:28 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
17:47:28 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
17:47:28 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
17:47:28 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
17:47:28 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
17:47:28 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
17:47:28 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
17:47:28 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
17:47:28 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
17:47:28 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
17:47:28 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
17:47:28 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
17:47:28 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
17:47:28 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
17:47:28 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "45d3255a-6bf8-4176-a6a3-f9710d6dacb2",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        clauseId : data[12]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
17:47:28 - [34mdebug[39m: fromDirectory
17:47:28 - [34mdebug[39m: fromDirectory
17:47:28 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"45d3255a-6bf8-4176-a6a3-f9710d6dacb2","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:47:28 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"45d3255a-6bf8-4176-a6a3-f9710d6dacb2","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:47:28 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
17:47:28 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
17:47:28 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
17:47:28 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-3189f8ec0db393b62fc09204bf34a0e45b281a3b68f451aea60bd7d7c973a69c[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mDecember 17, 2017 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m110.00000000000001[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35mae47592a-b679-42df-a5aa-6cefc4954754[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T15:47:28.713Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
17:47:36 - [32minfo[39m: Using current directory as template folder
17:47:36 - [32minfo[39m: Loading a default sample.txt file.
17:47:36 - [32minfo[39m: Loading a single default request.json file.
17:47:36 - [32minfo[39m: Loading a default state.json file.
17:47:36 - [34mdebug[39m: fromDirectory
17:47:36 - [34mdebug[39m: fromDirectory
17:47:36 - [34mdebug[39m: fromDirectory
17:47:36 - [34mdebug[39m: fromDirectory
17:47:36 - [34mdebug[39m: fromDirectory
17:47:36 - [34mdebug[39m: fromDirectory
17:47:36 - [34mdebug[39m: fromDirectory
17:47:36 - [34mdebug[39m: constructor
17:47:36 - [34mdebug[39m: constructor
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processDirectory
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:36 - [34mdebug[39m: fromDirectory
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:36 - [34mdebug[39m: isFileInNodeModuleDir
17:47:36 - [34mdebug[39m: processFile
17:47:37 - [34mdebug[39m: fromDirectory
17:47:37 - [34mdebug[39m: isFileInNodeModuleDir
17:47:37 - [34mdebug[39m: isFileInNodeModuleDir
17:47:37 - [34mdebug[39m: isFileInNodeModuleDir
17:47:37 - [34mdebug[39m: isFileInNodeModuleDir
17:47:37 - [34mdebug[39m: isFileInNodeModuleDir
17:47:37 - [34mdebug[39m: processDirectory
17:47:37 - [34mdebug[39m: isFileInNodeModuleDir
17:47:37 - [34mdebug[39m: processFile
17:47:37 - [34mdebug[39m: isFileInNodeModuleDir
17:47:37 - [34mdebug[39m: processFile
17:47:37 - [34mdebug[39m: isFileInNodeModuleDir
17:47:37 - [34mdebug[39m: processFile
17:47:37 - [34mdebug[39m: isFileInNodeModuleDir
17:47:37 - [34mdebug[39m: processFile
17:47:37 - [34mdebug[39m: fromDirectory
17:47:38 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



17:47:38 - [34mdebug[39m: fromDirectory
17:47:38 - [34mdebug[39m: isFileInNodeModuleDir
17:47:38 - [34mdebug[39m: processFile
17:47:38 - [34mdebug[39m: isFileInNodeModuleDir
17:47:38 - [34mdebug[39m: processFile
17:47:38 - [34mdebug[39m: isFileInNodeModuleDir
17:47:38 - [34mdebug[39m: processFile
17:47:38 - [34mdebug[39m: isFileInNodeModuleDir
17:47:38 - [34mdebug[39m: processFile
17:47:38 - [34mdebug[39m: isFileInNodeModuleDir
17:47:38 - [34mdebug[39m: processFile
17:47:38 - [34mdebug[39m: isFileInNodeModuleDir
17:47:38 - [34mdebug[39m: processFile
17:47:38 - [34mdebug[39m: isFileInNodeModuleDir
17:47:38 - [34mdebug[39m: processFile
17:47:38 - [34mdebug[39m: isFileInNodeModuleDir
17:47:38 - [34mdebug[39m: processFile
17:47:38 - [34mdebug[39m: isFileInNodeModuleDir
17:47:38 - [34mdebug[39m: processFile
17:47:38 - [34mdebug[39m: fromDirectory
17:47:38 - [34mdebug[39m: buildGrammar
17:47:38 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
17:47:38 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
17:47:38 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
17:47:38 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
17:47:38 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
17:47:38 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
17:47:38 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
17:47:38 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
17:47:38 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
17:47:38 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
17:47:38 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
17:47:38 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
17:47:38 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
17:47:38 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
17:47:38 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
17:47:38 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
17:47:38 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "8712d9c0-54ea-45e1-a0a9-118a53193fa1",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        clauseId : data[12]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
17:47:38 - [34mdebug[39m: fromDirectory
17:47:38 - [34mdebug[39m: fromDirectory
17:47:38 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"8712d9c0-54ea-45e1-a0a9-118a53193fa1","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:47:38 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"8712d9c0-54ea-45e1-a0a9-118a53193fa1","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:47:38 - [31merror[39m: Type AccordContractStated is not defined in namespace org.accordproject.cicero.contract
TypeNotFoundException: Type AccordContractStated is not defined in namespace org.accordproject.cicero.contract
    at ModelManager.getType (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/modelmanager.js:452:19)
    at Serializer.fromJSON (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer.js:155:52)
    at Engine.execute (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-engine/lib/engine.js:208:53)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:151:45)
    at process._tickCallback (internal/process/next_tick.js:68:7)
17:47:38 - [32minfo[39m: undefined
17:51:00 - [32minfo[39m: Using current directory as template folder
17:51:00 - [32minfo[39m: Loading a default sample.txt file.
17:51:00 - [32minfo[39m: Loading a single default request.json file.
17:51:00 - [32minfo[39m: Loading a default state.json file.
17:51:00 - [34mdebug[39m: fromDirectory
17:51:00 - [34mdebug[39m: fromDirectory
17:51:00 - [34mdebug[39m: fromDirectory
17:51:00 - [34mdebug[39m: fromDirectory
17:51:00 - [34mdebug[39m: fromDirectory
17:51:00 - [34mdebug[39m: fromDirectory
17:51:00 - [34mdebug[39m: fromDirectory
17:51:00 - [34mdebug[39m: constructor
17:51:00 - [34mdebug[39m: constructor
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processDirectory
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:00 - [34mdebug[39m: fromDirectory
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:00 - [34mdebug[39m: isFileInNodeModuleDir
17:51:00 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: fromDirectory
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processDirectory
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: fromDirectory
17:51:03 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



17:51:03 - [34mdebug[39m: fromDirectory
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: isFileInNodeModuleDir
17:51:03 - [34mdebug[39m: processFile
17:51:03 - [34mdebug[39m: fromDirectory
17:51:03 - [34mdebug[39m: buildGrammar
17:51:03 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
17:51:03 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
17:51:03 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
17:51:03 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
17:51:03 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
17:51:03 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
17:51:03 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
17:51:03 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
17:51:03 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
17:51:03 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
17:51:03 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
17:51:03 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
17:51:03 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
17:51:03 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
17:51:03 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
17:51:03 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
17:51:03 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "8bd1194c-3332-4c33-b486-d00696ad0167",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        clauseId : data[12]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
17:51:03 - [34mdebug[39m: fromDirectory
17:51:03 - [34mdebug[39m: fromDirectory
17:51:03 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"8bd1194c-3332-4c33-b486-d00696ad0167","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:51:03 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"8bd1194c-3332-4c33-b486-d00696ad0167","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:51:03 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
17:51:03 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
17:51:03 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
17:51:03 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-208cefe061eee7ea0174eb75a3c570b8d67dc18733dbf39a1b285247435307f2[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mDecember 17, 2017 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m110.00000000000001[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m6c2d8c6f-421c-4a7a-8238-92d739123cfa[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T15:51:03.624Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
17:53:55 - [32minfo[39m: Using current directory as template folder
17:53:55 - [32minfo[39m: Loading a default sample.txt file.
17:53:55 - [32minfo[39m: Loading a single default request.json file.
17:53:55 - [32minfo[39m: Loading a default state.json file.
17:53:55 - [34mdebug[39m: fromDirectory
17:53:55 - [34mdebug[39m: fromDirectory
17:53:55 - [34mdebug[39m: fromDirectory
17:53:55 - [34mdebug[39m: fromDirectory
17:53:55 - [34mdebug[39m: fromDirectory
17:53:55 - [34mdebug[39m: fromDirectory
17:53:55 - [34mdebug[39m: fromDirectory
17:53:55 - [34mdebug[39m: constructor
17:53:55 - [34mdebug[39m: constructor
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processDirectory
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:55 - [34mdebug[39m: fromDirectory
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:55 - [34mdebug[39m: isFileInNodeModuleDir
17:53:55 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: fromDirectory
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processDirectory
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: fromDirectory
17:53:56 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



17:53:56 - [34mdebug[39m: fromDirectory
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: isFileInNodeModuleDir
17:53:56 - [34mdebug[39m: processFile
17:53:56 - [34mdebug[39m: fromDirectory
17:53:56 - [34mdebug[39m: buildGrammar
17:53:56 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
17:53:56 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
17:53:56 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
17:53:56 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
17:53:56 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
17:53:56 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
17:53:56 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
17:53:56 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
17:53:56 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
17:53:56 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
17:53:57 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
17:53:57 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
17:53:57 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
17:53:57 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
17:53:57 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
17:53:57 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
17:53:57 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "9bce8316-bc3d-46a9-a778-f80c48c537a0",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        clauseId : data[12]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
17:53:57 - [34mdebug[39m: fromDirectory
17:53:57 - [34mdebug[39m: fromDirectory
17:53:57 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"9bce8316-bc3d-46a9-a778-f80c48c537a0","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:53:57 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"9bce8316-bc3d-46a9-a778-f80c48c537a0","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:53:57 - [31merror[39m: Type AccordContractStatej is not defined in namespace org.accordproject.cicero.contract
TypeNotFoundException: Type AccordContractStatej is not defined in namespace org.accordproject.cicero.contract
    at ModelManager.getType (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/modelmanager.js:452:19)
    at Serializer.fromJSON (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer.js:155:52)
    at Engine.execute (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-engine/lib/engine.js:208:53)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:151:45)
    at process._tickCallback (internal/process/next_tick.js:68:7)
17:53:57 - [32minfo[39m: undefined
17:54:16 - [32minfo[39m: Using current directory as template folder
17:54:16 - [32minfo[39m: Loading a default sample.txt file.
17:54:16 - [32minfo[39m: Loading a single default request.json file.
17:54:16 - [32minfo[39m: Loading a default state.json file.
17:54:16 - [34mdebug[39m: fromDirectory
17:54:16 - [34mdebug[39m: fromDirectory
17:54:16 - [34mdebug[39m: fromDirectory
17:54:16 - [34mdebug[39m: fromDirectory
17:54:16 - [34mdebug[39m: fromDirectory
17:54:16 - [34mdebug[39m: fromDirectory
17:54:16 - [34mdebug[39m: fromDirectory
17:54:16 - [34mdebug[39m: constructor
17:54:16 - [34mdebug[39m: constructor
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processDirectory
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:16 - [34mdebug[39m: fromDirectory
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:16 - [34mdebug[39m: isFileInNodeModuleDir
17:54:16 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: fromDirectory
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processDirectory
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: fromDirectory
17:54:17 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



17:54:17 - [34mdebug[39m: fromDirectory
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: isFileInNodeModuleDir
17:54:17 - [34mdebug[39m: processFile
17:54:17 - [34mdebug[39m: fromDirectory
17:54:17 - [34mdebug[39m: buildGrammar
17:54:17 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
17:54:17 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
17:54:17 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
17:54:17 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
17:54:17 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
17:54:17 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
17:54:17 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
17:54:17 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
17:54:17 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
17:54:17 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
17:54:17 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
17:54:17 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
17:54:17 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
17:54:17 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
17:54:17 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
17:54:17 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
17:54:17 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "48b97d99-f310-419f-9d90-be4cab9e89a2",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        clauseId : data[12]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
17:54:17 - [34mdebug[39m: fromDirectory
17:54:17 - [34mdebug[39m: fromDirectory
17:54:17 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"48b97d99-f310-419f-9d90-be4cab9e89a2","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:54:17 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"48b97d99-f310-419f-9d90-be4cab9e89a2","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
17:54:17 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
17:54:17 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
17:54:17 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
17:54:17 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-27433841d182a802636109303997951f088ce1e1005f0d386b30b1ba872a1cc0[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mDecember 17, 2017 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m110.00000000000001[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m0e293855-a3cc-4ed1-861a-3ec3bc0d66d7[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T15:54:17.798Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractStateg#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
18:21:49 - [32minfo[39m: Using current directory as template folder
18:21:49 - [32minfo[39m: Loading a default sample.txt file.
18:21:49 - [34mdebug[39m: fromDirectory
18:21:49 - [34mdebug[39m: fromDirectory
18:21:49 - [34mdebug[39m: fromDirectory
18:21:49 - [34mdebug[39m: fromDirectory
18:21:49 - [34mdebug[39m: fromDirectory
18:21:49 - [34mdebug[39m: fromDirectory
18:21:49 - [34mdebug[39m: fromDirectory
18:21:49 - [34mdebug[39m: constructor
18:21:49 - [34mdebug[39m: constructor
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processDirectory
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: fromDirectory
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: fromDirectory
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:49 - [34mdebug[39m: isFileInNodeModuleDir
18:21:49 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: fromDirectory
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processDirectory
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: fromDirectory
18:21:52 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:21:52 - [34mdebug[39m: fromDirectory
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: isFileInNodeModuleDir
18:21:52 - [34mdebug[39m: processFile
18:21:52 - [34mdebug[39m: fromDirectory
18:21:52 - [34mdebug[39m: buildGrammar
18:21:52 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
18:21:52 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:21:52 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
18:21:52 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
18:21:52 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
18:21:52 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
18:21:52 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
18:21:52 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
18:21:52 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
18:21:52 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
18:21:52 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
18:21:52 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
18:21:52 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
18:21:52 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
18:21:52 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
18:21:52 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
18:21:52 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "f78df60e-997c-4d62-9836-9e81aae26d3d",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Uncertainty  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:21:52 - [34mdebug[39m: fromDirectory
18:21:52 - [34mdebug[39m: fromDirectory
18:21:52 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"f78df60e-997c-4d62-9836-9e81aae26d3d","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
18:21:52 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"f78df60e-997c-4d62-9836-9e81aae26d3d","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
18:21:52 - [31merror[39m: Instance org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause#f78df60e-997c-4d62-9836-9e81aae26d3d missing required field unknown
ValidationException: Instance org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause#f78df60e-997c-4d62-9836-9e81aae26d3d missing required field unknown
    at Function.reportMissingRequiredProperty (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer/resourcevalidator.js:480:15)
    at ResourceValidator.visitClassDeclaration (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer/resourcevalidator.js:178:39)
    at ResourceValidator.visit (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer/resourcevalidator.js:74:25)
    at AssetDeclaration.accept (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/decorated.js:54:24)
    at ValidatedResource.validate (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/model/validatedresource.js:124:26)
    at Serializer.fromJSON (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer.js:193:22)
    at Clause.setData (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:62:61)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:113:14)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
18:21:52 - [32minfo[39m: undefined
18:22:17 - [32minfo[39m: Using current directory as template folder
18:22:17 - [32minfo[39m: Loading a default sample.txt file.
18:22:17 - [34mdebug[39m: fromDirectory
18:22:17 - [34mdebug[39m: fromDirectory
18:22:17 - [34mdebug[39m: fromDirectory
18:22:17 - [34mdebug[39m: fromDirectory
18:22:17 - [34mdebug[39m: fromDirectory
18:22:17 - [34mdebug[39m: fromDirectory
18:22:17 - [34mdebug[39m: fromDirectory
18:22:17 - [34mdebug[39m: constructor
18:22:17 - [34mdebug[39m: constructor
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processDirectory
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: fromDirectory
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: fromDirectory
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:17 - [34mdebug[39m: isFileInNodeModuleDir
18:22:17 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: fromDirectory
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processDirectory
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: fromDirectory
18:22:18 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:22:18 - [34mdebug[39m: fromDirectory
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: isFileInNodeModuleDir
18:22:18 - [34mdebug[39m: processFile
18:22:18 - [34mdebug[39m: fromDirectory
18:22:18 - [34mdebug[39m: buildGrammar
18:22:18 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
18:22:18 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:22:18 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
18:22:18 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
18:22:18 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
18:22:18 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
18:22:18 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
18:22:18 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
18:22:18 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
18:22:18 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
18:22:18 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
18:22:18 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
18:22:18 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
18:22:18 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
18:22:18 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
18:22:18 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
18:22:18 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "0c3a0a93-1605-47db-9636-2b17fa303b82",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Uncertainty:?  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:22:18 - [34mdebug[39m: fromDirectory
18:22:18 - [34mdebug[39m: fromDirectory
18:22:18 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"0c3a0a93-1605-47db-9636-2b17fa303b82","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
18:22:18 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"0c3a0a93-1605-47db-9636-2b17fa303b82","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
18:22:18 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m0c3a0a93-1605-47db-9636-2b17fa303b82[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyDuration[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m2[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
[33m}[39m
18:23:00 - [32minfo[39m: Using current directory as template folder
18:23:00 - [32minfo[39m: Loading a default sample.txt file.
18:23:00 - [34mdebug[39m: fromDirectory
18:23:00 - [34mdebug[39m: fromDirectory
18:23:00 - [34mdebug[39m: fromDirectory
18:23:00 - [34mdebug[39m: fromDirectory
18:23:00 - [34mdebug[39m: fromDirectory
18:23:00 - [34mdebug[39m: fromDirectory
18:23:00 - [34mdebug[39m: fromDirectory
18:23:00 - [34mdebug[39m: constructor
18:23:00 - [34mdebug[39m: constructor
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processDirectory
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: fromDirectory
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: fromDirectory
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [34mdebug[39m: isFileInNodeModuleDir
18:23:00 - [34mdebug[39m: processFile
18:23:00 - [31merror[39m: Undeclared type Uncertainty in property org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause.unknown 
IllegalModelException: Undeclared type Uncertainty in property org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause.unknown 
    at ModelFile.resolveType (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/modelfile.js:255:27)
    at Field.validate (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/property.js:94:38)
    at AssetDeclaration.validate (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/classdeclaration.js:259:23)
    at AssetDeclaration.validate (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/assetdeclaration.js:70:15)
    at ModelFile.validate (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/modelfile.js:235:30)
    at ModelManager.validateModelFiles (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/modelmanager.js:296:33)
    at modelFileDownloader.downloadExternalDependencies.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/modelmanager.js:334:30)
    at process._tickCallback (internal/process/next_tick.js:68:7)
18:23:00 - [32minfo[39m: undefined
18:23:13 - [32minfo[39m: Using current directory as template folder
18:23:13 - [32minfo[39m: Loading a default sample.txt file.
18:23:13 - [34mdebug[39m: fromDirectory
18:23:13 - [34mdebug[39m: fromDirectory
18:23:13 - [34mdebug[39m: fromDirectory
18:23:13 - [34mdebug[39m: fromDirectory
18:23:13 - [34mdebug[39m: fromDirectory
18:23:13 - [34mdebug[39m: fromDirectory
18:23:13 - [34mdebug[39m: fromDirectory
18:23:14 - [34mdebug[39m: constructor
18:23:14 - [34mdebug[39m: constructor
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processDirectory
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: fromDirectory
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: fromDirectory
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: fromDirectory
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processDirectory
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: fromDirectory
18:23:14 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:23:14 - [34mdebug[39m: fromDirectory
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: isFileInNodeModuleDir
18:23:14 - [34mdebug[39m: processFile
18:23:14 - [34mdebug[39m: fromDirectory
18:23:14 - [34mdebug[39m: buildGrammar
18:23:14 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
18:23:14 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:23:14 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
18:23:14 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
18:23:14 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
18:23:14 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
18:23:14 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
18:23:14 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
18:23:15 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
18:23:15 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
18:23:15 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
18:23:15 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
18:23:15 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
18:23:15 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
18:23:15 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
18:23:15 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
18:23:15 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "772e5b00-4dd6-45ea-ba0f-221a6764bef9",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Uncertainty:?  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:23:15 - [34mdebug[39m: fromDirectory
18:23:15 - [34mdebug[39m: fromDirectory
18:23:15 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"772e5b00-4dd6-45ea-ba0f-221a6764bef9","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
18:23:15 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"772e5b00-4dd6-45ea-ba0f-221a6764bef9","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
18:23:15 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m772e5b00-4dd6-45ea-ba0f-221a6764bef9[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyDuration[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m2[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
[33m}[39m
18:46:05 - [32minfo[39m: Using current directory as template folder
18:46:05 - [32minfo[39m: Loading a default sample.txt file.
18:46:05 - [34mdebug[39m: fromDirectory
18:46:05 - [34mdebug[39m: fromDirectory
18:46:05 - [34mdebug[39m: fromDirectory
18:46:05 - [34mdebug[39m: fromDirectory
18:46:05 - [34mdebug[39m: fromDirectory
18:46:05 - [34mdebug[39m: fromDirectory
18:46:05 - [34mdebug[39m: fromDirectory
18:46:05 - [34mdebug[39m: constructor
18:46:05 - [34mdebug[39m: constructor
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processDirectory
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: fromDirectory
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: fromDirectory
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: fromDirectory
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processDirectory
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: isFileInNodeModuleDir
18:46:05 - [34mdebug[39m: processFile
18:46:05 - [34mdebug[39m: fromDirectory
18:46:06 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:46:06 - [34mdebug[39m: fromDirectory
18:46:06 - [34mdebug[39m: isFileInNodeModuleDir
18:46:06 - [34mdebug[39m: processFile
18:46:06 - [34mdebug[39m: isFileInNodeModuleDir
18:46:06 - [34mdebug[39m: processFile
18:46:06 - [34mdebug[39m: isFileInNodeModuleDir
18:46:06 - [34mdebug[39m: processFile
18:46:06 - [34mdebug[39m: isFileInNodeModuleDir
18:46:06 - [34mdebug[39m: processFile
18:46:06 - [34mdebug[39m: isFileInNodeModuleDir
18:46:06 - [34mdebug[39m: processFile
18:46:06 - [34mdebug[39m: isFileInNodeModuleDir
18:46:06 - [34mdebug[39m: processFile
18:46:06 - [34mdebug[39m: isFileInNodeModuleDir
18:46:06 - [34mdebug[39m: processFile
18:46:06 - [34mdebug[39m: isFileInNodeModuleDir
18:46:06 - [34mdebug[39m: processFile
18:46:06 - [34mdebug[39m: isFileInNodeModuleDir
18:46:06 - [34mdebug[39m: processFile
18:46:06 - [34mdebug[39m: isFileInNodeModuleDir
18:46:06 - [34mdebug[39m: processFile
18:46:06 - [34mdebug[39m: fromDirectory
18:46:06 - [34mdebug[39m: buildGrammar
18:46:06 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":616,"lineBreaks":0,"line":1,"col":617}},null]}
18:46:06 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:46:06 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
18:46:06 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
18:46:06 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
18:46:06 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
18:46:06 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
18:46:06 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
18:46:06 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
18:46:06 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
18:46:06 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
18:46:06 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
18:46:06 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
18:46:06 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
18:46:06 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
18:46:06 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
18:46:06 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":616,"lineBreaks":0,"line":1,"col":617}}
18:46:06 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "b0e0fb2f-2071-469c-86d8-3b314311d8fc",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        unknown : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> Uncertainty:? {% id %} # unknown 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Uncertainty:?  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:46:06 - [34mdebug[39m: fromDirectory
18:46:06 - [34mdebug[39m: fromDirectory
18:46:06 - [31merror[39m: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "t"

Error: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "t"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
18:46:06 - [32minfo[39m: undefined
18:46:36 - [32minfo[39m: Using current directory as template folder
18:46:36 - [32minfo[39m: Loading a default sample.txt file.
18:46:36 - [34mdebug[39m: fromDirectory
18:46:36 - [34mdebug[39m: fromDirectory
18:46:36 - [34mdebug[39m: fromDirectory
18:46:36 - [34mdebug[39m: fromDirectory
18:46:36 - [34mdebug[39m: fromDirectory
18:46:36 - [34mdebug[39m: fromDirectory
18:46:36 - [34mdebug[39m: fromDirectory
18:46:36 - [34mdebug[39m: constructor
18:46:36 - [34mdebug[39m: constructor
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processDirectory
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: fromDirectory
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: fromDirectory
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:36 - [34mdebug[39m: isFileInNodeModuleDir
18:46:36 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: fromDirectory
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processDirectory
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: fromDirectory
18:46:37 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:46:37 - [34mdebug[39m: fromDirectory
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: isFileInNodeModuleDir
18:46:37 - [34mdebug[39m: processFile
18:46:37 - [34mdebug[39m: fromDirectory
18:46:37 - [34mdebug[39m: buildGrammar
18:46:37 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":616,"lineBreaks":0,"line":1,"col":617}},null]}
18:46:37 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:46:37 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
18:46:37 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
18:46:37 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
18:46:37 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
18:46:37 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
18:46:37 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
18:46:37 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
18:46:37 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
18:46:37 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
18:46:37 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
18:46:37 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
18:46:37 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
18:46:37 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
18:46:37 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
18:46:37 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":616,"lineBreaks":0,"line":1,"col":617}}
18:46:37 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "36cde910-a82f-47ad-90a7-e1b00fe8bf06",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        unknown : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> Uncertainty:? {% id %} # unknown 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Uncertainty:?  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:46:37 - [34mdebug[39m: fromDirectory
18:46:37 - [34mdebug[39m: fromDirectory
18:46:37 - [31merror[39m: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "t"

Error: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "t"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
18:46:37 - [32minfo[39m: undefined
18:47:29 - [32minfo[39m: Using current directory as template folder
18:47:29 - [32minfo[39m: Loading a default sample.txt file.
18:47:29 - [34mdebug[39m: fromDirectory
18:47:29 - [34mdebug[39m: fromDirectory
18:47:29 - [34mdebug[39m: fromDirectory
18:47:29 - [34mdebug[39m: fromDirectory
18:47:29 - [34mdebug[39m: fromDirectory
18:47:29 - [34mdebug[39m: fromDirectory
18:47:29 - [34mdebug[39m: fromDirectory
18:47:29 - [34mdebug[39m: constructor
18:47:29 - [34mdebug[39m: constructor
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processDirectory
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: fromDirectory
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: fromDirectory
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:29 - [34mdebug[39m: isFileInNodeModuleDir
18:47:29 - [34mdebug[39m: processFile
18:47:30 - [34mdebug[39m: fromDirectory
18:47:30 - [34mdebug[39m: isFileInNodeModuleDir
18:47:30 - [34mdebug[39m: isFileInNodeModuleDir
18:47:30 - [34mdebug[39m: isFileInNodeModuleDir
18:47:30 - [34mdebug[39m: isFileInNodeModuleDir
18:47:30 - [34mdebug[39m: isFileInNodeModuleDir
18:47:30 - [34mdebug[39m: processDirectory
18:47:30 - [34mdebug[39m: isFileInNodeModuleDir
18:47:30 - [34mdebug[39m: processFile
18:47:30 - [34mdebug[39m: isFileInNodeModuleDir
18:47:30 - [34mdebug[39m: processFile
18:47:30 - [34mdebug[39m: isFileInNodeModuleDir
18:47:30 - [34mdebug[39m: processFile
18:47:30 - [34mdebug[39m: isFileInNodeModuleDir
18:47:30 - [34mdebug[39m: processFile
18:47:30 - [34mdebug[39m: fromDirectory
18:47:31 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:47:31 - [34mdebug[39m: fromDirectory
18:47:31 - [34mdebug[39m: isFileInNodeModuleDir
18:47:31 - [34mdebug[39m: processFile
18:47:31 - [34mdebug[39m: isFileInNodeModuleDir
18:47:31 - [34mdebug[39m: processFile
18:47:31 - [34mdebug[39m: isFileInNodeModuleDir
18:47:31 - [34mdebug[39m: processFile
18:47:31 - [34mdebug[39m: isFileInNodeModuleDir
18:47:31 - [34mdebug[39m: processFile
18:47:31 - [34mdebug[39m: isFileInNodeModuleDir
18:47:31 - [34mdebug[39m: processFile
18:47:31 - [34mdebug[39m: isFileInNodeModuleDir
18:47:31 - [34mdebug[39m: processFile
18:47:31 - [34mdebug[39m: isFileInNodeModuleDir
18:47:31 - [34mdebug[39m: processFile
18:47:31 - [34mdebug[39m: isFileInNodeModuleDir
18:47:31 - [34mdebug[39m: processFile
18:47:31 - [34mdebug[39m: isFileInNodeModuleDir
18:47:31 - [34mdebug[39m: processFile
18:47:31 - [34mdebug[39m: isFileInNodeModuleDir
18:47:31 - [34mdebug[39m: processFile
18:47:31 - [34mdebug[39m: fromDirectory
18:47:31 - [34mdebug[39m: buildGrammar
18:47:31 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":616,"lineBreaks":0,"line":1,"col":617}},null]}
18:47:31 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:47:31 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
18:47:31 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
18:47:31 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
18:47:31 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
18:47:31 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
18:47:31 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
18:47:31 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
18:47:31 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
18:47:31 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
18:47:31 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
18:47:31 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
18:47:31 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
18:47:31 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
18:47:31 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
18:47:31 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":616,"lineBreaks":0,"line":1,"col":617}}
18:47:31 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "41475931-3c7d-437b-a939-05f387987bd6",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        unknown : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> String:? {% id %} # unknown 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String:?  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:47:31 - [34mdebug[39m: fromDirectory
18:47:31 - [34mdebug[39m: fromDirectory
18:47:31 - [31merror[39m: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "t"

Error: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "t"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
18:47:31 - [32minfo[39m: undefined
18:48:18 - [32minfo[39m: Using current directory as template folder
18:48:18 - [32minfo[39m: Loading a default sample.txt file.
18:48:18 - [34mdebug[39m: fromDirectory
18:48:18 - [34mdebug[39m: fromDirectory
18:48:18 - [34mdebug[39m: fromDirectory
18:48:18 - [34mdebug[39m: fromDirectory
18:48:18 - [34mdebug[39m: fromDirectory
18:48:18 - [34mdebug[39m: fromDirectory
18:48:18 - [34mdebug[39m: fromDirectory
18:48:18 - [34mdebug[39m: constructor
18:48:18 - [34mdebug[39m: constructor
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processDirectory
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: fromDirectory
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: fromDirectory
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:18 - [34mdebug[39m: isFileInNodeModuleDir
18:48:18 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: fromDirectory
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processDirectory
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: fromDirectory
18:48:19 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:48:19 - [34mdebug[39m: fromDirectory
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: isFileInNodeModuleDir
18:48:19 - [34mdebug[39m: processFile
18:48:19 - [34mdebug[39m: fromDirectory
18:48:19 - [34mdebug[39m: buildGrammar
18:48:19 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":616,"lineBreaks":0,"line":1,"col":617}},null]}
18:48:19 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:48:19 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
18:48:19 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
18:48:19 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
18:48:19 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
18:48:19 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
18:48:19 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
18:48:19 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
18:48:19 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
18:48:19 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
18:48:19 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
18:48:19 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
18:48:19 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
18:48:19 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
18:48:19 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
18:48:19 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":616,"lineBreaks":0,"line":1,"col":617}}
18:48:19 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "512106d6-ef70-4b52-8415-136e32dd6cac",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        unknown : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> String:? {% id %} # unknown 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String:?  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:48:19 - [34mdebug[39m: fromDirectory
18:48:19 - [34mdebug[39m: fromDirectory
18:48:19 - [31merror[39m: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. test if applicable.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "t"

Error: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. test if applicable.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "t"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
18:48:19 - [32minfo[39m: undefined
18:48:25 - [32minfo[39m: Using current directory as template folder
18:48:25 - [32minfo[39m: Loading a default sample.txt file.
18:48:25 - [34mdebug[39m: fromDirectory
18:48:25 - [34mdebug[39m: fromDirectory
18:48:25 - [34mdebug[39m: fromDirectory
18:48:25 - [34mdebug[39m: fromDirectory
18:48:25 - [34mdebug[39m: fromDirectory
18:48:25 - [34mdebug[39m: fromDirectory
18:48:25 - [34mdebug[39m: fromDirectory
18:48:25 - [34mdebug[39m: constructor
18:48:25 - [34mdebug[39m: constructor
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processDirectory
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: fromDirectory
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: fromDirectory
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: fromDirectory
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processDirectory
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: isFileInNodeModuleDir
18:48:25 - [34mdebug[39m: processFile
18:48:25 - [34mdebug[39m: fromDirectory
18:48:26 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:48:26 - [34mdebug[39m: fromDirectory
18:48:26 - [34mdebug[39m: isFileInNodeModuleDir
18:48:26 - [34mdebug[39m: processFile
18:48:26 - [34mdebug[39m: isFileInNodeModuleDir
18:48:26 - [34mdebug[39m: processFile
18:48:26 - [34mdebug[39m: isFileInNodeModuleDir
18:48:26 - [34mdebug[39m: processFile
18:48:26 - [34mdebug[39m: isFileInNodeModuleDir
18:48:26 - [34mdebug[39m: processFile
18:48:26 - [34mdebug[39m: isFileInNodeModuleDir
18:48:26 - [34mdebug[39m: processFile
18:48:26 - [34mdebug[39m: isFileInNodeModuleDir
18:48:26 - [34mdebug[39m: processFile
18:48:26 - [34mdebug[39m: isFileInNodeModuleDir
18:48:26 - [34mdebug[39m: processFile
18:48:26 - [34mdebug[39m: isFileInNodeModuleDir
18:48:26 - [34mdebug[39m: processFile
18:48:26 - [34mdebug[39m: isFileInNodeModuleDir
18:48:26 - [34mdebug[39m: processFile
18:48:26 - [34mdebug[39m: isFileInNodeModuleDir
18:48:26 - [34mdebug[39m: processFile
18:48:26 - [34mdebug[39m: fromDirectory
18:48:26 - [34mdebug[39m: buildGrammar
18:48:26 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":616,"lineBreaks":0,"line":1,"col":617}},{"type":"LastChunk","value":" if applicable.","text":" if applicable.","offset":625,"lineBreaks":0,"line":1,"col":626}]}
18:48:26 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:48:26 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
18:48:26 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
18:48:26 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
18:48:26 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
18:48:26 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
18:48:26 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
18:48:26 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
18:48:26 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
18:48:26 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
18:48:26 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
18:48:26 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
18:48:26 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
18:48:26 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
18:48:26 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
18:48:26 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":616,"lineBreaks":0,"line":1,"col":617}}
18:48:26 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":" if applicable.","text":" if applicable.","offset":625,"lineBreaks":0,"line":1,"col":626}
18:48:26 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "371dfed8-55c4-4f4b-ae92-16b25dc10833",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        unknown : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> String:? {% id %} # unknown 


rule16 -> " if applicable." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String:?  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:48:26 - [34mdebug[39m: fromDirectory
18:48:26 - [34mdebug[39m: fromDirectory
18:48:26 - [31merror[39m: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. test if applicable.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "t"

Error: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. test if applicable.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "t"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
18:48:26 - [32minfo[39m: undefined
18:49:19 - [32minfo[39m: Using current directory as template folder
18:49:19 - [32minfo[39m: Loading a default sample.txt file.
18:49:19 - [34mdebug[39m: fromDirectory
18:49:19 - [34mdebug[39m: fromDirectory
18:49:19 - [34mdebug[39m: fromDirectory
18:49:19 - [34mdebug[39m: fromDirectory
18:49:19 - [34mdebug[39m: fromDirectory
18:49:19 - [34mdebug[39m: fromDirectory
18:49:19 - [34mdebug[39m: fromDirectory
18:49:19 - [34mdebug[39m: constructor
18:49:19 - [34mdebug[39m: constructor
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processDirectory
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: fromDirectory
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: fromDirectory
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: fromDirectory
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processDirectory
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: isFileInNodeModuleDir
18:49:19 - [34mdebug[39m: processFile
18:49:19 - [34mdebug[39m: fromDirectory
18:49:20 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:49:20 - [34mdebug[39m: fromDirectory
18:49:20 - [34mdebug[39m: isFileInNodeModuleDir
18:49:20 - [34mdebug[39m: processFile
18:49:20 - [34mdebug[39m: isFileInNodeModuleDir
18:49:20 - [34mdebug[39m: processFile
18:49:20 - [34mdebug[39m: isFileInNodeModuleDir
18:49:20 - [34mdebug[39m: processFile
18:49:20 - [34mdebug[39m: isFileInNodeModuleDir
18:49:20 - [34mdebug[39m: processFile
18:49:20 - [34mdebug[39m: isFileInNodeModuleDir
18:49:20 - [34mdebug[39m: processFile
18:49:20 - [34mdebug[39m: isFileInNodeModuleDir
18:49:20 - [34mdebug[39m: processFile
18:49:20 - [34mdebug[39m: isFileInNodeModuleDir
18:49:20 - [34mdebug[39m: processFile
18:49:20 - [34mdebug[39m: isFileInNodeModuleDir
18:49:20 - [34mdebug[39m: processFile
18:49:20 - [34mdebug[39m: isFileInNodeModuleDir
18:49:20 - [34mdebug[39m: processFile
18:49:20 - [34mdebug[39m: isFileInNodeModuleDir
18:49:20 - [34mdebug[39m: processFile
18:49:20 - [34mdebug[39m: fromDirectory
18:49:20 - [34mdebug[39m: buildGrammar
18:49:20 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}},{"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}]}
18:49:20 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:49:20 - [34mdebug[39m: element rule1 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}}
18:49:20 - [34mdebug[39m: element rule2 {"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38}
18:49:20 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}}
18:49:20 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120}
18:49:20 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}}
18:49:20 - [34mdebug[39m: element rule6 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184}
18:49:20 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}}
18:49:20 - [34mdebug[39m: element rule8 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236}
18:49:20 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}}
18:49:20 - [34mdebug[39m: element rule10 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350}
18:49:20 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}}
18:49:20 - [34mdebug[39m: element rule12 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396}
18:49:20 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}}
18:49:20 - [34mdebug[39m: element rule14 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469}
18:49:20 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}}
18:49:20 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}
18:49:20 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "9aaf82b4-4253-4bf3-868f-f47e57e96052",
        forceMajeure : rule3,
        penaltyDuration : rule5,
        penaltyPercentage : rule7,
        capPercentage : rule13,
        termination : rule15,
        fractionalPart : rule9,
        unknown : rule1,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty " 


rule1 -> String:? {% id %} # unknown 


rule2 -> ". In case of delayed delivery" 


rule3 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule4 -> " the Seller shall pay to the Buyer for every " 


rule5 -> Duration {% id %} # penaltyDuration 


rule6 -> " of delay penalty amounting to " 


rule7 -> Double {% id %} # penaltyPercentage 


rule8 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> " is to be considered a full " 


rule11 -> TemporalUnit {% id %} # fractionalPart 


rule12 -> ". The total amount of penalty shall not however, exceed " 


rule13 -> Double {% id %} # capPercentage 


rule14 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule15 -> Duration {% id %} # termination 


rule16 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String:?  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:49:20 - [34mdebug[39m: fromDirectory
18:49:20 - [34mdebug[39m: fromDirectory
18:49:20 - [31merror[39m: invalid syntax at line 1 col 27:

  Late Delivery and Penalty test. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "t"

Error: invalid syntax at line 1 col 27:

  Late Delivery and Penalty test. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "t"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
18:49:20 - [32minfo[39m: undefined
18:49:37 - [32minfo[39m: Using current directory as template folder
18:49:37 - [32minfo[39m: Loading a default sample.txt file.
18:49:37 - [34mdebug[39m: fromDirectory
18:49:37 - [34mdebug[39m: fromDirectory
18:49:37 - [34mdebug[39m: fromDirectory
18:49:37 - [34mdebug[39m: fromDirectory
18:49:37 - [34mdebug[39m: fromDirectory
18:49:37 - [34mdebug[39m: fromDirectory
18:49:37 - [34mdebug[39m: fromDirectory
18:49:37 - [34mdebug[39m: constructor
18:49:37 - [34mdebug[39m: constructor
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processDirectory
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: fromDirectory
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: fromDirectory
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:37 - [34mdebug[39m: isFileInNodeModuleDir
18:49:37 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: fromDirectory
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processDirectory
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: fromDirectory
18:49:38 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:49:38 - [34mdebug[39m: fromDirectory
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: isFileInNodeModuleDir
18:49:38 - [34mdebug[39m: processFile
18:49:38 - [34mdebug[39m: fromDirectory
18:49:38 - [34mdebug[39m: buildGrammar
18:49:38 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}},{"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}]}
18:49:38 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:49:38 - [34mdebug[39m: element rule1 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}}
18:49:38 - [34mdebug[39m: element rule2 {"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38}
18:49:38 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}}
18:49:38 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120}
18:49:38 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}}
18:49:38 - [34mdebug[39m: element rule6 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184}
18:49:38 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}}
18:49:38 - [34mdebug[39m: element rule8 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236}
18:49:38 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}}
18:49:38 - [34mdebug[39m: element rule10 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350}
18:49:38 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}}
18:49:38 - [34mdebug[39m: element rule12 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396}
18:49:38 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}}
18:49:38 - [34mdebug[39m: element rule14 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469}
18:49:38 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}}
18:49:38 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}
18:49:38 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "ee696b06-9dda-423c-a285-3e15047376ce",
        forceMajeure : rule3,
        penaltyDuration : rule5,
        penaltyPercentage : rule7,
        capPercentage : rule13,
        termination : rule15,
        fractionalPart : rule9,
        unknown : rule1,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty " 


rule1 -> String:? {% id %} # unknown 


rule2 -> ". In case of delayed delivery" 


rule3 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule4 -> " the Seller shall pay to the Buyer for every " 


rule5 -> Duration {% id %} # penaltyDuration 


rule6 -> " of delay penalty amounting to " 


rule7 -> Double {% id %} # penaltyPercentage 


rule8 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> " is to be considered a full " 


rule11 -> TemporalUnit {% id %} # fractionalPart 


rule12 -> ". The total amount of penalty shall not however, exceed " 


rule13 -> Double {% id %} # capPercentage 


rule14 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule15 -> Duration {% id %} # termination 


rule16 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String:?  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:49:38 - [34mdebug[39m: fromDirectory
18:49:38 - [34mdebug[39m: fromDirectory
18:49:38 - [31merror[39m: invalid syntax at line 1 col 27:

  Late Delivery and Penalty qtest. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "q"

Error: invalid syntax at line 1 col 27:

  Late Delivery and Penalty qtest. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "q"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
18:49:38 - [32minfo[39m: undefined
18:50:00 - [32minfo[39m: Using current directory as template folder
18:50:00 - [32minfo[39m: Loading a default sample.txt file.
18:50:00 - [34mdebug[39m: fromDirectory
18:50:00 - [34mdebug[39m: fromDirectory
18:50:00 - [34mdebug[39m: fromDirectory
18:50:00 - [34mdebug[39m: fromDirectory
18:50:00 - [34mdebug[39m: fromDirectory
18:50:00 - [34mdebug[39m: fromDirectory
18:50:00 - [34mdebug[39m: fromDirectory
18:50:00 - [34mdebug[39m: constructor
18:50:00 - [34mdebug[39m: constructor
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processDirectory
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: fromDirectory
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: fromDirectory
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:00 - [34mdebug[39m: isFileInNodeModuleDir
18:50:00 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: fromDirectory
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processDirectory
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: fromDirectory
18:50:01 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:50:01 - [34mdebug[39m: fromDirectory
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: isFileInNodeModuleDir
18:50:01 - [34mdebug[39m: processFile
18:50:01 - [34mdebug[39m: fromDirectory
18:50:01 - [34mdebug[39m: buildGrammar
18:50:01 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}},{"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}]}
18:50:01 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:50:01 - [34mdebug[39m: element rule1 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}}
18:50:01 - [34mdebug[39m: element rule2 {"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38}
18:50:01 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}}
18:50:01 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120}
18:50:01 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}}
18:50:01 - [34mdebug[39m: element rule6 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184}
18:50:01 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}}
18:50:01 - [34mdebug[39m: element rule8 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236}
18:50:01 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}}
18:50:01 - [34mdebug[39m: element rule10 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350}
18:50:01 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}}
18:50:01 - [34mdebug[39m: element rule12 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396}
18:50:01 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}}
18:50:01 - [34mdebug[39m: element rule14 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469}
18:50:01 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}}
18:50:01 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}
18:50:01 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "c59774a3-92de-478c-b551-3a57b084301b",
        forceMajeure : rule3,
        penaltyDuration : rule5,
        penaltyPercentage : rule7,
        capPercentage : rule13,
        termination : rule15,
        fractionalPart : rule9,
        unknown : rule1,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty " 


rule1 -> String {% id %} # unknown 


rule2 -> ". In case of delayed delivery" 


rule3 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule4 -> " the Seller shall pay to the Buyer for every " 


rule5 -> Duration {% id %} # penaltyDuration 


rule6 -> " of delay penalty amounting to " 


rule7 -> Double {% id %} # penaltyPercentage 


rule8 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> " is to be considered a full " 


rule11 -> TemporalUnit {% id %} # fractionalPart 


rule12 -> ". The total amount of penalty shall not however, exceed " 


rule13 -> Double {% id %} # capPercentage 


rule14 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule15 -> Duration {% id %} # termination 


rule16 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:50:01 - [34mdebug[39m: fromDirectory
18:50:01 - [34mdebug[39m: fromDirectory
18:50:01 - [31merror[39m: invalid syntax at line 1 col 27:

  Late Delivery and Penalty qtest. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "q"

Error: invalid syntax at line 1 col 27:

  Late Delivery and Penalty qtest. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "q"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
18:50:01 - [32minfo[39m: undefined
18:50:24 - [32minfo[39m: Using current directory as template folder
18:50:25 - [32minfo[39m: Loading a default sample.txt file.
18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: constructor
18:50:25 - [34mdebug[39m: constructor
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processDirectory
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processDirectory
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: isFileInNodeModuleDir
18:50:25 - [34mdebug[39m: processFile
18:50:25 - [34mdebug[39m: fromDirectory
18:50:25 - [34mdebug[39m: buildGrammar
18:50:25 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}},{"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}]}
18:50:25 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:50:25 - [34mdebug[39m: element rule1 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}}
18:50:25 - [34mdebug[39m: element rule2 {"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38}
18:50:25 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}}
18:50:25 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120}
18:50:25 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}}
18:50:25 - [34mdebug[39m: element rule6 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184}
18:50:26 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}}
18:50:26 - [34mdebug[39m: element rule8 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236}
18:50:26 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}}
18:50:26 - [34mdebug[39m: element rule10 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350}
18:50:26 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}}
18:50:26 - [34mdebug[39m: element rule12 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396}
18:50:26 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}}
18:50:26 - [34mdebug[39m: element rule14 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469}
18:50:26 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}}
18:50:26 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}
18:50:26 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "0834ada3-d0f4-454b-817e-d290f07a23c3",
        forceMajeure : rule3,
        penaltyDuration : rule5,
        penaltyPercentage : rule7,
        capPercentage : rule13,
        termination : rule15,
        fractionalPart : rule9,
        unknown : rule1,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty " 


rule1 -> Double {% id %} # unknown 


rule2 -> ". In case of delayed delivery" 


rule3 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule4 -> " the Seller shall pay to the Buyer for every " 


rule5 -> Duration {% id %} # penaltyDuration 


rule6 -> " of delay penalty amounting to " 


rule7 -> Double {% id %} # penaltyPercentage 


rule8 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> " is to be considered a full " 


rule11 -> TemporalUnit {% id %} # fractionalPart 


rule12 -> ". The total amount of penalty shall not however, exceed " 


rule13 -> Double {% id %} # capPercentage 


rule14 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule15 -> Duration {% id %} # termination 


rule16 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Double  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:50:26 - [34mdebug[39m: fromDirectory
18:50:26 - [34mdebug[39m: fromDirectory
18:50:26 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"0834ada3-d0f4-454b-817e-d290f07a23c3","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","unknown":10}
18:50:26 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"0834ada3-d0f4-454b-817e-d290f07a23c3","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":2,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","unknown":10}
18:50:26 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m0834ada3-d0f4-454b-817e-d290f07a23c3[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyDuration[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m2[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m[33m,[39m
  [33m"[39m[32munknown[39m[33m"[39m[33m: [39m[36m10[39m
[33m}[39m
18:53:50 - [32minfo[39m: Using current directory as template folder
18:53:50 - [32minfo[39m: Loading a default sample.txt file.
18:53:50 - [34mdebug[39m: fromDirectory
18:53:50 - [34mdebug[39m: fromDirectory
18:53:50 - [34mdebug[39m: fromDirectory
18:53:50 - [34mdebug[39m: fromDirectory
18:53:50 - [34mdebug[39m: fromDirectory
18:53:50 - [34mdebug[39m: fromDirectory
18:53:50 - [34mdebug[39m: fromDirectory
18:53:50 - [34mdebug[39m: constructor
18:53:50 - [34mdebug[39m: constructor
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processDirectory
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: fromDirectory
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: fromDirectory
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: fromDirectory
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processDirectory
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: isFileInNodeModuleDir
18:53:50 - [34mdebug[39m: processFile
18:53:50 - [34mdebug[39m: fromDirectory
18:53:51 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:53:51 - [34mdebug[39m: fromDirectory
18:53:51 - [34mdebug[39m: isFileInNodeModuleDir
18:53:51 - [34mdebug[39m: processFile
18:53:51 - [34mdebug[39m: isFileInNodeModuleDir
18:53:51 - [34mdebug[39m: processFile
18:53:51 - [34mdebug[39m: isFileInNodeModuleDir
18:53:51 - [34mdebug[39m: processFile
18:53:51 - [34mdebug[39m: isFileInNodeModuleDir
18:53:51 - [34mdebug[39m: processFile
18:53:51 - [34mdebug[39m: isFileInNodeModuleDir
18:53:51 - [34mdebug[39m: processFile
18:53:51 - [34mdebug[39m: isFileInNodeModuleDir
18:53:51 - [34mdebug[39m: processFile
18:53:51 - [34mdebug[39m: isFileInNodeModuleDir
18:53:51 - [34mdebug[39m: processFile
18:53:51 - [34mdebug[39m: isFileInNodeModuleDir
18:53:51 - [34mdebug[39m: processFile
18:53:51 - [34mdebug[39m: isFileInNodeModuleDir
18:53:51 - [34mdebug[39m: processFile
18:53:51 - [34mdebug[39m: isFileInNodeModuleDir
18:53:51 - [34mdebug[39m: processFile
18:53:51 - [34mdebug[39m: fromDirectory
18:53:51 - [34mdebug[39m: buildGrammar
18:53:51 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}},{"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}]}
18:53:51 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:53:51 - [34mdebug[39m: element rule1 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}}
18:53:51 - [34mdebug[39m: element rule2 {"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38}
18:53:51 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}}
18:53:51 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120}
18:53:51 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}}
18:53:51 - [34mdebug[39m: element rule6 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184}
18:53:51 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}}
18:53:51 - [34mdebug[39m: element rule8 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236}
18:53:51 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}}
18:53:51 - [34mdebug[39m: element rule10 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350}
18:53:51 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}}
18:53:51 - [34mdebug[39m: element rule12 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396}
18:53:51 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}}
18:53:51 - [34mdebug[39m: element rule14 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469}
18:53:51 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}}
18:53:51 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}
18:53:51 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "80076983-e729-4f48-95f8-924d4aae0fd1",
        forceMajeure : rule3,
        penaltyDuration : rule5,
        penaltyPercentage : rule7,
        capPercentage : rule13,
        termination : rule15,
        fractionalPart : rule9,
        unknown : rule1,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty " 


rule1 -> TemporalUnit {% id %} # unknown 


rule2 -> ". In case of delayed delivery" 


rule3 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule4 -> " the Seller shall pay to the Buyer for every " 


rule5 -> Duration {% id %} # penaltyDuration 


rule6 -> " of delay penalty amounting to " 


rule7 -> Double {% id %} # penaltyPercentage 


rule8 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> " is to be considered a full " 


rule11 -> TemporalUnit {% id %} # fractionalPart 


rule12 -> ". The total amount of penalty shall not however, exceed " 


rule13 -> Double {% id %} # capPercentage 


rule14 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule15 -> Duration {% id %} # termination 


rule16 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:53:51 - [34mdebug[39m: fromDirectory
18:53:51 - [34mdebug[39m: fromDirectory
18:53:51 - [31merror[39m: invalid syntax at line 1 col 27:

  Late Delivery and Penalty 10 weeks. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "1"

Error: invalid syntax at line 1 col 27:

  Late Delivery and Penalty 10 weeks. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "1"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
18:53:51 - [32minfo[39m: undefined
18:54:28 - [32minfo[39m: Using current directory as template folder
18:54:28 - [32minfo[39m: Loading a default sample.txt file.
18:54:28 - [34mdebug[39m: fromDirectory
18:54:28 - [34mdebug[39m: fromDirectory
18:54:28 - [34mdebug[39m: fromDirectory
18:54:28 - [34mdebug[39m: fromDirectory
18:54:28 - [34mdebug[39m: fromDirectory
18:54:28 - [34mdebug[39m: fromDirectory
18:54:28 - [34mdebug[39m: fromDirectory
18:54:28 - [34mdebug[39m: constructor
18:54:28 - [34mdebug[39m: constructor
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processDirectory
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: fromDirectory
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: fromDirectory
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:28 - [34mdebug[39m: isFileInNodeModuleDir
18:54:28 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: fromDirectory
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processDirectory
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: fromDirectory
18:54:29 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



18:54:29 - [34mdebug[39m: fromDirectory
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: isFileInNodeModuleDir
18:54:29 - [34mdebug[39m: processFile
18:54:29 - [34mdebug[39m: fromDirectory
18:54:29 - [34mdebug[39m: buildGrammar
18:54:29 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}},{"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}]}
18:54:29 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1}
18:54:29 - [34mdebug[39m: element rule1 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}}
18:54:29 - [34mdebug[39m: element rule2 {"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38}
18:54:29 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}}
18:54:29 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120}
18:54:29 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}}
18:54:29 - [34mdebug[39m: element rule6 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184}
18:54:30 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}}
18:54:30 - [34mdebug[39m: element rule8 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236}
18:54:30 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}}
18:54:30 - [34mdebug[39m: element rule10 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350}
18:54:30 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}}
18:54:30 - [34mdebug[39m: element rule12 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396}
18:54:30 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}}
18:54:30 - [34mdebug[39m: element rule14 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469}
18:54:30 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}}
18:54:30 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}
18:54:30 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "0264cb1f-d417-4d46-b873-e4d2586d16f1",
        forceMajeure : rule3,
        penaltyDuration : rule5,
        penaltyPercentage : rule7,
        capPercentage : rule13,
        termination : rule15,
        fractionalPart : rule9,
        unknown : rule1,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty " 


rule1 -> TemporalUnit {% id %} # unknown 


rule2 -> ". In case of delayed delivery" 


rule3 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule4 -> " the Seller shall pay to the Buyer for every " 


rule5 -> Duration {% id %} # penaltyDuration 


rule6 -> " of delay penalty amounting to " 


rule7 -> Double {% id %} # penaltyPercentage 


rule8 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> " is to be considered a full " 


rule11 -> TemporalUnit {% id %} # fractionalPart 


rule12 -> ". The total amount of penalty shall not however, exceed " 


rule13 -> Double {% id %} # capPercentage 


rule14 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule15 -> Duration {% id %} # termination 


rule16 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
18:54:30 - [34mdebug[39m: fromDirectory
18:54:30 - [34mdebug[39m: fromDirectory
18:54:30 - [31merror[39m: invalid syntax at line 1 col 27:

  Late Delivery and Penalty 2 days. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "2"

Error: invalid syntax at line 1 col 27:

  Late Delivery and Penalty 2 days. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "2"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
18:54:30 - [32minfo[39m: undefined
19:00:50 - [32minfo[39m: Using current directory as template folder
19:00:50 - [32minfo[39m: Loading a default sample.txt file.
19:00:50 - [34mdebug[39m: fromDirectory
19:00:50 - [34mdebug[39m: fromDirectory
19:00:50 - [34mdebug[39m: fromDirectory
19:00:50 - [34mdebug[39m: fromDirectory
19:00:50 - [34mdebug[39m: fromDirectory
19:00:50 - [34mdebug[39m: fromDirectory
19:00:50 - [34mdebug[39m: fromDirectory
19:00:50 - [34mdebug[39m: constructor
19:00:50 - [34mdebug[39m: constructor
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processDirectory
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: fromDirectory
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: fromDirectory
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:50 - [34mdebug[39m: isFileInNodeModuleDir
19:00:50 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: fromDirectory
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processDirectory
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: fromDirectory
19:00:51 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:00:51 - [34mdebug[39m: fromDirectory
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: isFileInNodeModuleDir
19:00:51 - [34mdebug[39m: processFile
19:00:51 - [34mdebug[39m: fromDirectory
19:00:51 - [34mdebug[39m: buildGrammar
19:00:51 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}},{"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}]}
19:00:51 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:00:51 - [34mdebug[39m: element rule1 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}}
19:00:51 - [34mdebug[39m: element rule2 {"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38}
19:00:51 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}}
19:00:51 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120}
19:00:51 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}}
19:00:51 - [34mdebug[39m: element rule6 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184}
19:00:51 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}}
19:00:51 - [34mdebug[39m: element rule8 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236}
19:00:51 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}}
19:00:51 - [34mdebug[39m: element rule10 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350}
19:00:51 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}}
19:00:51 - [34mdebug[39m: element rule12 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396}
19:00:51 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}}
19:00:51 - [34mdebug[39m: element rule14 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469}
19:00:51 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}}
19:00:51 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}
19:00:51 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "e6636864-a7b3-43cc-bc99-d6fc817ef0a8",
        forceMajeure : rule3,
        penaltyDuration : rule5,
        penaltyPercentage : rule7,
        capPercentage : rule13,
        termination : rule15,
        fractionalPart : rule9,
        unknown : rule1,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty " 


rule1 -> TemporalUnit {% id %} # unknown 


rule2 -> ". In case of delayed delivery" 


rule3 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule4 -> " the Seller shall pay to the Buyer for every " 


rule5 -> Duration {% id %} # penaltyDuration 


rule6 -> " of delay penalty amounting to " 


rule7 -> Double {% id %} # penaltyPercentage 


rule8 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> " is to be considered a full " 


rule11 -> TemporalUnit {% id %} # fractionalPart 


rule12 -> ". The total amount of penalty shall not however, exceed " 


rule13 -> Double {% id %} # capPercentage 


rule14 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule15 -> Duration {% id %} # termination 


rule16 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:00:51 - [34mdebug[39m: fromDirectory
19:00:51 - [34mdebug[39m: fromDirectory
19:00:51 - [31merror[39m: invalid syntax at line 1 col 27:

  Late Delivery and Penalty 2 days. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "2"

Error: invalid syntax at line 1 col 27:

  Late Delivery and Penalty 2 days. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 2 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "2"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
19:00:51 - [32minfo[39m: undefined
19:01:08 - [32minfo[39m: Using current directory as template folder
19:01:08 - [32minfo[39m: Loading a default sample.txt file.
19:01:08 - [34mdebug[39m: fromDirectory
19:01:08 - [34mdebug[39m: fromDirectory
19:01:08 - [34mdebug[39m: fromDirectory
19:01:08 - [34mdebug[39m: fromDirectory
19:01:08 - [34mdebug[39m: fromDirectory
19:01:08 - [34mdebug[39m: fromDirectory
19:01:08 - [34mdebug[39m: fromDirectory
19:01:08 - [34mdebug[39m: constructor
19:01:08 - [34mdebug[39m: constructor
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processDirectory
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: fromDirectory
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: fromDirectory
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:08 - [34mdebug[39m: isFileInNodeModuleDir
19:01:08 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: fromDirectory
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processDirectory
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: fromDirectory
19:01:09 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:01:09 - [34mdebug[39m: fromDirectory
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: isFileInNodeModuleDir
19:01:09 - [34mdebug[39m: processFile
19:01:09 - [34mdebug[39m: fromDirectory
19:01:09 - [34mdebug[39m: buildGrammar
19:01:09 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}},{"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}]}
19:01:09 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:01:09 - [34mdebug[39m: element rule1 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}}
19:01:09 - [34mdebug[39m: element rule2 {"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38}
19:01:09 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}}
19:01:09 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120}
19:01:09 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}}
19:01:09 - [34mdebug[39m: element rule6 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184}
19:01:09 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}}
19:01:09 - [34mdebug[39m: element rule8 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236}
19:01:09 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}}
19:01:09 - [34mdebug[39m: element rule10 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350}
19:01:09 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}}
19:01:09 - [34mdebug[39m: element rule12 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396}
19:01:09 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}}
19:01:09 - [34mdebug[39m: element rule14 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469}
19:01:09 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}}
19:01:09 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}
19:01:09 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "2b49ef86-c7b4-437f-8034-1d3c83815b9f",
        forceMajeure : rule3,
        penaltyDuration : rule5,
        penaltyPercentage : rule7,
        capPercentage : rule13,
        termination : rule15,
        fractionalPart : rule9,
        unknown : rule1,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty " 


rule1 -> TemporalUnit {% id %} # unknown 


rule2 -> ". In case of delayed delivery" 


rule3 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule4 -> " the Seller shall pay to the Buyer for every " 


rule5 -> Duration {% id %} # penaltyDuration 


rule6 -> " of delay penalty amounting to " 


rule7 -> Double {% id %} # penaltyPercentage 


rule8 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> " is to be considered a full " 


rule11 -> TemporalUnit {% id %} # fractionalPart 


rule12 -> ". The total amount of penalty shall not however, exceed " 


rule13 -> Double {% id %} # capPercentage 


rule14 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule15 -> Duration {% id %} # termination 


rule16 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:01:09 - [34mdebug[39m: fromDirectory
19:01:09 - [34mdebug[39m: fromDirectory
19:01:09 - [31merror[39m: invalid syntax at line 1 col 26:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                           ^
Unexpected "."

Error: invalid syntax at line 1 col 26:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                           ^
Unexpected "."

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
19:01:09 - [32minfo[39m: undefined
19:01:21 - [32minfo[39m: Using current directory as template folder
19:01:21 - [32minfo[39m: Loading a default sample.txt file.
19:01:21 - [34mdebug[39m: fromDirectory
19:01:21 - [34mdebug[39m: fromDirectory
19:01:21 - [34mdebug[39m: fromDirectory
19:01:21 - [34mdebug[39m: fromDirectory
19:01:21 - [34mdebug[39m: fromDirectory
19:01:21 - [34mdebug[39m: fromDirectory
19:01:21 - [34mdebug[39m: fromDirectory
19:01:21 - [34mdebug[39m: constructor
19:01:21 - [34mdebug[39m: constructor
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processDirectory
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: fromDirectory
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: fromDirectory
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: fromDirectory
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processDirectory
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: isFileInNodeModuleDir
19:01:21 - [34mdebug[39m: processFile
19:01:21 - [34mdebug[39m: fromDirectory
19:01:22 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:01:22 - [34mdebug[39m: fromDirectory
19:01:22 - [34mdebug[39m: isFileInNodeModuleDir
19:01:22 - [34mdebug[39m: processFile
19:01:22 - [34mdebug[39m: isFileInNodeModuleDir
19:01:22 - [34mdebug[39m: processFile
19:01:22 - [34mdebug[39m: isFileInNodeModuleDir
19:01:22 - [34mdebug[39m: processFile
19:01:22 - [34mdebug[39m: isFileInNodeModuleDir
19:01:22 - [34mdebug[39m: processFile
19:01:22 - [34mdebug[39m: isFileInNodeModuleDir
19:01:22 - [34mdebug[39m: processFile
19:01:22 - [34mdebug[39m: isFileInNodeModuleDir
19:01:22 - [34mdebug[39m: processFile
19:01:22 - [34mdebug[39m: isFileInNodeModuleDir
19:01:22 - [34mdebug[39m: processFile
19:01:22 - [34mdebug[39m: isFileInNodeModuleDir
19:01:22 - [34mdebug[39m: processFile
19:01:22 - [34mdebug[39m: isFileInNodeModuleDir
19:01:22 - [34mdebug[39m: processFile
19:01:22 - [34mdebug[39m: isFileInNodeModuleDir
19:01:22 - [34mdebug[39m: processFile
19:01:22 - [34mdebug[39m: fromDirectory
19:01:22 - [34mdebug[39m: buildGrammar
19:01:22 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}},{"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}]}
19:01:22 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:01:22 - [34mdebug[39m: element rule1 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}}
19:01:22 - [34mdebug[39m: element rule2 {"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38}
19:01:22 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}}
19:01:22 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120}
19:01:22 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}}
19:01:22 - [34mdebug[39m: element rule6 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184}
19:01:22 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}}
19:01:22 - [34mdebug[39m: element rule8 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236}
19:01:22 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}}
19:01:22 - [34mdebug[39m: element rule10 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350}
19:01:22 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}}
19:01:22 - [34mdebug[39m: element rule12 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396}
19:01:22 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}}
19:01:22 - [34mdebug[39m: element rule14 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469}
19:01:22 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}}
19:01:22 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}
19:01:22 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "2d906eca-6698-4b31-975e-ec0175d30a1f",
        forceMajeure : rule3,
        penaltyDuration : rule5,
        penaltyPercentage : rule7,
        capPercentage : rule13,
        termination : rule15,
        fractionalPart : rule9,
        unknown : rule1,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty " 


rule1 -> TemporalUnit {% id %} # unknown 


rule2 -> ". In case of delayed delivery" 


rule3 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule4 -> " the Seller shall pay to the Buyer for every " 


rule5 -> Duration {% id %} # penaltyDuration 


rule6 -> " of delay penalty amounting to " 


rule7 -> Double {% id %} # penaltyPercentage 


rule8 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> " is to be considered a full " 


rule11 -> TemporalUnit {% id %} # fractionalPart 


rule12 -> ". The total amount of penalty shall not however, exceed " 


rule13 -> Double {% id %} # capPercentage 


rule14 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule15 -> Duration {% id %} # termination 


rule16 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:01:22 - [34mdebug[39m: fromDirectory
19:01:22 - [34mdebug[39m: fromDirectory
19:01:22 - [31merror[39m: invalid syntax at line 1 col 27:

  Late Delivery and Penalty 5. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "5"

Error: invalid syntax at line 1 col 27:

  Late Delivery and Penalty 5. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "5"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
19:01:22 - [32minfo[39m: undefined
19:01:33 - [32minfo[39m: Using current directory as template folder
19:01:33 - [32minfo[39m: Loading a default sample.txt file.
19:01:33 - [34mdebug[39m: fromDirectory
19:01:33 - [34mdebug[39m: fromDirectory
19:01:33 - [34mdebug[39m: fromDirectory
19:01:33 - [34mdebug[39m: fromDirectory
19:01:33 - [34mdebug[39m: fromDirectory
19:01:33 - [34mdebug[39m: fromDirectory
19:01:33 - [34mdebug[39m: fromDirectory
19:01:33 - [34mdebug[39m: constructor
19:01:33 - [34mdebug[39m: constructor
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processDirectory
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: fromDirectory
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: fromDirectory
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:33 - [34mdebug[39m: isFileInNodeModuleDir
19:01:33 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: fromDirectory
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processDirectory
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: fromDirectory
19:01:34 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:01:34 - [34mdebug[39m: fromDirectory
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: isFileInNodeModuleDir
19:01:34 - [34mdebug[39m: processFile
19:01:34 - [34mdebug[39m: fromDirectory
19:01:34 - [34mdebug[39m: buildGrammar
19:01:34 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}},{"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}]}
19:01:34 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:01:34 - [34mdebug[39m: element rule1 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}}
19:01:34 - [34mdebug[39m: element rule2 {"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38}
19:01:34 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}}
19:01:34 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120}
19:01:34 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}}
19:01:34 - [34mdebug[39m: element rule6 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184}
19:01:34 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}}
19:01:34 - [34mdebug[39m: element rule8 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236}
19:01:34 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}}
19:01:34 - [34mdebug[39m: element rule10 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350}
19:01:34 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}}
19:01:34 - [34mdebug[39m: element rule12 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396}
19:01:34 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}}
19:01:34 - [34mdebug[39m: element rule14 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469}
19:01:34 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}}
19:01:34 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}
19:01:34 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "da4c21ed-90c5-43b7-8b07-8fcf084bd833",
        forceMajeure : rule3,
        penaltyDuration : rule5,
        penaltyPercentage : rule7,
        capPercentage : rule13,
        termination : rule15,
        fractionalPart : rule9,
        unknown : rule1,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty " 


rule1 -> TemporalUnit {% id %} # unknown 


rule2 -> ". In case of delayed delivery" 


rule3 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule4 -> " the Seller shall pay to the Buyer for every " 


rule5 -> Duration {% id %} # penaltyDuration 


rule6 -> " of delay penalty amounting to " 


rule7 -> Double {% id %} # penaltyPercentage 


rule8 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> " is to be considered a full " 


rule11 -> TemporalUnit {% id %} # fractionalPart 


rule12 -> ". The total amount of penalty shall not however, exceed " 


rule13 -> Double {% id %} # capPercentage 


rule14 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule15 -> Duration {% id %} # termination 


rule16 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:01:34 - [34mdebug[39m: fromDirectory
19:01:34 - [34mdebug[39m: fromDirectory
19:01:34 - [31merror[39m: invalid syntax at line 1 col 27:

  Late Delivery and Penalty 2. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "2"

Error: invalid syntax at line 1 col 27:

  Late Delivery and Penalty 2. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "2"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
19:01:34 - [32minfo[39m: undefined
19:01:46 - [32minfo[39m: Using current directory as template folder
19:01:46 - [32minfo[39m: Loading a default sample.txt file.
19:01:46 - [34mdebug[39m: fromDirectory
19:01:46 - [34mdebug[39m: fromDirectory
19:01:46 - [34mdebug[39m: fromDirectory
19:01:46 - [34mdebug[39m: fromDirectory
19:01:46 - [34mdebug[39m: fromDirectory
19:01:46 - [34mdebug[39m: fromDirectory
19:01:46 - [34mdebug[39m: fromDirectory
19:01:46 - [34mdebug[39m: constructor
19:01:46 - [34mdebug[39m: constructor
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processDirectory
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: fromDirectory
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: fromDirectory
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: fromDirectory
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processDirectory
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: isFileInNodeModuleDir
19:01:46 - [34mdebug[39m: processFile
19:01:46 - [34mdebug[39m: fromDirectory
19:01:46 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:01:47 - [34mdebug[39m: fromDirectory
19:01:47 - [34mdebug[39m: isFileInNodeModuleDir
19:01:47 - [34mdebug[39m: processFile
19:01:47 - [34mdebug[39m: isFileInNodeModuleDir
19:01:47 - [34mdebug[39m: processFile
19:01:47 - [34mdebug[39m: isFileInNodeModuleDir
19:01:47 - [34mdebug[39m: processFile
19:01:47 - [34mdebug[39m: isFileInNodeModuleDir
19:01:47 - [34mdebug[39m: processFile
19:01:47 - [34mdebug[39m: isFileInNodeModuleDir
19:01:47 - [34mdebug[39m: processFile
19:01:47 - [34mdebug[39m: isFileInNodeModuleDir
19:01:47 - [34mdebug[39m: processFile
19:01:47 - [34mdebug[39m: isFileInNodeModuleDir
19:01:47 - [34mdebug[39m: processFile
19:01:47 - [34mdebug[39m: isFileInNodeModuleDir
19:01:47 - [34mdebug[39m: processFile
19:01:47 - [34mdebug[39m: isFileInNodeModuleDir
19:01:47 - [34mdebug[39m: processFile
19:01:47 - [34mdebug[39m: isFileInNodeModuleDir
19:01:47 - [34mdebug[39m: processFile
19:01:47 - [34mdebug[39m: fromDirectory
19:01:47 - [34mdebug[39m: buildGrammar
19:01:47 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}},{"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}]}
19:01:47 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty ","text":"Late Delivery and Penalty [{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:01:47 - [34mdebug[39m: element rule1 {"type":"Binding","fieldName":{"type":"varid","value":"unknown","text":"unknown","offset":28,"lineBreaks":0,"line":1,"col":29}}
19:01:47 - [34mdebug[39m: element rule2 {"type":"Chunk","value":". In case of delayed delivery","text":". In case of delayed delivery[{","offset":37,"lineBreaks":0,"line":1,"col":38}
19:01:47 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":68,"lineBreaks":0,"line":1,"col":69},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":105,"lineBreaks":0,"line":1,"col":106}}
19:01:47 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":119,"lineBreaks":0,"line":1,"col":120}
19:01:47 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":166,"lineBreaks":0,"line":1,"col":167}}
19:01:47 - [34mdebug[39m: element rule6 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":183,"lineBreaks":0,"line":1,"col":184}
19:01:47 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":216,"lineBreaks":0,"line":1,"col":217}}
19:01:47 - [34mdebug[39m: element rule8 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":235,"lineBreaks":0,"line":1,"col":236}
19:01:47 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":333,"lineBreaks":0,"line":1,"col":334}}
19:01:47 - [34mdebug[39m: element rule10 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":349,"lineBreaks":0,"line":1,"col":350}
19:01:47 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":379,"lineBreaks":0,"line":1,"col":380}}
19:01:47 - [34mdebug[39m: element rule12 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":395,"lineBreaks":0,"line":1,"col":396}
19:01:47 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":453,"lineBreaks":0,"line":1,"col":454}}
19:01:47 - [34mdebug[39m: element rule14 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":468,"lineBreaks":0,"line":1,"col":469}
19:01:47 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":561,"lineBreaks":0,"line":1,"col":562}}
19:01:47 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":574,"lineBreaks":0,"line":1,"col":575}
19:01:47 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "e2decfb6-7f5f-4047-8649-e10a9ff39969",
        forceMajeure : rule3,
        penaltyDuration : rule5,
        penaltyPercentage : rule7,
        capPercentage : rule13,
        termination : rule15,
        fractionalPart : rule9,
        unknown : rule1,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty " 


rule1 -> TemporalUnit {% id %} # unknown 


rule2 -> ". In case of delayed delivery" 


rule3 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule4 -> " the Seller shall pay to the Buyer for every " 


rule5 -> Duration {% id %} # penaltyDuration 


rule6 -> " of delay penalty amounting to " 


rule7 -> Double {% id %} # penaltyPercentage 


rule8 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> " is to be considered a full " 


rule11 -> TemporalUnit {% id %} # fractionalPart 


rule12 -> ". The total amount of penalty shall not however, exceed " 


rule13 -> Double {% id %} # capPercentage 


rule14 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule15 -> Duration {% id %} # termination 


rule16 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:01:47 - [34mdebug[39m: fromDirectory
19:01:47 - [34mdebug[39m: fromDirectory
19:01:47 - [31merror[39m: invalid syntax at line 1 col 27:

  Late Delivery and Penalty . In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "."

Error: invalid syntax at line 1 col 27:

  Late Delivery and Penalty . In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract.
                            ^
Unexpected "."

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
19:01:47 - [32minfo[39m: undefined
19:02:07 - [32minfo[39m: Using current directory as template folder
19:02:07 - [32minfo[39m: Loading a default sample.txt file.
19:02:07 - [34mdebug[39m: fromDirectory
19:02:07 - [34mdebug[39m: fromDirectory
19:02:07 - [34mdebug[39m: fromDirectory
19:02:07 - [34mdebug[39m: fromDirectory
19:02:07 - [34mdebug[39m: fromDirectory
19:02:07 - [34mdebug[39m: fromDirectory
19:02:07 - [34mdebug[39m: fromDirectory
19:02:07 - [34mdebug[39m: constructor
19:02:07 - [34mdebug[39m: constructor
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processDirectory
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: fromDirectory
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: fromDirectory
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:07 - [34mdebug[39m: isFileInNodeModuleDir
19:02:07 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: fromDirectory
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processDirectory
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: fromDirectory
19:02:08 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:02:08 - [34mdebug[39m: fromDirectory
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: isFileInNodeModuleDir
19:02:08 - [34mdebug[39m: processFile
19:02:08 - [34mdebug[39m: fromDirectory
19:02:08 - [34mdebug[39m: buildGrammar
19:02:08 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
19:02:08 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:02:08 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:02:08 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:02:08 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:02:08 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:02:08 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:02:08 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:02:08 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:02:08 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:02:08 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:02:08 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:02:08 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:02:08 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:02:08 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:02:08 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
19:02:08 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "d14186eb-fb65-4395-bd6d-47f37c05cd4d",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:02:08 - [34mdebug[39m: fromDirectory
19:02:08 - [34mdebug[39m: fromDirectory
19:02:08 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"d14186eb-fb65-4395-bd6d-47f37c05cd4d","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
19:02:08 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"d14186eb-fb65-4395-bd6d-47f37c05cd4d","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
19:02:08 - [31merror[39m: Instance org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause#d14186eb-fb65-4395-bd6d-47f37c05cd4d missing required field unknown
ValidationException: Instance org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause#d14186eb-fb65-4395-bd6d-47f37c05cd4d missing required field unknown
    at Function.reportMissingRequiredProperty (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer/resourcevalidator.js:480:15)
    at ResourceValidator.visitClassDeclaration (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer/resourcevalidator.js:178:39)
    at ResourceValidator.visit (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer/resourcevalidator.js:74:25)
    at AssetDeclaration.accept (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/decorated.js:54:24)
    at ValidatedResource.validate (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/model/validatedresource.js:124:26)
    at Serializer.fromJSON (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer.js:193:22)
    at Clause.setData (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:62:61)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:113:14)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
19:02:08 - [32minfo[39m: undefined
19:02:16 - [32minfo[39m: Using current directory as template folder
19:02:16 - [32minfo[39m: Loading a default sample.txt file.
19:02:16 - [34mdebug[39m: fromDirectory
19:02:16 - [34mdebug[39m: fromDirectory
19:02:16 - [34mdebug[39m: fromDirectory
19:02:16 - [34mdebug[39m: fromDirectory
19:02:16 - [34mdebug[39m: fromDirectory
19:02:16 - [34mdebug[39m: fromDirectory
19:02:16 - [34mdebug[39m: fromDirectory
19:02:16 - [34mdebug[39m: constructor
19:02:16 - [34mdebug[39m: constructor
19:02:16 - [34mdebug[39m: isFileInNodeModuleDir
19:02:16 - [34mdebug[39m: isFileInNodeModuleDir
19:02:16 - [34mdebug[39m: isFileInNodeModuleDir
19:02:16 - [34mdebug[39m: isFileInNodeModuleDir
19:02:16 - [34mdebug[39m: isFileInNodeModuleDir
19:02:16 - [34mdebug[39m: processDirectory
19:02:16 - [34mdebug[39m: isFileInNodeModuleDir
19:02:16 - [34mdebug[39m: processFile
19:02:16 - [34mdebug[39m: isFileInNodeModuleDir
19:02:16 - [34mdebug[39m: processFile
19:02:16 - [34mdebug[39m: isFileInNodeModuleDir
19:02:16 - [34mdebug[39m: processFile
19:02:16 - [34mdebug[39m: isFileInNodeModuleDir
19:02:16 - [34mdebug[39m: processFile
19:02:16 - [34mdebug[39m: isFileInNodeModuleDir
19:02:16 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: fromDirectory
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: fromDirectory
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: fromDirectory
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processDirectory
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: fromDirectory
19:02:17 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:02:17 - [34mdebug[39m: fromDirectory
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: isFileInNodeModuleDir
19:02:17 - [34mdebug[39m: processFile
19:02:17 - [34mdebug[39m: fromDirectory
19:02:17 - [34mdebug[39m: buildGrammar
19:02:17 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}]}
19:02:17 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:02:17 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:02:17 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:02:17 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:02:17 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:02:17 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:02:17 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:02:18 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:02:18 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:02:18 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:02:18 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:02:18 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:02:18 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:02:18 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:02:18 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":562,"lineBreaks":0,"line":1,"col":563}
19:02:18 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "47a90736-0787-4066-9a70-ac6bc59d7bec",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  TemporalUnit:?  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        unknown : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:02:18 - [34mdebug[39m: fromDirectory
19:02:18 - [34mdebug[39m: fromDirectory
19:02:18 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"47a90736-0787-4066-9a70-ac6bc59d7bec","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
19:02:18 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"47a90736-0787-4066-9a70-ac6bc59d7bec","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
19:02:18 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m47a90736-0787-4066-9a70-ac6bc59d7bec[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyDuration[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m5[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
[33m}[39m
19:03:10 - [32minfo[39m: Using current directory as template folder
19:03:10 - [32minfo[39m: Loading a default sample.txt file.
19:03:10 - [34mdebug[39m: fromDirectory
19:03:10 - [34mdebug[39m: fromDirectory
19:03:10 - [34mdebug[39m: fromDirectory
19:03:10 - [34mdebug[39m: fromDirectory
19:03:10 - [34mdebug[39m: fromDirectory
19:03:10 - [34mdebug[39m: fromDirectory
19:03:10 - [34mdebug[39m: fromDirectory
19:03:10 - [34mdebug[39m: constructor
19:03:10 - [34mdebug[39m: constructor
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processDirectory
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: fromDirectory
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: fromDirectory
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:10 - [34mdebug[39m: isFileInNodeModuleDir
19:03:10 - [34mdebug[39m: processFile
19:03:13 - [31merror[39m: Undeclared type string in property org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause.unknown 
IllegalModelException: Undeclared type string in property org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause.unknown 
    at ModelFile.resolveType (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/modelfile.js:255:27)
    at Field.validate (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/property.js:94:38)
    at AssetDeclaration.validate (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/classdeclaration.js:259:23)
    at AssetDeclaration.validate (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/assetdeclaration.js:70:15)
    at ModelFile.validate (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/modelfile.js:235:30)
    at ModelManager.validateModelFiles (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/modelmanager.js:296:33)
    at modelFileDownloader.downloadExternalDependencies.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/modelmanager.js:334:30)
    at process._tickCallback (internal/process/next_tick.js:68:7)
19:03:13 - [32minfo[39m: undefined
19:05:56 - [32minfo[39m: Using current directory as template folder
19:05:56 - [32minfo[39m: Loading a default sample.txt file.
19:05:56 - [34mdebug[39m: fromDirectory
19:05:56 - [34mdebug[39m: fromDirectory
19:05:56 - [34mdebug[39m: fromDirectory
19:05:56 - [34mdebug[39m: fromDirectory
19:05:56 - [34mdebug[39m: fromDirectory
19:05:56 - [34mdebug[39m: fromDirectory
19:05:56 - [34mdebug[39m: fromDirectory
19:05:56 - [34mdebug[39m: constructor
19:05:56 - [34mdebug[39m: constructor
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processDirectory
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: fromDirectory
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: fromDirectory
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:56 - [34mdebug[39m: isFileInNodeModuleDir
19:05:56 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: fromDirectory
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processDirectory
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: fromDirectory
19:05:57 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:05:57 - [34mdebug[39m: fromDirectory
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: isFileInNodeModuleDir
19:05:57 - [34mdebug[39m: processFile
19:05:57 - [34mdebug[39m: fromDirectory
19:05:57 - [34mdebug[39m: buildGrammar
19:05:57 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}},null]}
19:05:57 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:05:57 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:05:57 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:05:57 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:05:57 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:05:57 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:05:57 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:05:57 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:05:57 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:05:57 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:05:57 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:05:57 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:05:57 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:05:57 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:05:57 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
19:05:57 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}}
19:05:57 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "515e4165-cf12-45f8-a0bf-4acf135b98db",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        test : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> TemporalUnit {% id %} # test 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        test : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:05:57 - [34mdebug[39m: fromDirectory
19:05:57 - [34mdebug[39m: fromDirectory
19:05:57 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"515e4165-cf12-45f8-a0bf-4acf135b98db","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":"years"}
19:05:57 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"515e4165-cf12-45f8-a0bf-4acf135b98db","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":"years"}
19:05:57 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m515e4165-cf12-45f8-a0bf-4acf135b98db[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyDuration[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m5[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m[33m,[39m
  [33m"[39m[32mtest[39m[33m"[39m[33m: [39m[33m"[39m[35myears[39m[33m"[39m
[33m}[39m
19:07:06 - [32minfo[39m: Using current directory as template folder
19:07:06 - [32minfo[39m: Loading a default sample.txt file.
19:07:06 - [34mdebug[39m: fromDirectory
19:07:06 - [34mdebug[39m: fromDirectory
19:07:06 - [34mdebug[39m: fromDirectory
19:07:06 - [34mdebug[39m: fromDirectory
19:07:06 - [34mdebug[39m: fromDirectory
19:07:06 - [34mdebug[39m: fromDirectory
19:07:06 - [34mdebug[39m: fromDirectory
19:07:06 - [34mdebug[39m: constructor
19:07:06 - [34mdebug[39m: constructor
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processDirectory
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: fromDirectory
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: fromDirectory
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:06 - [34mdebug[39m: isFileInNodeModuleDir
19:07:06 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: fromDirectory
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processDirectory
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: fromDirectory
19:07:07 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:07:07 - [34mdebug[39m: fromDirectory
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: isFileInNodeModuleDir
19:07:07 - [34mdebug[39m: processFile
19:07:07 - [34mdebug[39m: fromDirectory
19:07:07 - [34mdebug[39m: buildGrammar
19:07:07 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}},null]}
19:07:07 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:07:07 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:07:07 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:07:07 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:07:07 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:07:07 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:07:07 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:07:07 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:07:07 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:07:07 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:07:07 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:07:07 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:07:07 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:07:07 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:07:07 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
19:07:07 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}}
19:07:07 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "efd1385c-5508-4fc7-bda9-0b2a7c5c26c5",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        test : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> Uncertainty {% id %} # test 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Uncertainty  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        test : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:07:07 - [34mdebug[39m: fromDirectory
19:07:07 - [34mdebug[39m: fromDirectory
19:07:07 - [31merror[39m: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. years
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "y"

Error: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. years
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "y"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
19:07:07 - [32minfo[39m: undefined
19:12:01 - [32minfo[39m: Using current directory as template folder
19:12:01 - [32minfo[39m: Loading a default sample.txt file.
19:12:01 - [34mdebug[39m: fromDirectory
19:12:01 - [34mdebug[39m: fromDirectory
19:12:01 - [34mdebug[39m: fromDirectory
19:12:01 - [34mdebug[39m: fromDirectory
19:12:01 - [34mdebug[39m: fromDirectory
19:12:01 - [34mdebug[39m: fromDirectory
19:12:01 - [34mdebug[39m: fromDirectory
19:12:01 - [34mdebug[39m: constructor
19:12:01 - [34mdebug[39m: constructor
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processDirectory
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: fromDirectory
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: fromDirectory
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:01 - [34mdebug[39m: isFileInNodeModuleDir
19:12:01 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: fromDirectory
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processDirectory
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: fromDirectory
19:12:02 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:12:02 - [34mdebug[39m: fromDirectory
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: isFileInNodeModuleDir
19:12:02 - [34mdebug[39m: processFile
19:12:02 - [34mdebug[39m: fromDirectory
19:12:02 - [34mdebug[39m: buildGrammar
19:12:02 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}},{"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}]}
19:12:02 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:12:02 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:12:02 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:12:02 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:12:02 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:12:02 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:12:02 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:12:02 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:12:02 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:12:02 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:12:02 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:12:02 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:12:02 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:12:02 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:12:02 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
19:12:02 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}}
19:12:02 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}
19:12:02 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "e7d6036e-716e-47f2-aca2-14102b47d864",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        test : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> String {% id %} # test 


rule16 -> "." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        test : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:12:02 - [34mdebug[39m: fromDirectory
19:12:02 - [34mdebug[39m: fromDirectory
19:12:02 - [31merror[39m: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. blubber.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "b"

Error: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. blubber.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "b"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
19:12:02 - [32minfo[39m: undefined
19:12:29 - [32minfo[39m: Using current directory as template folder
19:12:29 - [32minfo[39m: Loading a default sample.txt file.
19:12:29 - [34mdebug[39m: fromDirectory
19:12:29 - [34mdebug[39m: fromDirectory
19:12:29 - [34mdebug[39m: fromDirectory
19:12:29 - [34mdebug[39m: fromDirectory
19:12:29 - [34mdebug[39m: fromDirectory
19:12:29 - [34mdebug[39m: fromDirectory
19:12:29 - [34mdebug[39m: fromDirectory
19:12:29 - [34mdebug[39m: constructor
19:12:29 - [34mdebug[39m: constructor
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processDirectory
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: fromDirectory
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: fromDirectory
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:29 - [34mdebug[39m: isFileInNodeModuleDir
19:12:29 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: fromDirectory
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processDirectory
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: fromDirectory
19:12:30 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:12:30 - [34mdebug[39m: fromDirectory
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: isFileInNodeModuleDir
19:12:30 - [34mdebug[39m: processFile
19:12:30 - [34mdebug[39m: fromDirectory
19:12:30 - [34mdebug[39m: buildGrammar
19:12:30 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}},{"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}]}
19:12:30 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:12:30 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:12:30 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:12:30 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:12:30 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:12:30 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:12:30 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:12:30 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:12:30 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:12:30 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:12:30 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:12:30 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:12:30 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:12:30 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:12:30 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
19:12:30 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}}
19:12:30 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}
19:12:30 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "f2082791-398b-43ae-a94a-9c4fc823c1f1",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        test : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> Double {% id %} # test 


rule16 -> "." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Double  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        test : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:12:30 - [34mdebug[39m: fromDirectory
19:12:30 - [34mdebug[39m: fromDirectory
19:12:30 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"f2082791-398b-43ae-a94a-9c4fc823c1f1","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":10}
19:12:30 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"f2082791-398b-43ae-a94a-9c4fc823c1f1","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":10}
19:12:30 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35mf2082791-398b-43ae-a94a-9c4fc823c1f1[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyDuration[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m5[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m[33m,[39m
  [33m"[39m[32mtest[39m[33m"[39m[33m: [39m[36m10[39m
[33m}[39m
19:14:08 - [32minfo[39m: Using current directory as template folder
19:14:08 - [32minfo[39m: Loading a default sample.txt file.
19:14:08 - [34mdebug[39m: fromDirectory
19:14:08 - [34mdebug[39m: fromDirectory
19:14:08 - [34mdebug[39m: fromDirectory
19:14:08 - [34mdebug[39m: fromDirectory
19:14:08 - [34mdebug[39m: fromDirectory
19:14:08 - [34mdebug[39m: fromDirectory
19:14:08 - [34mdebug[39m: fromDirectory
19:14:08 - [34mdebug[39m: constructor
19:14:08 - [34mdebug[39m: constructor
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processDirectory
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: fromDirectory
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: fromDirectory
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: fromDirectory
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processDirectory
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: isFileInNodeModuleDir
19:14:08 - [34mdebug[39m: processFile
19:14:08 - [34mdebug[39m: fromDirectory
19:14:09 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:14:09 - [34mdebug[39m: fromDirectory
19:14:09 - [34mdebug[39m: isFileInNodeModuleDir
19:14:09 - [34mdebug[39m: processFile
19:14:09 - [34mdebug[39m: isFileInNodeModuleDir
19:14:09 - [34mdebug[39m: processFile
19:14:09 - [34mdebug[39m: isFileInNodeModuleDir
19:14:09 - [34mdebug[39m: processFile
19:14:09 - [34mdebug[39m: isFileInNodeModuleDir
19:14:09 - [34mdebug[39m: processFile
19:14:09 - [34mdebug[39m: isFileInNodeModuleDir
19:14:09 - [34mdebug[39m: processFile
19:14:09 - [34mdebug[39m: isFileInNodeModuleDir
19:14:09 - [34mdebug[39m: processFile
19:14:09 - [34mdebug[39m: isFileInNodeModuleDir
19:14:09 - [34mdebug[39m: processFile
19:14:09 - [34mdebug[39m: isFileInNodeModuleDir
19:14:09 - [34mdebug[39m: processFile
19:14:09 - [34mdebug[39m: isFileInNodeModuleDir
19:14:09 - [34mdebug[39m: processFile
19:14:09 - [34mdebug[39m: isFileInNodeModuleDir
19:14:09 - [34mdebug[39m: processFile
19:14:09 - [34mdebug[39m: fromDirectory
19:14:09 - [34mdebug[39m: buildGrammar
19:14:09 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}},{"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}]}
19:14:09 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:14:09 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:14:09 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:14:09 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:14:09 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:14:09 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:14:09 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:14:09 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:14:09 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:14:09 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:14:09 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:14:09 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:14:09 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:14:09 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:14:09 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
19:14:09 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}}
19:14:09 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}
19:14:09 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "58a1be99-2ad9-4d6d-b05c-d6b1196f942d",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        test : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> Duration {% id %} # test 


rule16 -> "." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Duration  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        test : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:14:09 - [34mdebug[39m: fromDirectory
19:14:09 - [34mdebug[39m: fromDirectory
19:14:09 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"58a1be99-2ad9-4d6d-b05c-d6b1196f942d","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":{"$class":"org.accordproject.time.Duration","amount":10,"unit":"weeks"}}
19:14:09 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"58a1be99-2ad9-4d6d-b05c-d6b1196f942d","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":{"$class":"org.accordproject.time.Duration","amount":10,"unit":"weeks"}}
19:14:09 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m58a1be99-2ad9-4d6d-b05c-d6b1196f942d[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyDuration[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m5[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m[33m,[39m
  [33m"[39m[32mtest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m10[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mweeks[39m[33m"[39m
  [33m}[39m
[33m}[39m
19:14:40 - [32minfo[39m: Using current directory as template folder
19:14:40 - [32minfo[39m: Loading a default sample.txt file.
19:14:40 - [34mdebug[39m: fromDirectory
19:14:40 - [34mdebug[39m: fromDirectory
19:14:40 - [34mdebug[39m: fromDirectory
19:14:40 - [34mdebug[39m: fromDirectory
19:14:40 - [34mdebug[39m: fromDirectory
19:14:40 - [34mdebug[39m: fromDirectory
19:14:40 - [34mdebug[39m: fromDirectory
19:14:40 - [34mdebug[39m: constructor
19:14:40 - [34mdebug[39m: constructor
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processDirectory
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: fromDirectory
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: fromDirectory
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: fromDirectory
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processDirectory
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: isFileInNodeModuleDir
19:14:40 - [34mdebug[39m: processFile
19:14:40 - [34mdebug[39m: fromDirectory
19:14:40 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:14:41 - [34mdebug[39m: fromDirectory
19:14:41 - [34mdebug[39m: isFileInNodeModuleDir
19:14:41 - [34mdebug[39m: processFile
19:14:41 - [34mdebug[39m: isFileInNodeModuleDir
19:14:41 - [34mdebug[39m: processFile
19:14:41 - [34mdebug[39m: isFileInNodeModuleDir
19:14:41 - [34mdebug[39m: processFile
19:14:41 - [34mdebug[39m: isFileInNodeModuleDir
19:14:41 - [34mdebug[39m: processFile
19:14:41 - [34mdebug[39m: isFileInNodeModuleDir
19:14:41 - [34mdebug[39m: processFile
19:14:41 - [34mdebug[39m: isFileInNodeModuleDir
19:14:41 - [34mdebug[39m: processFile
19:14:41 - [34mdebug[39m: isFileInNodeModuleDir
19:14:41 - [34mdebug[39m: processFile
19:14:41 - [34mdebug[39m: isFileInNodeModuleDir
19:14:41 - [34mdebug[39m: processFile
19:14:41 - [34mdebug[39m: isFileInNodeModuleDir
19:14:41 - [34mdebug[39m: processFile
19:14:41 - [34mdebug[39m: isFileInNodeModuleDir
19:14:41 - [34mdebug[39m: processFile
19:14:41 - [34mdebug[39m: fromDirectory
19:14:41 - [34mdebug[39m: buildGrammar
19:14:41 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}},{"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}]}
19:14:41 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:14:41 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:14:41 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:14:41 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:14:41 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:14:41 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:14:41 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:14:41 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:14:41 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:14:41 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:14:41 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:14:41 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:14:41 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:14:41 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:14:41 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
19:14:41 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}}
19:14:41 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}
19:14:41 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "21f1b055-7a5f-420e-9ad2-ea1a02b53808",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        test : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> Uncertainty {% id %} # test 


rule16 -> "." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Uncertainty  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        test : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> Double 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:14:41 - [34mdebug[39m: fromDirectory
19:14:41 - [34mdebug[39m: fromDirectory
19:14:41 - [31merror[39m: invalid syntax at line 1 col 515:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. 10 weeks.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ^
Unexpected " "

Error: invalid syntax at line 1 col 515:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. 10 weeks.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ^
Unexpected " "

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
19:14:41 - [32minfo[39m: undefined
19:15:55 - [32minfo[39m: Using current directory as template folder
19:15:55 - [32minfo[39m: Loading a default sample.txt file.
19:15:55 - [34mdebug[39m: fromDirectory
19:15:55 - [34mdebug[39m: fromDirectory
19:15:55 - [34mdebug[39m: fromDirectory
19:15:55 - [34mdebug[39m: fromDirectory
19:15:55 - [34mdebug[39m: fromDirectory
19:15:55 - [34mdebug[39m: fromDirectory
19:15:55 - [34mdebug[39m: fromDirectory
19:15:55 - [34mdebug[39m: constructor
19:15:55 - [34mdebug[39m: constructor
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processDirectory
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: fromDirectory
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: fromDirectory
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:55 - [34mdebug[39m: isFileInNodeModuleDir
19:15:55 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: fromDirectory
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processDirectory
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: fromDirectory
19:15:56 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:15:56 - [34mdebug[39m: fromDirectory
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: isFileInNodeModuleDir
19:15:56 - [34mdebug[39m: processFile
19:15:56 - [34mdebug[39m: fromDirectory
19:15:56 - [34mdebug[39m: buildGrammar
19:15:56 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}},{"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}]}
19:15:56 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:15:56 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:15:56 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:15:56 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:15:56 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:15:56 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:15:56 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:15:56 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:15:56 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:15:56 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:15:56 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:15:56 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:15:56 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:15:56 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:15:56 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
19:15:56 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}}
19:15:56 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}
19:15:56 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "d54b2ac7-4510-4e82-aad1-7997a22ac867",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        test : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> Uncertainty {% id %} # test 


rule16 -> "." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Uncertainty  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        test : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> Double 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:15:56 - [34mdebug[39m: fromDirectory
19:15:56 - [34mdebug[39m: fromDirectory
19:15:56 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"d54b2ac7-4510-4e82-aad1-7997a22ac867","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":{"$class":"my.namespace.Uncertainty","uncertainty":20}}
19:15:56 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"d54b2ac7-4510-4e82-aad1-7997a22ac867","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":{"$class":"my.namespace.Uncertainty","uncertainty":20}}
19:15:56 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35md54b2ac7-4510-4e82-aad1-7997a22ac867[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyDuration[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m5[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m[33m,[39m
  [33m"[39m[32mtest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35mmy.namespace.Uncertainty[39m[33m"[39m[33m,[39m
    [33m"[39m[32muncertainty[39m[33m"[39m[33m: [39m[36m20[39m
  [33m}[39m
[33m}[39m
19:23:57 - [32minfo[39m: Using current directory as template folder
19:23:57 - [32minfo[39m: Loading a default sample.txt file.
19:23:57 - [34mdebug[39m: fromDirectory
19:23:57 - [34mdebug[39m: fromDirectory
19:23:57 - [34mdebug[39m: fromDirectory
19:23:57 - [34mdebug[39m: fromDirectory
19:23:57 - [34mdebug[39m: fromDirectory
19:23:57 - [34mdebug[39m: fromDirectory
19:23:57 - [34mdebug[39m: fromDirectory
19:23:57 - [34mdebug[39m: constructor
19:23:57 - [34mdebug[39m: constructor
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processDirectory
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: fromDirectory
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: fromDirectory
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: fromDirectory
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processDirectory
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: isFileInNodeModuleDir
19:23:57 - [34mdebug[39m: processFile
19:23:57 - [34mdebug[39m: fromDirectory
19:23:57 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:23:58 - [34mdebug[39m: fromDirectory
19:23:58 - [34mdebug[39m: isFileInNodeModuleDir
19:23:58 - [34mdebug[39m: processFile
19:23:58 - [34mdebug[39m: isFileInNodeModuleDir
19:23:58 - [34mdebug[39m: processFile
19:23:58 - [34mdebug[39m: isFileInNodeModuleDir
19:23:58 - [34mdebug[39m: processFile
19:23:58 - [34mdebug[39m: isFileInNodeModuleDir
19:23:58 - [34mdebug[39m: processFile
19:23:58 - [34mdebug[39m: isFileInNodeModuleDir
19:23:58 - [34mdebug[39m: processFile
19:23:58 - [34mdebug[39m: isFileInNodeModuleDir
19:23:58 - [34mdebug[39m: processFile
19:23:58 - [34mdebug[39m: isFileInNodeModuleDir
19:23:58 - [34mdebug[39m: processFile
19:23:58 - [34mdebug[39m: isFileInNodeModuleDir
19:23:58 - [34mdebug[39m: processFile
19:23:58 - [34mdebug[39m: isFileInNodeModuleDir
19:23:58 - [34mdebug[39m: processFile
19:23:58 - [34mdebug[39m: isFileInNodeModuleDir
19:23:58 - [34mdebug[39m: processFile
19:23:58 - [34mdebug[39m: fromDirectory
19:23:58 - [34mdebug[39m: buildGrammar
19:23:58 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}},{"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}]}
19:23:58 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:23:58 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:23:58 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:23:58 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:23:58 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:23:58 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:23:58 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:23:58 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:23:58 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:23:58 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:23:58 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:23:58 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:23:58 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:23:58 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:23:58 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
19:23:58 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}}
19:23:58 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}
19:23:58 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "52212c0e-b30b-4832-bc78-94bd43da2efa",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        test : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> Uncertainty {% id %} # test 


rule16 -> "." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Uncertainty  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        test : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:23:58 - [34mdebug[39m: fromDirectory
19:23:58 - [34mdebug[39m: fromDirectory
19:23:58 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"52212c0e-b30b-4832-bc78-94bd43da2efa","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":{"$class":"my.namespace.Uncertainty","uncertainty":"test String"}}
19:23:58 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"52212c0e-b30b-4832-bc78-94bd43da2efa","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":{"$class":"my.namespace.Uncertainty","uncertainty":"test String"}}
19:23:58 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m52212c0e-b30b-4832-bc78-94bd43da2efa[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyDuration[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m5[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m[33m,[39m
  [33m"[39m[32mtest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35mmy.namespace.Uncertainty[39m[33m"[39m[33m,[39m
    [33m"[39m[32muncertainty[39m[33m"[39m[33m: [39m[33m"[39m[35mtest String[39m[33m"[39m
  [33m}[39m
[33m}[39m
19:24:26 - [32minfo[39m: Using current directory as template folder
19:24:26 - [32minfo[39m: Loading a default sample.txt file.
19:24:26 - [34mdebug[39m: fromDirectory
19:24:26 - [34mdebug[39m: fromDirectory
19:24:26 - [34mdebug[39m: fromDirectory
19:24:26 - [34mdebug[39m: fromDirectory
19:24:26 - [34mdebug[39m: fromDirectory
19:24:26 - [34mdebug[39m: fromDirectory
19:24:26 - [34mdebug[39m: fromDirectory
19:24:26 - [34mdebug[39m: constructor
19:24:26 - [34mdebug[39m: constructor
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processDirectory
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: fromDirectory
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: fromDirectory
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: fromDirectory
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processDirectory
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: isFileInNodeModuleDir
19:24:26 - [34mdebug[39m: processFile
19:24:26 - [34mdebug[39m: fromDirectory
19:24:27 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:24:27 - [34mdebug[39m: fromDirectory
19:24:27 - [34mdebug[39m: isFileInNodeModuleDir
19:24:27 - [34mdebug[39m: processFile
19:24:27 - [34mdebug[39m: isFileInNodeModuleDir
19:24:27 - [34mdebug[39m: processFile
19:24:27 - [34mdebug[39m: isFileInNodeModuleDir
19:24:27 - [34mdebug[39m: processFile
19:24:27 - [34mdebug[39m: isFileInNodeModuleDir
19:24:27 - [34mdebug[39m: processFile
19:24:27 - [34mdebug[39m: isFileInNodeModuleDir
19:24:27 - [34mdebug[39m: processFile
19:24:27 - [34mdebug[39m: isFileInNodeModuleDir
19:24:27 - [34mdebug[39m: processFile
19:24:27 - [34mdebug[39m: isFileInNodeModuleDir
19:24:27 - [34mdebug[39m: processFile
19:24:27 - [34mdebug[39m: isFileInNodeModuleDir
19:24:27 - [34mdebug[39m: processFile
19:24:27 - [34mdebug[39m: isFileInNodeModuleDir
19:24:27 - [34mdebug[39m: processFile
19:24:27 - [34mdebug[39m: isFileInNodeModuleDir
19:24:27 - [34mdebug[39m: processFile
19:24:27 - [34mdebug[39m: fromDirectory
19:24:27 - [34mdebug[39m: buildGrammar
19:24:27 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}},{"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}]}
19:24:27 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:24:27 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:24:27 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:24:27 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:24:27 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:24:27 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:24:27 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:24:27 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:24:27 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:24:27 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:24:27 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:24:27 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:24:27 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:24:27 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:24:27 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
19:24:27 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}}
19:24:27 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}
19:24:27 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "4b3f68c5-b3e9-47f9-baf1-dafc0bf954a5",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        test : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> Uncertainty {% id %} # test 


rule16 -> "." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Uncertainty  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        test : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String  __  Double 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0],
        amount : data[2]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:24:27 - [34mdebug[39m: fromDirectory
19:24:27 - [34mdebug[39m: fromDirectory
19:24:27 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"4b3f68c5-b3e9-47f9-baf1-dafc0bf954a5","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":{"$class":"my.namespace.Uncertainty","uncertainty":"test String","amount":10}}
19:24:27 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"4b3f68c5-b3e9-47f9-baf1-dafc0bf954a5","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":{"$class":"my.namespace.Uncertainty","uncertainty":"test String","amount":10}}
19:24:27 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m4b3f68c5-b3e9-47f9-baf1-dafc0bf954a5[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyDuration[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m5[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m[33m,[39m
  [33m"[39m[32mtest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35mmy.namespace.Uncertainty[39m[33m"[39m[33m,[39m
    [33m"[39m[32muncertainty[39m[33m"[39m[33m: [39m[33m"[39m[35mtest String[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m10[39m
  [33m}[39m
[33m}[39m
19:24:43 - [32minfo[39m: Using current directory as template folder
19:24:43 - [32minfo[39m: Loading a default sample.txt file.
19:24:43 - [34mdebug[39m: fromDirectory
19:24:43 - [34mdebug[39m: fromDirectory
19:24:43 - [34mdebug[39m: fromDirectory
19:24:43 - [34mdebug[39m: fromDirectory
19:24:43 - [34mdebug[39m: fromDirectory
19:24:43 - [34mdebug[39m: fromDirectory
19:24:43 - [34mdebug[39m: fromDirectory
19:24:43 - [34mdebug[39m: constructor
19:24:43 - [34mdebug[39m: constructor
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processDirectory
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: fromDirectory
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: fromDirectory
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:43 - [34mdebug[39m: isFileInNodeModuleDir
19:24:43 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: fromDirectory
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processDirectory
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: fromDirectory
19:24:44 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:24:44 - [34mdebug[39m: fromDirectory
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: isFileInNodeModuleDir
19:24:44 - [34mdebug[39m: processFile
19:24:44 - [34mdebug[39m: fromDirectory
19:24:44 - [34mdebug[39m: buildGrammar
19:24:44 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}},{"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}]}
19:24:44 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:24:44 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:24:44 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:24:44 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:24:44 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:24:44 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:24:44 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:24:44 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:24:44 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:24:44 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:24:44 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:24:44 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:24:44 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:24:44 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:24:44 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
19:24:44 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}}
19:24:44 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}
19:24:44 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "d98d103c-89ee-4442-8627-39b782d0f48c",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        test : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> Uncertainty {% id %} # test 


rule16 -> "." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Uncertainty  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        test : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> Double  __  String 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        amount : data[0],
        uncertainty : data[2]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:24:44 - [34mdebug[39m: fromDirectory
19:24:44 - [34mdebug[39m: fromDirectory
19:24:44 - [31merror[39m: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. "test String" 10.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "\""

Error: invalid syntax at line 1 col 513:

  Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 5 days of delay penalty amounting to 10.5% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a days is to be considered a full days. The total amount of penalty shall not however, exceed 55% of the total value of the Equipment involved in late delivery. If the delay is more than 15 days, the Buyer is entitled to terminate this Contract. "test String" 10.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ^
Unexpected "\""

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Clause.parse (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/templateinstance.js:96:16)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:54:24)
    at process._tickCallback (internal/process/next_tick.js:68:7)
19:24:44 - [32minfo[39m: undefined
19:24:52 - [32minfo[39m: Using current directory as template folder
19:24:52 - [32minfo[39m: Loading a default sample.txt file.
19:24:52 - [34mdebug[39m: fromDirectory
19:24:52 - [34mdebug[39m: fromDirectory
19:24:52 - [34mdebug[39m: fromDirectory
19:24:52 - [34mdebug[39m: fromDirectory
19:24:52 - [34mdebug[39m: fromDirectory
19:24:52 - [34mdebug[39m: fromDirectory
19:24:52 - [34mdebug[39m: fromDirectory
19:24:52 - [34mdebug[39m: constructor
19:24:52 - [34mdebug[39m: constructor
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processDirectory
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: fromDirectory
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: fromDirectory
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:52 - [34mdebug[39m: isFileInNodeModuleDir
19:24:52 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: fromDirectory
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processDirectory
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: fromDirectory
19:24:53 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



19:24:53 - [34mdebug[39m: fromDirectory
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: isFileInNodeModuleDir
19:24:53 - [34mdebug[39m: processFile
19:24:53 - [34mdebug[39m: fromDirectory
19:24:53 - [34mdebug[39m: buildGrammar
19:24:53 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}},{"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563},{"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}},{"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}]}
19:24:53 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
19:24:53 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
19:24:53 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for every ","text":" the Seller shall pay to the Buyer for every [{","offset":107,"lineBreaks":0,"line":1,"col":108}
19:24:53 - [34mdebug[39m: element rule3 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyDuration","text":"penaltyDuration","offset":154,"lineBreaks":0,"line":1,"col":155}}
19:24:53 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":171,"lineBreaks":0,"line":1,"col":172}
19:24:53 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":204,"lineBreaks":0,"line":1,"col":205}}
19:24:53 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":223,"lineBreaks":0,"line":1,"col":224}
19:24:53 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":321,"lineBreaks":0,"line":1,"col":322}}
19:24:53 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":337,"lineBreaks":0,"line":1,"col":338}
19:24:53 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":367,"lineBreaks":0,"line":1,"col":368}}
19:24:53 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":383,"lineBreaks":0,"line":1,"col":384}
19:24:53 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":441,"lineBreaks":0,"line":1,"col":442}}
19:24:53 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":456,"lineBreaks":0,"line":1,"col":457}
19:24:53 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":549,"lineBreaks":0,"line":1,"col":550}}
19:24:53 - [34mdebug[39m: element rule14 {"type":"Chunk","value":", the Buyer is entitled to terminate this Contract. ","text":", the Buyer is entitled to terminate this Contract. [{","offset":562,"lineBreaks":0,"line":1,"col":563}
19:24:53 - [34mdebug[39m: element rule15 {"type":"Binding","fieldName":{"type":"varid","value":"test","text":"test","offset":616,"lineBreaks":0,"line":1,"col":617}}
19:24:53 - [34mdebug[39m: element rule16 {"type":"LastChunk","value":".","text":".","offset":622,"lineBreaks":0,"line":1,"col":623}
19:24:53 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 rule15 rule16 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14,rule15,rule16 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "de866145-6943-460c-94f8-da40801d9ecd",
        forceMajeure : rule1,
        penaltyDuration : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
        test : rule15,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for every " 


rule3 -> Duration {% id %} # penaltyDuration 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract. " 


rule15 -> Uncertainty {% id %} # test 


rule16 -> "." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration  __  Double  __  Double  __  Duration  __  TemporalUnit  __  Uncertainty  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        penaltyPercentage : data[4],
        capPercentage : data[6],
        termination : data[8],
        fractionalPart : data[10],
        test : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String  __  Double 

{% ( data ) => {
    return {
        $class: "my.namespace.Uncertainty",
        uncertainty : data[0],
        amount : data[2]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
19:24:53 - [34mdebug[39m: fromDirectory
19:24:53 - [34mdebug[39m: fromDirectory
19:24:53 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"de866145-6943-460c-94f8-da40801d9ecd","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":{"$class":"my.namespace.Uncertainty","uncertainty":"test String","amount":10}}
19:24:53 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"de866145-6943-460c-94f8-da40801d9ecd","forceMajeure":true,"penaltyDuration":{"$class":"org.accordproject.time.Duration","amount":5,"unit":"days"},"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days","test":{"$class":"my.namespace.Uncertainty","uncertainty":"test String","amount":10}}
19:24:53 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35mde866145-6943-460c-94f8-da40801d9ecd[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyDuration[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m5[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m[33m,[39m
  [33m"[39m[32mtest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35mmy.namespace.Uncertainty[39m[33m"[39m[33m,[39m
    [33m"[39m[32muncertainty[39m[33m"[39m[33m: [39m[33m"[39m[35mtest String[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m10[39m
  [33m}[39m
[33m}[39m
20:33:31 - [32minfo[39m: Using current directory as template folder
20:33:31 - [32minfo[39m: Loading a default sample.txt file.
20:33:31 - [34mdebug[39m: fromDirectory
20:33:31 - [34mdebug[39m: fromDirectory
20:33:31 - [34mdebug[39m: fromDirectory
20:33:31 - [34mdebug[39m: fromDirectory
20:33:31 - [34mdebug[39m: fromDirectory
20:33:31 - [34mdebug[39m: fromDirectory
20:33:31 - [34mdebug[39m: fromDirectory
20:33:31 - [34mdebug[39m: constructor
20:33:31 - [34mdebug[39m: constructor
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processDirectory
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: fromDirectory
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: fromDirectory
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [34mdebug[39m: isFileInNodeModuleDir
20:33:31 - [34mdebug[39m: processFile
20:33:31 - [31merror[39m: Failed to load model file. Queue: [{"downloadedUris":{},"url":"https://models.accordproject.org/cicero/contract.cto","options":{}},{"downloadedUris":{},"url":"https://models.accordproject.org/cicero/runtime.cto","options":{}},{"downloadedUris":{},"url":"https://models.accordproject.org/cicero/contract.cto","options":{}},{"downloadedUris":{},"url":"https://models.accordproject.org/cicero/runtime.cto","options":{}},{"downloadedUris":{},"url":"https://models.accordproject.org/time.cto","options":{}}] Details: {}
Error: Failed to load model file. Queue: [{"downloadedUris":{},"url":"https://models.accordproject.org/cicero/contract.cto","options":{}},{"downloadedUris":{},"url":"https://models.accordproject.org/cicero/runtime.cto","options":{}},{"downloadedUris":{},"url":"https://models.accordproject.org/cicero/contract.cto","options":{}},{"downloadedUris":{},"url":"https://models.accordproject.org/cicero/runtime.cto","options":{}},{"downloadedUris":{},"url":"https://models.accordproject.org/time.cto","options":{}}] Details: {}
    at ModelFileDownloader.on (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/loaders/modelfiledownloader.js:72:25)
    at ModelFileDownloader.emit (events.js:182:13)
    at runJob.then.catch (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/loaders/jobqueue.js:152:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
20:33:31 - [32minfo[39m: undefined
21:27:15 - [32minfo[39m: Using current directory as template folder
21:27:15 - [32minfo[39m: Loading a default sample.txt file.
21:27:15 - [34mdebug[39m: fromDirectory
21:27:15 - [34mdebug[39m: fromDirectory
21:27:15 - [34mdebug[39m: fromDirectory
21:27:15 - [34mdebug[39m: fromDirectory
21:27:15 - [34mdebug[39m: fromDirectory
21:27:15 - [34mdebug[39m: fromDirectory
21:27:15 - [34mdebug[39m: fromDirectory
21:27:15 - [34mdebug[39m: constructor
21:27:15 - [34mdebug[39m: constructor
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processDirectory
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: fromDirectory
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: fromDirectory
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:15 - [34mdebug[39m: isFileInNodeModuleDir
21:27:15 - [34mdebug[39m: processFile
21:27:16 - [34mdebug[39m: fromDirectory
21:27:16 - [34mdebug[39m: isFileInNodeModuleDir
21:27:16 - [34mdebug[39m: isFileInNodeModuleDir
21:27:16 - [34mdebug[39m: isFileInNodeModuleDir
21:27:16 - [34mdebug[39m: isFileInNodeModuleDir
21:27:16 - [34mdebug[39m: isFileInNodeModuleDir
21:27:16 - [34mdebug[39m: processDirectory
21:27:16 - [34mdebug[39m: isFileInNodeModuleDir
21:27:16 - [34mdebug[39m: processFile
21:27:16 - [34mdebug[39m: isFileInNodeModuleDir
21:27:16 - [34mdebug[39m: processFile
21:27:16 - [34mdebug[39m: isFileInNodeModuleDir
21:27:16 - [34mdebug[39m: processFile
21:27:16 - [34mdebug[39m: isFileInNodeModuleDir
21:27:16 - [34mdebug[39m: processFile
21:27:16 - [34mdebug[39m: fromDirectory
21:27:16 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 31 character 35]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 31 character 35]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
21:27:16 - [32minfo[39m: undefined
21:29:24 - [32minfo[39m: Using current directory as template folder
21:29:24 - [32minfo[39m: Loading a default sample.txt file.
21:29:24 - [34mdebug[39m: fromDirectory
21:29:24 - [34mdebug[39m: fromDirectory
21:29:24 - [34mdebug[39m: fromDirectory
21:29:24 - [34mdebug[39m: fromDirectory
21:29:24 - [34mdebug[39m: fromDirectory
21:29:24 - [34mdebug[39m: fromDirectory
21:29:24 - [34mdebug[39m: fromDirectory
21:29:24 - [34mdebug[39m: constructor
21:29:24 - [34mdebug[39m: constructor
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processDirectory
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: fromDirectory
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: fromDirectory
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:24 - [34mdebug[39m: isFileInNodeModuleDir
21:29:24 - [34mdebug[39m: processFile
21:29:25 - [34mdebug[39m: fromDirectory
21:29:25 - [34mdebug[39m: isFileInNodeModuleDir
21:29:25 - [34mdebug[39m: isFileInNodeModuleDir
21:29:25 - [34mdebug[39m: isFileInNodeModuleDir
21:29:25 - [34mdebug[39m: isFileInNodeModuleDir
21:29:25 - [34mdebug[39m: isFileInNodeModuleDir
21:29:25 - [34mdebug[39m: processDirectory
21:29:25 - [34mdebug[39m: isFileInNodeModuleDir
21:29:25 - [34mdebug[39m: processFile
21:29:25 - [34mdebug[39m: isFileInNodeModuleDir
21:29:25 - [34mdebug[39m: processFile
21:29:25 - [34mdebug[39m: isFileInNodeModuleDir
21:29:25 - [34mdebug[39m: processFile
21:29:25 - [34mdebug[39m: isFileInNodeModuleDir
21:29:25 - [34mdebug[39m: processFile
21:29:25 - [34mdebug[39m: fromDirectory
21:29:25 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 46 character 2]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 46 character 2]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
21:29:25 - [32minfo[39m: undefined
21:30:08 - [32minfo[39m: Using current directory as template folder
21:30:08 - [32minfo[39m: Loading a default sample.txt file.
21:30:08 - [34mdebug[39m: fromDirectory
21:30:08 - [34mdebug[39m: fromDirectory
21:30:08 - [34mdebug[39m: fromDirectory
21:30:08 - [34mdebug[39m: fromDirectory
21:30:08 - [34mdebug[39m: fromDirectory
21:30:08 - [34mdebug[39m: fromDirectory
21:30:08 - [34mdebug[39m: fromDirectory
21:30:08 - [34mdebug[39m: constructor
21:30:08 - [34mdebug[39m: constructor
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processDirectory
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: fromDirectory
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: fromDirectory
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:08 - [34mdebug[39m: isFileInNodeModuleDir
21:30:08 - [34mdebug[39m: processFile
21:30:09 - [34mdebug[39m: fromDirectory
21:30:09 - [34mdebug[39m: isFileInNodeModuleDir
21:30:09 - [34mdebug[39m: isFileInNodeModuleDir
21:30:09 - [34mdebug[39m: isFileInNodeModuleDir
21:30:09 - [34mdebug[39m: isFileInNodeModuleDir
21:30:09 - [34mdebug[39m: isFileInNodeModuleDir
21:30:09 - [34mdebug[39m: processDirectory
21:30:09 - [34mdebug[39m: isFileInNodeModuleDir
21:30:09 - [34mdebug[39m: processFile
21:30:09 - [34mdebug[39m: isFileInNodeModuleDir
21:30:09 - [34mdebug[39m: processFile
21:30:09 - [34mdebug[39m: isFileInNodeModuleDir
21:30:09 - [34mdebug[39m: processFile
21:30:09 - [34mdebug[39m: isFileInNodeModuleDir
21:30:09 - [34mdebug[39m: processFile
21:30:09 - [34mdebug[39m: fromDirectory
21:30:09 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 45 character 2]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 45 character 2]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
21:30:09 - [32minfo[39m: undefined
21:30:40 - [32minfo[39m: Using current directory as template folder
21:30:40 - [32minfo[39m: Loading a default sample.txt file.
21:30:40 - [34mdebug[39m: fromDirectory
21:30:40 - [34mdebug[39m: fromDirectory
21:30:40 - [34mdebug[39m: fromDirectory
21:30:40 - [34mdebug[39m: fromDirectory
21:30:40 - [34mdebug[39m: fromDirectory
21:30:40 - [34mdebug[39m: fromDirectory
21:30:40 - [34mdebug[39m: fromDirectory
21:30:40 - [34mdebug[39m: constructor
21:30:40 - [34mdebug[39m: constructor
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processDirectory
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: fromDirectory
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: fromDirectory
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:40 - [34mdebug[39m: isFileInNodeModuleDir
21:30:40 - [34mdebug[39m: processFile
21:30:48 - [34mdebug[39m: fromDirectory
21:30:48 - [34mdebug[39m: isFileInNodeModuleDir
21:30:48 - [34mdebug[39m: isFileInNodeModuleDir
21:30:48 - [34mdebug[39m: isFileInNodeModuleDir
21:30:48 - [34mdebug[39m: isFileInNodeModuleDir
21:30:48 - [34mdebug[39m: isFileInNodeModuleDir
21:30:48 - [34mdebug[39m: processDirectory
21:30:48 - [34mdebug[39m: isFileInNodeModuleDir
21:30:48 - [34mdebug[39m: processFile
21:30:48 - [34mdebug[39m: isFileInNodeModuleDir
21:30:48 - [34mdebug[39m: processFile
21:30:48 - [34mdebug[39m: isFileInNodeModuleDir
21:30:48 - [34mdebug[39m: processFile
21:30:48 - [34mdebug[39m: isFileInNodeModuleDir
21:30:48 - [34mdebug[39m: processFile
21:30:48 - [34mdebug[39m: fromDirectory
21:30:48 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 46 character 2]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 46 character 2]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
21:30:48 - [32minfo[39m: undefined
21:31:00 - [32minfo[39m: Using current directory as template folder
21:31:00 - [32minfo[39m: Loading a default sample.txt file.
21:31:00 - [34mdebug[39m: fromDirectory
21:31:00 - [34mdebug[39m: fromDirectory
21:31:00 - [34mdebug[39m: fromDirectory
21:31:00 - [34mdebug[39m: fromDirectory
21:31:00 - [34mdebug[39m: fromDirectory
21:31:00 - [34mdebug[39m: fromDirectory
21:31:00 - [34mdebug[39m: fromDirectory
21:31:00 - [34mdebug[39m: constructor
21:31:00 - [34mdebug[39m: constructor
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processDirectory
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: fromDirectory
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: fromDirectory
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:00 - [34mdebug[39m: isFileInNodeModuleDir
21:31:00 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: fromDirectory
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processDirectory
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: fromDirectory
21:31:03 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



21:31:03 - [34mdebug[39m: fromDirectory
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: isFileInNodeModuleDir
21:31:03 - [34mdebug[39m: processFile
21:31:03 - [34mdebug[39m: fromDirectory
21:31:03 - [34mdebug[39m: buildGrammar
21:31:03 - [31merror[39m: invalid syntax at line 1 col 174:

  Late Delivery and Penalty. In case of delayed delivery[{" except for Force Majeure cases,":? forceMajeure}] the Seller shall pay to the Buyer for [{"a okay amount of days":?uncertainPenalty
                                                                                                                                                                               ^
Unexpected varid token: "uncertainPenalty"

Error: invalid syntax at line 1 col 174:

  Late Delivery and Penalty. In case of delayed delivery[{" except for Force Majeure cases,":? forceMajeure}] the Seller shall pay to the Buyer for [{"a okay amount of days":?uncertainPenalty
                                                                                                                                                                               ^
Unexpected varid token: "uncertainPenalty"

    at Parser.feed (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/nearley/lib/nearley.js:317:27)
    at Template.buildGrammar (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:179:16)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1016:26)
    at process._tickCallback (internal/process/next_tick.js:68:7)
21:31:03 - [32minfo[39m: undefined
21:32:24 - [32minfo[39m: Using current directory as template folder
21:32:24 - [32minfo[39m: Loading a default sample.txt file.
21:32:24 - [34mdebug[39m: fromDirectory
21:32:24 - [34mdebug[39m: fromDirectory
21:32:24 - [34mdebug[39m: fromDirectory
21:32:24 - [34mdebug[39m: fromDirectory
21:32:24 - [34mdebug[39m: fromDirectory
21:32:24 - [34mdebug[39m: fromDirectory
21:32:24 - [34mdebug[39m: fromDirectory
21:32:24 - [34mdebug[39m: constructor
21:32:24 - [34mdebug[39m: constructor
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processDirectory
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: fromDirectory
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: fromDirectory
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:24 - [34mdebug[39m: isFileInNodeModuleDir
21:32:24 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: fromDirectory
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processDirectory
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: fromDirectory
21:32:25 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



21:32:25 - [34mdebug[39m: fromDirectory
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: isFileInNodeModuleDir
21:32:25 - [34mdebug[39m: processFile
21:32:25 - [34mdebug[39m: fromDirectory
21:32:25 - [34mdebug[39m: buildGrammar
21:32:25 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
21:32:25 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
21:32:25 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
21:32:25 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
21:32:25 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
21:32:25 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
21:32:25 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
21:32:25 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
21:32:25 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
21:32:25 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
21:32:25 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
21:32:25 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
21:32:25 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
21:32:25 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
21:32:25 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
21:32:25 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
21:32:25 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "a55728e7-3e9e-4956-a6aa-5608e5e7da7a",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.Uncertainty",
        uncertainty : data[0],
        amount : data[2]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
21:32:25 - [34mdebug[39m: fromDirectory
21:32:25 - [34mdebug[39m: fromDirectory
21:32:25 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"a55728e7-3e9e-4956-a6aa-5608e5e7da7a","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
21:32:25 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"a55728e7-3e9e-4956-a6aa-5608e5e7da7a","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
21:32:25 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35ma55728e7-3e9e-4956-a6aa-5608e5e7da7a[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32muncertainPenalty[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
[33m}[39m
21:33:34 - [32minfo[39m: Using current directory as template folder
21:33:34 - [32minfo[39m: Loading a default sample.txt file.
21:33:34 - [34mdebug[39m: fromDirectory
21:33:34 - [34mdebug[39m: fromDirectory
21:33:34 - [34mdebug[39m: fromDirectory
21:33:34 - [34mdebug[39m: fromDirectory
21:33:34 - [34mdebug[39m: fromDirectory
21:33:34 - [34mdebug[39m: fromDirectory
21:33:34 - [34mdebug[39m: fromDirectory
21:33:34 - [34mdebug[39m: constructor
21:33:34 - [34mdebug[39m: constructor
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processDirectory
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: fromDirectory
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: fromDirectory
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:34 - [34mdebug[39m: isFileInNodeModuleDir
21:33:34 - [34mdebug[39m: processFile
21:33:35 - [34mdebug[39m: fromDirectory
21:33:35 - [34mdebug[39m: isFileInNodeModuleDir
21:33:35 - [34mdebug[39m: isFileInNodeModuleDir
21:33:35 - [34mdebug[39m: isFileInNodeModuleDir
21:33:35 - [34mdebug[39m: isFileInNodeModuleDir
21:33:35 - [34mdebug[39m: isFileInNodeModuleDir
21:33:35 - [34mdebug[39m: processDirectory
21:33:35 - [34mdebug[39m: isFileInNodeModuleDir
21:33:35 - [34mdebug[39m: processFile
21:33:35 - [34mdebug[39m: isFileInNodeModuleDir
21:33:35 - [34mdebug[39m: processFile
21:33:35 - [34mdebug[39m: isFileInNodeModuleDir
21:33:35 - [34mdebug[39m: processFile
21:33:35 - [34mdebug[39m: isFileInNodeModuleDir
21:33:35 - [34mdebug[39m: processFile
21:33:35 - [34mdebug[39m: fromDirectory
21:33:35 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 45 character 2]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 45 character 2]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
21:33:35 - [32minfo[39m: undefined
21:39:59 - [32minfo[39m: Loading a default sample.txt file.
21:39:59 - [32minfo[39m: Loading a single default request.json file.
21:39:59 - [32minfo[39m: Loading a default state.json file.
21:39:59 - [34mdebug[39m: fromDirectory
21:39:59 - [34mdebug[39m: fromDirectory
21:39:59 - [34mdebug[39m: fromDirectory
21:39:59 - [34mdebug[39m: fromDirectory
21:39:59 - [34mdebug[39m: fromDirectory
21:39:59 - [34mdebug[39m: fromDirectory
21:39:59 - [34mdebug[39m: fromDirectory
21:39:59 - [34mdebug[39m: constructor
21:39:59 - [34mdebug[39m: constructor
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processDirectory
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: fromDirectory
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: fromDirectory
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: fromDirectory
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processDirectory
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: isFileInNodeModuleDir
21:39:59 - [34mdebug[39m: processFile
21:39:59 - [34mdebug[39m: fromDirectory
21:40:00 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 45 character 2]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 45 character 2]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
21:40:00 - [32minfo[39m: Completed.
21:40:20 - [32minfo[39m: Loading a default sample.txt file.
21:40:20 - [32minfo[39m: Loading a single default request.json file.
21:40:20 - [32minfo[39m: Loading a default state.json file.
21:40:20 - [34mdebug[39m: fromDirectory
21:40:20 - [34mdebug[39m: fromDirectory
21:40:20 - [34mdebug[39m: fromDirectory
21:40:20 - [34mdebug[39m: fromDirectory
21:40:20 - [34mdebug[39m: fromDirectory
21:40:20 - [34mdebug[39m: fromDirectory
21:40:20 - [34mdebug[39m: fromDirectory
21:40:20 - [34mdebug[39m: constructor
21:40:21 - [34mdebug[39m: constructor
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processDirectory
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: fromDirectory
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: fromDirectory
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: fromDirectory
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processDirectory
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: fromDirectory
21:40:21 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



21:40:21 - [34mdebug[39m: fromDirectory
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: isFileInNodeModuleDir
21:40:21 - [34mdebug[39m: processFile
21:40:21 - [34mdebug[39m: fromDirectory
21:40:21 - [34mdebug[39m: buildGrammar
21:40:21 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
21:40:21 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
21:40:21 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
21:40:21 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
21:40:21 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
21:40:21 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
21:40:21 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
21:40:21 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
21:40:22 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
21:40:22 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
21:40:22 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
21:40:22 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
21:40:22 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
21:40:22 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
21:40:22 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
21:40:22 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
21:40:22 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "962b05a8-755a-4465-be10-b9cb3af8d265",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.Uncertainty",
        uncertainty : data[0],
        amount : data[2]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
21:40:22 - [34mdebug[39m: fromDirectory
21:40:22 - [34mdebug[39m: fromDirectory
21:40:22 - [32minfo[39m: Completed.
21:41:15 - [32minfo[39m: Using current directory as template folder
21:41:15 - [32minfo[39m: Loading a default sample.txt file.
21:41:15 - [32minfo[39m: Loading a single default request.json file.
21:41:15 - [32minfo[39m: Loading a default state.json file.
21:41:15 - [34mdebug[39m: fromDirectory
21:41:15 - [34mdebug[39m: fromDirectory
21:41:15 - [34mdebug[39m: fromDirectory
21:41:15 - [34mdebug[39m: fromDirectory
21:41:15 - [34mdebug[39m: fromDirectory
21:41:15 - [34mdebug[39m: fromDirectory
21:41:15 - [34mdebug[39m: fromDirectory
21:41:15 - [34mdebug[39m: constructor
21:41:15 - [34mdebug[39m: constructor
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processDirectory
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: fromDirectory
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: fromDirectory
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: fromDirectory
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processDirectory
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: fromDirectory
21:41:15 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



21:41:15 - [34mdebug[39m: fromDirectory
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:15 - [34mdebug[39m: isFileInNodeModuleDir
21:41:15 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: isFileInNodeModuleDir
21:41:16 - [34mdebug[39m: processFile
21:41:16 - [34mdebug[39m: fromDirectory
21:41:16 - [34mdebug[39m: buildGrammar
21:41:16 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
21:41:16 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
21:41:16 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
21:41:16 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
21:41:16 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
21:41:16 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
21:41:16 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
21:41:16 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
21:41:16 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
21:41:16 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
21:41:16 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
21:41:16 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
21:41:16 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
21:41:16 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
21:41:16 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
21:41:16 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
21:41:16 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "2f2665f5-0c49-4a09-af2e-38add861c259",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.Uncertainty",
        uncertainty : data[0],
        amount : data[2]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
21:41:16 - [34mdebug[39m: fromDirectory
21:41:16 - [34mdebug[39m: fromDirectory
21:41:16 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"2f2665f5-0c49-4a09-af2e-38add861c259","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
21:41:16 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"2f2665f5-0c49-4a09-af2e-38add861c259","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
21:41:16 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
21:41:16 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
21:41:16 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
21:41:16 - [31merror[39m: TypeError: unbrand called on non-object
21:41:16 - [32minfo[39m: undefined
21:41:39 - [32minfo[39m: Using current directory as template folder
21:41:39 - [32minfo[39m: Loading a default sample.txt file.
21:41:39 - [34mdebug[39m: fromDirectory
21:41:39 - [34mdebug[39m: fromDirectory
21:41:39 - [34mdebug[39m: fromDirectory
21:41:39 - [34mdebug[39m: fromDirectory
21:41:39 - [34mdebug[39m: fromDirectory
21:41:39 - [34mdebug[39m: fromDirectory
21:41:39 - [34mdebug[39m: fromDirectory
21:41:39 - [34mdebug[39m: constructor
21:41:39 - [34mdebug[39m: constructor
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processDirectory
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: fromDirectory
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: fromDirectory
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: fromDirectory
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processDirectory
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: fromDirectory
21:41:39 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



21:41:39 - [34mdebug[39m: fromDirectory
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:39 - [34mdebug[39m: isFileInNodeModuleDir
21:41:39 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: isFileInNodeModuleDir
21:41:40 - [34mdebug[39m: processFile
21:41:40 - [34mdebug[39m: fromDirectory
21:41:40 - [34mdebug[39m: buildGrammar
21:41:40 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
21:41:40 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
21:41:40 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
21:41:40 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
21:41:40 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
21:41:40 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
21:41:40 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
21:41:40 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
21:41:40 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
21:41:40 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
21:41:40 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
21:41:40 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
21:41:40 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
21:41:40 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
21:41:40 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
21:41:40 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
21:41:40 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "0573aa9a-8a26-4e3a-b946-3b0e069c5315",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.Uncertainty",
        uncertainty : data[0],
        amount : data[2]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
21:41:40 - [34mdebug[39m: fromDirectory
21:41:40 - [34mdebug[39m: fromDirectory
21:41:40 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"0573aa9a-8a26-4e3a-b946-3b0e069c5315","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
21:41:40 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"0573aa9a-8a26-4e3a-b946-3b0e069c5315","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
21:41:40 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m0573aa9a-8a26-4e3a-b946-3b0e069c5315[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32muncertainPenalty[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
[33m}[39m
21:41:42 - [32minfo[39m: Using current directory as template folder
21:41:42 - [32minfo[39m: Loading a default sample.txt file.
21:41:42 - [32minfo[39m: Loading a single default request.json file.
21:41:42 - [32minfo[39m: Loading a default state.json file.
21:41:42 - [34mdebug[39m: fromDirectory
21:41:42 - [34mdebug[39m: fromDirectory
21:41:42 - [34mdebug[39m: fromDirectory
21:41:42 - [34mdebug[39m: fromDirectory
21:41:42 - [34mdebug[39m: fromDirectory
21:41:42 - [34mdebug[39m: fromDirectory
21:41:42 - [34mdebug[39m: fromDirectory
21:41:42 - [34mdebug[39m: constructor
21:41:42 - [34mdebug[39m: constructor
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processDirectory
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: fromDirectory
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: fromDirectory
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:42 - [34mdebug[39m: isFileInNodeModuleDir
21:41:42 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: fromDirectory
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processDirectory
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: fromDirectory
21:41:43 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped}))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



21:41:43 - [34mdebug[39m: fromDirectory
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: isFileInNodeModuleDir
21:41:43 - [34mdebug[39m: processFile
21:41:43 - [34mdebug[39m: fromDirectory
21:41:43 - [34mdebug[39m: buildGrammar
21:41:43 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
21:41:43 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
21:41:43 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
21:41:43 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
21:41:43 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
21:41:43 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
21:41:43 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
21:41:43 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
21:41:43 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
21:41:43 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
21:41:43 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
21:41:43 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
21:41:43 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
21:41:43 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
21:41:43 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
21:41:43 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
21:41:43 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "c4d08200-cada-48a4-aca6-2dc258dbf311",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        transactionId : data[4],
        timestamp : data[6]
    };
}
%}


Uncertainty -> String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.Uncertainty",
        uncertainty : data[0],
        amount : data[2]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
21:41:43 - [34mdebug[39m: fromDirectory
21:41:43 - [34mdebug[39m: fromDirectory
21:41:43 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"c4d08200-cada-48a4-aca6-2dc258dbf311","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
21:41:43 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"c4d08200-cada-48a4-aca6-2dc258dbf311","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
21:41:43 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
21:41:43 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
21:41:43 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
21:41:43 - [31merror[39m: TypeError: unbrand called on non-object
21:41:43 - [32minfo[39m: undefined
22:13:46 - [32minfo[39m: Using current directory as template folder
22:13:46 - [32minfo[39m: Loading a default sample.txt file.
22:13:46 - [32minfo[39m: Loading a single default request.json file.
22:13:46 - [32minfo[39m: Loading a default state.json file.
22:13:46 - [34mdebug[39m: fromDirectory
22:13:46 - [34mdebug[39m: fromDirectory
22:13:46 - [34mdebug[39m: fromDirectory
22:13:46 - [34mdebug[39m: fromDirectory
22:13:46 - [34mdebug[39m: fromDirectory
22:13:46 - [34mdebug[39m: fromDirectory
22:13:46 - [34mdebug[39m: fromDirectory
22:13:46 - [34mdebug[39m: constructor
22:13:46 - [34mdebug[39m: constructor
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processDirectory
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: fromDirectory
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: fromDirectory
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:46 - [34mdebug[39m: isFileInNodeModuleDir
22:13:46 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: fromDirectory
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processDirectory
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: fromDirectory
22:13:47 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": "test"}, concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": "test"}, concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



22:13:47 - [34mdebug[39m: fromDirectory
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: isFileInNodeModuleDir
22:13:47 - [34mdebug[39m: processFile
22:13:47 - [34mdebug[39m: fromDirectory
22:13:47 - [34mdebug[39m: buildGrammar
22:13:47 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
22:13:47 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
22:13:47 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
22:13:47 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
22:13:47 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
22:13:47 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
22:13:47 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
22:13:47 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
22:13:47 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
22:13:47 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
22:13:47 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
22:13:47 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
22:13:47 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
22:13:47 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
22:13:47 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
22:13:47 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
22:13:47 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "297417a9-14af-4087-a2bf-be997e2cb692",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzySolverModel -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzySolverModel",
        inputVariables : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


FuzzyLinguisticTerm -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
22:13:47 - [34mdebug[39m: fromDirectory
22:13:47 - [34mdebug[39m: fromDirectory
22:13:47 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"297417a9-14af-4087-a2bf-be997e2cb692","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:13:47 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"297417a9-14af-4087-a2bf-be997e2cb692","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:13:47 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
22:13:47 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
22:13:47 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
22:13:47 - [31merror[39m: TypeError: unbrand called on non-object
22:13:47 - [32minfo[39m: undefined
22:16:29 - [32minfo[39m: Using current directory as template folder
22:16:29 - [32minfo[39m: Loading a default sample.txt file.
22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: constructor
22:16:29 - [34mdebug[39m: constructor
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processDirectory
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processDirectory
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": "test"}, concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": "test"}, concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: isFileInNodeModuleDir
22:16:29 - [34mdebug[39m: processFile
22:16:29 - [34mdebug[39m: fromDirectory
22:16:29 - [34mdebug[39m: buildGrammar
22:16:29 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
22:16:29 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
22:16:29 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
22:16:29 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
22:16:29 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
22:16:29 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
22:16:29 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
22:16:29 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
22:16:30 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
22:16:30 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
22:16:30 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
22:16:30 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
22:16:30 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
22:16:30 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
22:16:30 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
22:16:30 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
22:16:30 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "757ce993-0f1f-473e-91c6-5688d324f5bb",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzySolverModel -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzySolverModel",
        inputVariables : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


FuzzyLinguisticTerm -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
22:16:30 - [34mdebug[39m: fromDirectory
22:16:30 - [34mdebug[39m: fromDirectory
22:16:30 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"757ce993-0f1f-473e-91c6-5688d324f5bb","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:16:30 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"757ce993-0f1f-473e-91c6-5688d324f5bb","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:16:30 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m757ce993-0f1f-473e-91c6-5688d324f5bb[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32muncertainPenalty[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
[33m}[39m
22:16:36 - [32minfo[39m: Using current directory as template folder
22:16:36 - [32minfo[39m: Loading a default sample.txt file.
22:16:36 - [32minfo[39m: Loading a single default request.json file.
22:16:36 - [32minfo[39m: Loading a default state.json file.
22:16:36 - [34mdebug[39m: fromDirectory
22:16:36 - [34mdebug[39m: fromDirectory
22:16:36 - [34mdebug[39m: fromDirectory
22:16:36 - [34mdebug[39m: fromDirectory
22:16:36 - [34mdebug[39m: fromDirectory
22:16:36 - [34mdebug[39m: fromDirectory
22:16:36 - [34mdebug[39m: fromDirectory
22:16:36 - [34mdebug[39m: constructor
22:16:36 - [34mdebug[39m: constructor
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processDirectory
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: fromDirectory
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: fromDirectory
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: fromDirectory
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processDirectory
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: isFileInNodeModuleDir
22:16:36 - [34mdebug[39m: processFile
22:16:36 - [34mdebug[39m: fromDirectory
22:16:37 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract_0), "penaltyDuration")), "amount")) * deref(unbrand(vcontract_0), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest_0), "goodsValue"));
          var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract_0), "capPercentage") / 100.0) * deref(unbrand(vrequest_0), "goodsValue"))]);
          var vcapped = Math.min.apply(Math,vp1);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": "test"}, concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract_0), "termination")), "amount")) <= 0))}, {"penalty": vcapped})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vnow = deref(context, "now");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vpenalty = ((((vdiff / deref(unbrand(deref(unbrand(vcontract), "penaltyDuration")), "amount")) * deref(unbrand(vcontract), "penaltyPercentage")) / 100.0) * deref(unbrand(vrequest), "goodsValue"));
        var vp1 = bunion([vpenalty], [((deref(unbrand(vcontract), "capPercentage") / 100.0) * deref(unbrand(vrequest), "goodsValue"))]);
        var vcapped = Math.min.apply(Math,vp1);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": "test"}, concat({"buyerMayTerminate": !((compare(vdiff,deref(unbrand(deref(unbrand(vcontract), "termination")), "amount")) <= 0))}, {"penalty": vcapped})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



22:16:37 - [34mdebug[39m: fromDirectory
22:16:37 - [34mdebug[39m: isFileInNodeModuleDir
22:16:37 - [34mdebug[39m: processFile
22:16:37 - [34mdebug[39m: isFileInNodeModuleDir
22:16:37 - [34mdebug[39m: processFile
22:16:37 - [34mdebug[39m: isFileInNodeModuleDir
22:16:37 - [34mdebug[39m: processFile
22:16:37 - [34mdebug[39m: isFileInNodeModuleDir
22:16:37 - [34mdebug[39m: processFile
22:16:37 - [34mdebug[39m: isFileInNodeModuleDir
22:16:37 - [34mdebug[39m: processFile
22:16:37 - [34mdebug[39m: isFileInNodeModuleDir
22:16:37 - [34mdebug[39m: processFile
22:16:37 - [34mdebug[39m: isFileInNodeModuleDir
22:16:37 - [34mdebug[39m: processFile
22:16:37 - [34mdebug[39m: isFileInNodeModuleDir
22:16:37 - [34mdebug[39m: processFile
22:16:37 - [34mdebug[39m: isFileInNodeModuleDir
22:16:37 - [34mdebug[39m: processFile
22:16:37 - [34mdebug[39m: isFileInNodeModuleDir
22:16:37 - [34mdebug[39m: processFile
22:16:37 - [34mdebug[39m: fromDirectory
22:16:37 - [34mdebug[39m: buildGrammar
22:16:37 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
22:16:37 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
22:16:37 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
22:16:37 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
22:16:37 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
22:16:37 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
22:16:37 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
22:16:37 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
22:16:37 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
22:16:37 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
22:16:37 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
22:16:37 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
22:16:37 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
22:16:37 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
22:16:37 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
22:16:37 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
22:16:37 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "a03ad796-027d-43f2-a02c-0ada4200b3c6",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzySolverModel -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzySolverModel",
        inputVariables : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


FuzzyLinguisticTerm -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
22:16:37 - [34mdebug[39m: fromDirectory
22:16:37 - [34mdebug[39m: fromDirectory
22:16:37 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"a03ad796-027d-43f2-a02c-0ada4200b3c6","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:16:37 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"a03ad796-027d-43f2-a02c-0ada4200b3c6","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:16:37 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
22:16:37 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
22:16:37 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
22:16:37 - [31merror[39m: TypeError: unbrand called on non-object
22:16:37 - [32minfo[39m: undefined
22:18:06 - [32minfo[39m: Using current directory as template folder
22:18:06 - [32minfo[39m: Loading a default sample.txt file.
22:18:06 - [32minfo[39m: Loading a single default request.json file.
22:18:06 - [32minfo[39m: Loading a default state.json file.
22:18:06 - [34mdebug[39m: fromDirectory
22:18:06 - [34mdebug[39m: fromDirectory
22:18:06 - [34mdebug[39m: fromDirectory
22:18:06 - [34mdebug[39m: fromDirectory
22:18:06 - [34mdebug[39m: fromDirectory
22:18:06 - [34mdebug[39m: fromDirectory
22:18:06 - [34mdebug[39m: fromDirectory
22:18:06 - [34mdebug[39m: constructor
22:18:06 - [34mdebug[39m: constructor
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processDirectory
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: fromDirectory
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: fromDirectory
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:06 - [34mdebug[39m: isFileInNodeModuleDir
22:18:06 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: fromDirectory
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processDirectory
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: fromDirectory
22:18:07 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": "test"}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": "test"}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



22:18:07 - [34mdebug[39m: fromDirectory
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: isFileInNodeModuleDir
22:18:07 - [34mdebug[39m: processFile
22:18:07 - [34mdebug[39m: fromDirectory
22:18:07 - [34mdebug[39m: buildGrammar
22:18:07 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
22:18:07 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
22:18:07 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
22:18:07 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
22:18:07 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
22:18:07 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
22:18:07 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
22:18:07 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
22:18:07 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
22:18:07 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
22:18:07 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
22:18:07 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
22:18:07 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
22:18:07 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
22:18:07 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
22:18:07 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
22:18:07 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "f9fa4b71-ff81-47e9-acd1-6f2c9a7f90e2",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzySolverModel -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzySolverModel",
        inputVariables : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


FuzzyLinguisticTerm -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
22:18:07 - [34mdebug[39m: fromDirectory
22:18:07 - [34mdebug[39m: fromDirectory
22:18:07 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"f9fa4b71-ff81-47e9-acd1-6f2c9a7f90e2","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:18:07 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"f9fa4b71-ff81-47e9-acd1-6f2c9a7f90e2","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:18:07 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
22:18:07 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
22:18:07 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
22:18:07 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-93cf4bd11b4577aecc5cba5130cfd9ecdc6ce9ec4d985b62aa5a96ee9945c88a[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mDecember 17, 2017 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[35mtest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35mfbb76873-e909-4ba0-b928-48089979d0bd[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T20:18:07.653Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
22:18:24 - [32minfo[39m: Using current directory as template folder
22:18:24 - [32minfo[39m: Loading a default sample.txt file.
22:18:24 - [32minfo[39m: Loading a single default request.json file.
22:18:24 - [32minfo[39m: Loading a default state.json file.
22:18:24 - [34mdebug[39m: fromDirectory
22:18:24 - [34mdebug[39m: fromDirectory
22:18:24 - [34mdebug[39m: fromDirectory
22:18:24 - [34mdebug[39m: fromDirectory
22:18:24 - [34mdebug[39m: fromDirectory
22:18:24 - [34mdebug[39m: fromDirectory
22:18:24 - [34mdebug[39m: fromDirectory
22:18:24 - [34mdebug[39m: constructor
22:18:24 - [34mdebug[39m: constructor
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processDirectory
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: fromDirectory
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: fromDirectory
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: fromDirectory
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processDirectory
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: isFileInNodeModuleDir
22:18:24 - [34mdebug[39m: processFile
22:18:24 - [34mdebug[39m: fromDirectory
22:18:25 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vdiff}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vdiff}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



22:18:25 - [34mdebug[39m: fromDirectory
22:18:25 - [34mdebug[39m: isFileInNodeModuleDir
22:18:25 - [34mdebug[39m: processFile
22:18:25 - [34mdebug[39m: isFileInNodeModuleDir
22:18:25 - [34mdebug[39m: processFile
22:18:25 - [34mdebug[39m: isFileInNodeModuleDir
22:18:25 - [34mdebug[39m: processFile
22:18:25 - [34mdebug[39m: isFileInNodeModuleDir
22:18:25 - [34mdebug[39m: processFile
22:18:25 - [34mdebug[39m: isFileInNodeModuleDir
22:18:25 - [34mdebug[39m: processFile
22:18:25 - [34mdebug[39m: isFileInNodeModuleDir
22:18:25 - [34mdebug[39m: processFile
22:18:25 - [34mdebug[39m: isFileInNodeModuleDir
22:18:25 - [34mdebug[39m: processFile
22:18:25 - [34mdebug[39m: isFileInNodeModuleDir
22:18:25 - [34mdebug[39m: processFile
22:18:25 - [34mdebug[39m: isFileInNodeModuleDir
22:18:25 - [34mdebug[39m: processFile
22:18:25 - [34mdebug[39m: isFileInNodeModuleDir
22:18:25 - [34mdebug[39m: processFile
22:18:25 - [34mdebug[39m: fromDirectory
22:18:25 - [34mdebug[39m: buildGrammar
22:18:25 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
22:18:25 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
22:18:25 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
22:18:25 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
22:18:25 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
22:18:25 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
22:18:25 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
22:18:25 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
22:18:25 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
22:18:25 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
22:18:25 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
22:18:25 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
22:18:25 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
22:18:25 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
22:18:25 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
22:18:25 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
22:18:25 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "ed55b468-1ccd-43a6-8380-b1fe95973dd2",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzySolverModel -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzySolverModel",
        inputVariables : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


FuzzyLinguisticTerm -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
22:18:25 - [34mdebug[39m: fromDirectory
22:18:25 - [34mdebug[39m: fromDirectory
22:18:25 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"ed55b468-1ccd-43a6-8380-b1fe95973dd2","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:18:25 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"ed55b468-1ccd-43a6-8380-b1fe95973dd2","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:18:25 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
22:18:25 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
22:18:25 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
22:18:25 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-8238483e99c5a2fa6b4e6186ee740bcdc0dcd070317d528ddf3234913a4fcbdd[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mDecember 17, 2017 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[35m203[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m24486e8d-409d-4007-9366-7636f1fd82ad[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T20:18:25.415Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
22:20:03 - [32minfo[39m: Using current directory as template folder
22:20:03 - [32minfo[39m: Loading a default sample.txt file.
22:20:03 - [32minfo[39m: Loading a single default request.json file.
22:20:03 - [32minfo[39m: Loading a default state.json file.
22:20:03 - [34mdebug[39m: fromDirectory
22:20:03 - [34mdebug[39m: fromDirectory
22:20:03 - [34mdebug[39m: fromDirectory
22:20:03 - [34mdebug[39m: fromDirectory
22:20:03 - [34mdebug[39m: fromDirectory
22:20:03 - [34mdebug[39m: fromDirectory
22:20:03 - [34mdebug[39m: fromDirectory
22:20:03 - [34mdebug[39m: constructor
22:20:03 - [34mdebug[39m: constructor
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processDirectory
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: fromDirectory
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: fromDirectory
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:03 - [34mdebug[39m: isFileInNodeModuleDir
22:20:03 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: fromDirectory
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processDirectory
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: fromDirectory
22:20:04 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vdiff}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vdiff}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



22:20:04 - [34mdebug[39m: fromDirectory
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: isFileInNodeModuleDir
22:20:04 - [34mdebug[39m: processFile
22:20:04 - [34mdebug[39m: fromDirectory
22:20:04 - [34mdebug[39m: buildGrammar
22:20:04 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
22:20:04 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
22:20:04 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
22:20:04 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
22:20:04 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
22:20:04 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
22:20:04 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
22:20:04 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
22:20:04 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
22:20:04 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
22:20:04 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
22:20:04 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
22:20:04 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
22:20:04 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
22:20:04 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
22:20:04 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
22:20:04 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "9aaec31d-3ec1-4fd8-b028-8f93fb97a5c0",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzySolverModel -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzySolverModel",
        inputVariables : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


FuzzyLinguisticTerm -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
22:20:04 - [34mdebug[39m: fromDirectory
22:20:04 - [34mdebug[39m: fromDirectory
22:20:04 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"9aaec31d-3ec1-4fd8-b028-8f93fb97a5c0","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:20:04 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"9aaec31d-3ec1-4fd8-b028-8f93fb97a5c0","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:20:04 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
22:20:04 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
22:20:04 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
22:20:04 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-a9e673161601ad5e9eb62d4f9aff05a04e42a2ccdd61fa649a8f423444d16d07[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 7, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[35m1[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m5693ec55-8263-4a37-a89e-c2b51dc802be[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T20:20:04.953Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
22:20:12 - [32minfo[39m: Using current directory as template folder
22:20:12 - [32minfo[39m: Loading a default sample.txt file.
22:20:12 - [32minfo[39m: Loading a single default request.json file.
22:20:12 - [32minfo[39m: Loading a default state.json file.
22:20:12 - [34mdebug[39m: fromDirectory
22:20:12 - [34mdebug[39m: fromDirectory
22:20:12 - [34mdebug[39m: fromDirectory
22:20:12 - [34mdebug[39m: fromDirectory
22:20:12 - [34mdebug[39m: fromDirectory
22:20:12 - [34mdebug[39m: fromDirectory
22:20:12 - [34mdebug[39m: fromDirectory
22:20:12 - [34mdebug[39m: constructor
22:20:12 - [34mdebug[39m: constructor
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processDirectory
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: fromDirectory
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: fromDirectory
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: fromDirectory
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processDirectory
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: isFileInNodeModuleDir
22:20:12 - [34mdebug[39m: processFile
22:20:12 - [34mdebug[39m: fromDirectory
22:20:13 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vdiff}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vdiff}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



22:20:13 - [34mdebug[39m: fromDirectory
22:20:13 - [34mdebug[39m: isFileInNodeModuleDir
22:20:13 - [34mdebug[39m: processFile
22:20:13 - [34mdebug[39m: isFileInNodeModuleDir
22:20:13 - [34mdebug[39m: processFile
22:20:13 - [34mdebug[39m: isFileInNodeModuleDir
22:20:13 - [34mdebug[39m: processFile
22:20:13 - [34mdebug[39m: isFileInNodeModuleDir
22:20:13 - [34mdebug[39m: processFile
22:20:13 - [34mdebug[39m: isFileInNodeModuleDir
22:20:13 - [34mdebug[39m: processFile
22:20:13 - [34mdebug[39m: isFileInNodeModuleDir
22:20:13 - [34mdebug[39m: processFile
22:20:13 - [34mdebug[39m: isFileInNodeModuleDir
22:20:13 - [34mdebug[39m: processFile
22:20:13 - [34mdebug[39m: isFileInNodeModuleDir
22:20:13 - [34mdebug[39m: processFile
22:20:13 - [34mdebug[39m: isFileInNodeModuleDir
22:20:13 - [34mdebug[39m: processFile
22:20:13 - [34mdebug[39m: isFileInNodeModuleDir
22:20:13 - [34mdebug[39m: processFile
22:20:13 - [34mdebug[39m: fromDirectory
22:20:13 - [34mdebug[39m: buildGrammar
22:20:13 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
22:20:13 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
22:20:13 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
22:20:13 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
22:20:13 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
22:20:13 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
22:20:13 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
22:20:13 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
22:20:13 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
22:20:13 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
22:20:13 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
22:20:13 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
22:20:13 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
22:20:13 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
22:20:13 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
22:20:13 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
22:20:13 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "a7d274e6-5064-4bda-8f06-e2b5c6a6b735",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzySolverModel -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzySolverModel",
        inputVariables : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


FuzzyLinguisticTerm -> String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transactionId : data[8],
        timestamp : data[10]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
22:20:13 - [34mdebug[39m: fromDirectory
22:20:13 - [34mdebug[39m: fromDirectory
22:20:13 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"a7d274e6-5064-4bda-8f06-e2b5c6a6b735","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:20:13 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"a7d274e6-5064-4bda-8f06-e2b5c6a6b735","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:20:13 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
22:20:13 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
22:20:13 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
22:20:13 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-8b7fb6ee69248a8b3cf187e0d3c85720677e1f5161d1f8a774763f000f5f6a4e[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[35m2[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m43d3c6a7-9921-4ec6-a9fb-9394b21fb8da[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T20:20:13.303Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
00:30:47 - [32minfo[39m: Using current directory as template folder
00:30:48 - [32minfo[39m: Loading a default sample.txt file.
00:30:48 - [32minfo[39m: Loading a single default request.json file.
00:30:48 - [32minfo[39m: Loading a default state.json file.
00:30:48 - [34mdebug[39m: fromDirectory
00:30:48 - [34mdebug[39m: fromDirectory
00:30:48 - [34mdebug[39m: fromDirectory
00:30:48 - [34mdebug[39m: fromDirectory
00:30:48 - [34mdebug[39m: fromDirectory
00:30:48 - [34mdebug[39m: fromDirectory
00:30:48 - [34mdebug[39m: fromDirectory
00:30:48 - [34mdebug[39m: constructor
00:30:48 - [34mdebug[39m: constructor
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processDirectory
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: fromDirectory
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: fromDirectory
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: fromDirectory
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processDirectory
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: isFileInNodeModuleDir
00:30:48 - [34mdebug[39m: processFile
00:30:48 - [34mdebug[39m: fromDirectory
00:30:48 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 33 character 44]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 33 character 44]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:30:48 - [32minfo[39m: undefined
00:32:49 - [32minfo[39m: Using current directory as template folder
00:32:49 - [32minfo[39m: Loading a default sample.txt file.
00:32:49 - [32minfo[39m: Loading a single default request.json file.
00:32:49 - [32minfo[39m: Loading a default state.json file.
00:32:49 - [34mdebug[39m: fromDirectory
00:32:49 - [34mdebug[39m: fromDirectory
00:32:49 - [34mdebug[39m: fromDirectory
00:32:49 - [34mdebug[39m: fromDirectory
00:32:49 - [34mdebug[39m: fromDirectory
00:32:49 - [34mdebug[39m: fromDirectory
00:32:49 - [34mdebug[39m: fromDirectory
00:32:49 - [34mdebug[39m: constructor
00:32:49 - [34mdebug[39m: constructor
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processDirectory
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: fromDirectory
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: fromDirectory
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:49 - [34mdebug[39m: isFileInNodeModuleDir
00:32:49 - [34mdebug[39m: processFile
00:32:50 - [34mdebug[39m: fromDirectory
00:32:50 - [34mdebug[39m: isFileInNodeModuleDir
00:32:50 - [34mdebug[39m: isFileInNodeModuleDir
00:32:50 - [34mdebug[39m: isFileInNodeModuleDir
00:32:50 - [34mdebug[39m: isFileInNodeModuleDir
00:32:50 - [34mdebug[39m: isFileInNodeModuleDir
00:32:50 - [34mdebug[39m: processDirectory
00:32:50 - [34mdebug[39m: isFileInNodeModuleDir
00:32:50 - [34mdebug[39m: processFile
00:32:50 - [34mdebug[39m: isFileInNodeModuleDir
00:32:50 - [34mdebug[39m: processFile
00:32:50 - [34mdebug[39m: isFileInNodeModuleDir
00:32:50 - [34mdebug[39m: processFile
00:32:50 - [34mdebug[39m: isFileInNodeModuleDir
00:32:50 - [34mdebug[39m: processFile
00:32:50 - [34mdebug[39m: fromDirectory
00:32:50 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 33 character 44]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 33 character 44]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:32:50 - [32minfo[39m: undefined
00:36:27 - [32minfo[39m: Using current directory as template folder
00:36:27 - [32minfo[39m: Loading a default sample.txt file.
00:36:27 - [32minfo[39m: Loading a single default request.json file.
00:36:27 - [32minfo[39m: Loading a default state.json file.
00:36:27 - [34mdebug[39m: fromDirectory
00:36:27 - [34mdebug[39m: fromDirectory
00:36:27 - [34mdebug[39m: fromDirectory
00:36:27 - [34mdebug[39m: fromDirectory
00:36:27 - [34mdebug[39m: fromDirectory
00:36:27 - [34mdebug[39m: fromDirectory
00:36:27 - [34mdebug[39m: fromDirectory
00:36:27 - [34mdebug[39m: constructor
00:36:27 - [34mdebug[39m: constructor
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processDirectory
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: fromDirectory
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: fromDirectory
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:27 - [34mdebug[39m: isFileInNodeModuleDir
00:36:27 - [34mdebug[39m: processFile
00:36:28 - [34mdebug[39m: fromDirectory
00:36:28 - [34mdebug[39m: isFileInNodeModuleDir
00:36:28 - [34mdebug[39m: isFileInNodeModuleDir
00:36:28 - [34mdebug[39m: isFileInNodeModuleDir
00:36:28 - [34mdebug[39m: isFileInNodeModuleDir
00:36:28 - [34mdebug[39m: isFileInNodeModuleDir
00:36:28 - [34mdebug[39m: processDirectory
00:36:28 - [34mdebug[39m: isFileInNodeModuleDir
00:36:28 - [34mdebug[39m: processFile
00:36:28 - [34mdebug[39m: isFileInNodeModuleDir
00:36:28 - [34mdebug[39m: processFile
00:36:28 - [34mdebug[39m: isFileInNodeModuleDir
00:36:28 - [34mdebug[39m: processFile
00:36:28 - [34mdebug[39m: isFileInNodeModuleDir
00:36:28 - [34mdebug[39m: processFile
00:36:28 - [34mdebug[39m: fromDirectory
00:36:28 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 33 character 44]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 33 character 44]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:36:28 - [32minfo[39m: undefined
00:37:38 - [32minfo[39m: Using current directory as template folder
00:37:38 - [32minfo[39m: Loading a default sample.txt file.
00:37:38 - [32minfo[39m: Loading a single default request.json file.
00:37:38 - [32minfo[39m: Loading a default state.json file.
00:37:38 - [34mdebug[39m: fromDirectory
00:37:38 - [34mdebug[39m: fromDirectory
00:37:38 - [34mdebug[39m: fromDirectory
00:37:38 - [34mdebug[39m: fromDirectory
00:37:38 - [34mdebug[39m: fromDirectory
00:37:38 - [34mdebug[39m: fromDirectory
00:37:38 - [34mdebug[39m: fromDirectory
00:37:38 - [34mdebug[39m: constructor
00:37:38 - [34mdebug[39m: constructor
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processDirectory
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: fromDirectory
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: fromDirectory
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:38 - [34mdebug[39m: isFileInNodeModuleDir
00:37:38 - [34mdebug[39m: processFile
00:37:39 - [34mdebug[39m: fromDirectory
00:37:39 - [34mdebug[39m: isFileInNodeModuleDir
00:37:39 - [34mdebug[39m: isFileInNodeModuleDir
00:37:39 - [34mdebug[39m: isFileInNodeModuleDir
00:37:39 - [34mdebug[39m: isFileInNodeModuleDir
00:37:39 - [34mdebug[39m: isFileInNodeModuleDir
00:37:39 - [34mdebug[39m: processDirectory
00:37:39 - [34mdebug[39m: isFileInNodeModuleDir
00:37:39 - [34mdebug[39m: processFile
00:37:39 - [34mdebug[39m: isFileInNodeModuleDir
00:37:39 - [34mdebug[39m: processFile
00:37:39 - [34mdebug[39m: isFileInNodeModuleDir
00:37:39 - [34mdebug[39m: processFile
00:37:39 - [34mdebug[39m: isFileInNodeModuleDir
00:37:39 - [34mdebug[39m: processFile
00:37:39 - [34mdebug[39m: fromDirectory
00:37:39 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 33 character 44]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 33 character 44]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:37:39 - [32minfo[39m: undefined
00:38:13 - [32minfo[39m: Using current directory as template folder
00:38:13 - [32minfo[39m: Loading a default sample.txt file.
00:38:13 - [32minfo[39m: Loading a single default request.json file.
00:38:13 - [32minfo[39m: Loading a default state.json file.
00:38:13 - [34mdebug[39m: fromDirectory
00:38:13 - [34mdebug[39m: fromDirectory
00:38:13 - [34mdebug[39m: fromDirectory
00:38:13 - [34mdebug[39m: fromDirectory
00:38:13 - [34mdebug[39m: fromDirectory
00:38:13 - [34mdebug[39m: fromDirectory
00:38:13 - [34mdebug[39m: fromDirectory
00:38:13 - [34mdebug[39m: constructor
00:38:13 - [34mdebug[39m: constructor
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processDirectory
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: fromDirectory
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: fromDirectory
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: fromDirectory
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processDirectory
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: isFileInNodeModuleDir
00:38:13 - [34mdebug[39m: processFile
00:38:13 - [34mdebug[39m: fromDirectory
00:38:13 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 33 character 44]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 33 character 44]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:38:13 - [32minfo[39m: undefined
00:40:57 - [32minfo[39m: Using current directory as template folder
00:40:57 - [32minfo[39m: Loading a default sample.txt file.
00:40:57 - [34mdebug[39m: fromDirectory
00:40:57 - [34mdebug[39m: fromDirectory
00:40:57 - [34mdebug[39m: fromDirectory
00:40:57 - [34mdebug[39m: fromDirectory
00:40:57 - [34mdebug[39m: fromDirectory
00:40:57 - [34mdebug[39m: fromDirectory
00:40:57 - [34mdebug[39m: fromDirectory
00:40:57 - [34mdebug[39m: constructor
00:40:57 - [34mdebug[39m: constructor
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processDirectory
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: fromDirectory
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: fromDirectory
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: fromDirectory
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processDirectory
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: isFileInNodeModuleDir
00:40:57 - [34mdebug[39m: processFile
00:40:57 - [34mdebug[39m: fromDirectory
00:40:57 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 33 character 44]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 33 character 44]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:40:57 - [32minfo[39m: undefined
00:41:10 - [32minfo[39m: Using current directory as template folder
00:41:10 - [32minfo[39m: Loading a default sample.txt file.
00:41:10 - [34mdebug[39m: fromDirectory
00:41:10 - [34mdebug[39m: fromDirectory
00:41:10 - [34mdebug[39m: fromDirectory
00:41:10 - [34mdebug[39m: fromDirectory
00:41:10 - [34mdebug[39m: fromDirectory
00:41:10 - [34mdebug[39m: fromDirectory
00:41:10 - [34mdebug[39m: fromDirectory
00:41:10 - [34mdebug[39m: constructor
00:41:10 - [34mdebug[39m: constructor
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processDirectory
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: fromDirectory
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: fromDirectory
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: fromDirectory
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processDirectory
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: isFileInNodeModuleDir
00:41:10 - [34mdebug[39m: processFile
00:41:10 - [34mdebug[39m: fromDirectory
00:41:11 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vdiff}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vdiff}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



00:41:11 - [34mdebug[39m: fromDirectory
00:41:11 - [34mdebug[39m: isFileInNodeModuleDir
00:41:11 - [34mdebug[39m: processFile
00:41:11 - [34mdebug[39m: isFileInNodeModuleDir
00:41:11 - [34mdebug[39m: processFile
00:41:11 - [34mdebug[39m: isFileInNodeModuleDir
00:41:11 - [34mdebug[39m: processFile
00:41:11 - [34mdebug[39m: isFileInNodeModuleDir
00:41:11 - [34mdebug[39m: processFile
00:41:11 - [34mdebug[39m: isFileInNodeModuleDir
00:41:11 - [34mdebug[39m: processFile
00:41:11 - [34mdebug[39m: isFileInNodeModuleDir
00:41:11 - [34mdebug[39m: processFile
00:41:11 - [34mdebug[39m: isFileInNodeModuleDir
00:41:11 - [34mdebug[39m: processFile
00:41:11 - [34mdebug[39m: isFileInNodeModuleDir
00:41:11 - [34mdebug[39m: processFile
00:41:11 - [34mdebug[39m: isFileInNodeModuleDir
00:41:11 - [34mdebug[39m: processFile
00:41:11 - [34mdebug[39m: isFileInNodeModuleDir
00:41:11 - [34mdebug[39m: processFile
00:41:11 - [34mdebug[39m: fromDirectory
00:41:11 - [34mdebug[39m: buildGrammar
00:41:11 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
00:41:11 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
00:41:11 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
00:41:11 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
00:41:11 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
00:41:11 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
00:41:11 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
00:41:11 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
00:41:11 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
00:41:11 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
00:41:11 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
00:41:11 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
00:41:11 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
00:41:11 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
00:41:11 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
00:41:11 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
00:41:11 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "e370ed03-ba83-41b7-8e89-181feb6f3b4d",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


FuzzyModel -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyModel",
        name : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
00:41:11 - [34mdebug[39m: fromDirectory
00:41:11 - [34mdebug[39m: fromDirectory
00:41:11 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"e370ed03-ba83-41b7-8e89-181feb6f3b4d","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:41:11 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"e370ed03-ba83-41b7-8e89-181feb6f3b4d","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:41:11 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35me370ed03-ba83-41b7-8e89-181feb6f3b4d[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32muncertainPenalty[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
[33m}[39m
00:41:33 - [32minfo[39m: Using current directory as template folder
00:41:33 - [32minfo[39m: Loading a default sample.txt file.
00:41:33 - [34mdebug[39m: fromDirectory
00:41:33 - [34mdebug[39m: fromDirectory
00:41:33 - [34mdebug[39m: fromDirectory
00:41:33 - [34mdebug[39m: fromDirectory
00:41:33 - [34mdebug[39m: fromDirectory
00:41:33 - [34mdebug[39m: fromDirectory
00:41:33 - [34mdebug[39m: fromDirectory
00:41:33 - [34mdebug[39m: constructor
00:41:33 - [34mdebug[39m: constructor
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processDirectory
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: fromDirectory
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: fromDirectory
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:33 - [34mdebug[39m: isFileInNodeModuleDir
00:41:33 - [34mdebug[39m: processFile
00:41:34 - [34mdebug[39m: fromDirectory
00:41:34 - [34mdebug[39m: isFileInNodeModuleDir
00:41:34 - [34mdebug[39m: isFileInNodeModuleDir
00:41:34 - [34mdebug[39m: isFileInNodeModuleDir
00:41:34 - [34mdebug[39m: isFileInNodeModuleDir
00:41:34 - [34mdebug[39m: isFileInNodeModuleDir
00:41:34 - [34mdebug[39m: processDirectory
00:41:34 - [34mdebug[39m: isFileInNodeModuleDir
00:41:34 - [34mdebug[39m: processFile
00:41:34 - [34mdebug[39m: isFileInNodeModuleDir
00:41:34 - [34mdebug[39m: processFile
00:41:34 - [34mdebug[39m: isFileInNodeModuleDir
00:41:34 - [34mdebug[39m: processFile
00:41:34 - [34mdebug[39m: isFileInNodeModuleDir
00:41:34 - [34mdebug[39m: processFile
00:41:34 - [34mdebug[39m: fromDirectory
00:41:34 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 45 character 4]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 45 character 4]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:41:34 - [32minfo[39m: undefined
00:42:40 - [32minfo[39m: Using current directory as template folder
00:42:40 - [32minfo[39m: Loading a default sample.txt file.
00:42:40 - [34mdebug[39m: fromDirectory
00:42:40 - [34mdebug[39m: fromDirectory
00:42:40 - [34mdebug[39m: fromDirectory
00:42:40 - [34mdebug[39m: fromDirectory
00:42:40 - [34mdebug[39m: fromDirectory
00:42:40 - [34mdebug[39m: fromDirectory
00:42:40 - [34mdebug[39m: fromDirectory
00:42:40 - [34mdebug[39m: constructor
00:42:40 - [34mdebug[39m: constructor
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processDirectory
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: fromDirectory
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: fromDirectory
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:40 - [34mdebug[39m: isFileInNodeModuleDir
00:42:40 - [34mdebug[39m: processFile
00:42:41 - [34mdebug[39m: fromDirectory
00:42:41 - [34mdebug[39m: isFileInNodeModuleDir
00:42:41 - [34mdebug[39m: isFileInNodeModuleDir
00:42:41 - [34mdebug[39m: isFileInNodeModuleDir
00:42:41 - [34mdebug[39m: isFileInNodeModuleDir
00:42:41 - [34mdebug[39m: isFileInNodeModuleDir
00:42:41 - [34mdebug[39m: processDirectory
00:42:41 - [34mdebug[39m: isFileInNodeModuleDir
00:42:41 - [34mdebug[39m: processFile
00:42:41 - [34mdebug[39m: isFileInNodeModuleDir
00:42:41 - [34mdebug[39m: processFile
00:42:41 - [34mdebug[39m: isFileInNodeModuleDir
00:42:41 - [34mdebug[39m: processFile
00:42:41 - [34mdebug[39m: isFileInNodeModuleDir
00:42:41 - [34mdebug[39m: processFile
00:42:41 - [34mdebug[39m: fromDirectory
00:42:41 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 46 character 4]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 46 character 4]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:42:41 - [32minfo[39m: undefined
00:42:58 - [32minfo[39m: Using current directory as template folder
00:42:58 - [32minfo[39m: Loading a default sample.txt file.
00:42:58 - [32minfo[39m: Loading a single default request.json file.
00:42:58 - [32minfo[39m: Loading a default state.json file.
00:42:58 - [34mdebug[39m: fromDirectory
00:42:58 - [34mdebug[39m: fromDirectory
00:42:58 - [34mdebug[39m: fromDirectory
00:42:58 - [34mdebug[39m: fromDirectory
00:42:58 - [34mdebug[39m: fromDirectory
00:42:58 - [34mdebug[39m: fromDirectory
00:42:58 - [34mdebug[39m: fromDirectory
00:42:58 - [34mdebug[39m: constructor
00:42:58 - [34mdebug[39m: constructor
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processDirectory
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: fromDirectory
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: fromDirectory
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: fromDirectory
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processDirectory
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: isFileInNodeModuleDir
00:42:58 - [34mdebug[39m: processFile
00:42:58 - [34mdebug[39m: fromDirectory
00:42:58 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 46 character 4]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 46 character 4]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:42:58 - [32minfo[39m: undefined
00:43:17 - [32minfo[39m: Using current directory as template folder
00:43:17 - [32minfo[39m: Loading a default sample.txt file.
00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: constructor
00:43:17 - [34mdebug[39m: constructor
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processDirectory
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processDirectory
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vdiff}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vdiff}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: isFileInNodeModuleDir
00:43:17 - [34mdebug[39m: processFile
00:43:17 - [34mdebug[39m: fromDirectory
00:43:17 - [34mdebug[39m: buildGrammar
00:43:17 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
00:43:17 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
00:43:17 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
00:43:17 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
00:43:17 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
00:43:17 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
00:43:17 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
00:43:17 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
00:43:18 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
00:43:18 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
00:43:18 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
00:43:18 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
00:43:18 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
00:43:18 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
00:43:18 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
00:43:18 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
00:43:18 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "60155fe0-eb1f-4533-85bd-630ee35a9732",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


FuzzyModel -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyModel",
        name : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
00:43:18 - [34mdebug[39m: fromDirectory
00:43:18 - [34mdebug[39m: fromDirectory
00:43:18 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"60155fe0-eb1f-4533-85bd-630ee35a9732","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:43:18 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"60155fe0-eb1f-4533-85bd-630ee35a9732","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:43:18 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m60155fe0-eb1f-4533-85bd-630ee35a9732[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32muncertainPenalty[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
[33m}[39m
00:44:08 - [32minfo[39m: Using current directory as template folder
00:44:08 - [32minfo[39m: Loading a default sample.txt file.
00:44:08 - [34mdebug[39m: fromDirectory
00:44:08 - [34mdebug[39m: fromDirectory
00:44:08 - [34mdebug[39m: fromDirectory
00:44:08 - [34mdebug[39m: fromDirectory
00:44:08 - [34mdebug[39m: fromDirectory
00:44:08 - [34mdebug[39m: fromDirectory
00:44:08 - [34mdebug[39m: fromDirectory
00:44:08 - [34mdebug[39m: constructor
00:44:08 - [34mdebug[39m: constructor
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processDirectory
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: fromDirectory
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: fromDirectory
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:08 - [34mdebug[39m: isFileInNodeModuleDir
00:44:08 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: fromDirectory
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processDirectory
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: fromDirectory
00:44:09 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],{"name": "joh"});
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vdiff}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],{"name": "joh"});
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vdiff}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



00:44:09 - [34mdebug[39m: fromDirectory
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: isFileInNodeModuleDir
00:44:09 - [34mdebug[39m: processFile
00:44:09 - [34mdebug[39m: fromDirectory
00:44:09 - [34mdebug[39m: buildGrammar
00:44:09 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
00:44:09 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
00:44:09 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
00:44:09 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
00:44:09 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
00:44:09 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
00:44:09 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
00:44:09 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
00:44:09 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
00:44:09 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
00:44:09 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
00:44:09 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
00:44:09 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
00:44:09 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
00:44:09 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
00:44:09 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
00:44:09 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "5b8d1b8f-3303-4bbc-95ea-5e816f3318af",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


FuzzyModel -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyModel",
        name : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
00:44:09 - [34mdebug[39m: fromDirectory
00:44:09 - [34mdebug[39m: fromDirectory
00:44:09 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"5b8d1b8f-3303-4bbc-95ea-5e816f3318af","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:44:09 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"5b8d1b8f-3303-4bbc-95ea-5e816f3318af","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:44:09 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m5b8d1b8f-3303-4bbc-95ea-5e816f3318af[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32muncertainPenalty[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
[33m}[39m
00:44:20 - [32minfo[39m: Using current directory as template folder
00:44:20 - [32minfo[39m: Loading a default sample.txt file.
00:44:20 - [34mdebug[39m: fromDirectory
00:44:20 - [34mdebug[39m: fromDirectory
00:44:20 - [34mdebug[39m: fromDirectory
00:44:20 - [34mdebug[39m: fromDirectory
00:44:20 - [34mdebug[39m: fromDirectory
00:44:20 - [34mdebug[39m: fromDirectory
00:44:20 - [34mdebug[39m: fromDirectory
00:44:20 - [34mdebug[39m: constructor
00:44:20 - [34mdebug[39m: constructor
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processDirectory
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: fromDirectory
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: fromDirectory
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:20 - [34mdebug[39m: isFileInNodeModuleDir
00:44:20 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: fromDirectory
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processDirectory
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: fromDirectory
00:44:21 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],{"name": "joh"});
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vfuzzyModel}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],{"name": "joh"});
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vfuzzyModel}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



00:44:21 - [34mdebug[39m: fromDirectory
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: isFileInNodeModuleDir
00:44:21 - [34mdebug[39m: processFile
00:44:21 - [34mdebug[39m: fromDirectory
00:44:21 - [34mdebug[39m: buildGrammar
00:44:21 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
00:44:21 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
00:44:21 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
00:44:21 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
00:44:21 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
00:44:21 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
00:44:21 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
00:44:21 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
00:44:21 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
00:44:21 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
00:44:21 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
00:44:21 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
00:44:21 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
00:44:21 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
00:44:21 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
00:44:21 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
00:44:21 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "b763ac78-0740-4c89-8c65-3852655f71d2",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


FuzzyModel -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyModel",
        name : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
00:44:21 - [34mdebug[39m: fromDirectory
00:44:21 - [34mdebug[39m: fromDirectory
00:44:21 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"b763ac78-0740-4c89-8c65-3852655f71d2","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:44:21 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"b763ac78-0740-4c89-8c65-3852655f71d2","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:44:21 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35mb763ac78-0740-4c89-8c65-3852655f71d2[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32muncertainPenalty[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
[33m}[39m
00:44:26 - [32minfo[39m: Using current directory as template folder
00:44:26 - [32minfo[39m: Loading a default sample.txt file.
00:44:26 - [32minfo[39m: Loading a single default request.json file.
00:44:26 - [32minfo[39m: Loading a default state.json file.
00:44:26 - [34mdebug[39m: fromDirectory
00:44:26 - [34mdebug[39m: fromDirectory
00:44:26 - [34mdebug[39m: fromDirectory
00:44:26 - [34mdebug[39m: fromDirectory
00:44:26 - [34mdebug[39m: fromDirectory
00:44:26 - [34mdebug[39m: fromDirectory
00:44:26 - [34mdebug[39m: fromDirectory
00:44:26 - [34mdebug[39m: constructor
00:44:26 - [34mdebug[39m: constructor
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processDirectory
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: fromDirectory
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: fromDirectory
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:26 - [34mdebug[39m: isFileInNodeModuleDir
00:44:26 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: fromDirectory
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processDirectory
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: fromDirectory
00:44:27 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],{"name": "joh"});
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vfuzzyModel}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],{"name": "joh"});
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": vfuzzyModel}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



00:44:27 - [34mdebug[39m: fromDirectory
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: isFileInNodeModuleDir
00:44:27 - [34mdebug[39m: processFile
00:44:27 - [34mdebug[39m: fromDirectory
00:44:27 - [34mdebug[39m: buildGrammar
00:44:27 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
00:44:27 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
00:44:27 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
00:44:27 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
00:44:27 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
00:44:27 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
00:44:27 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
00:44:27 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
00:44:27 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
00:44:27 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
00:44:27 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
00:44:27 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
00:44:27 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
00:44:27 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
00:44:27 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
00:44:27 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
00:44:27 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "667673d8-902a-4d32-8134-b1bbdb3afb15",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


FuzzyModel -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyModel",
        name : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
00:44:27 - [34mdebug[39m: fromDirectory
00:44:27 - [34mdebug[39m: fromDirectory
00:44:27 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"667673d8-902a-4d32-8134-b1bbdb3afb15","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:44:27 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"667673d8-902a-4d32-8134-b1bbdb3afb15","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:44:27 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
00:44:27 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
00:44:27 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
00:44:27 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-274c2bd9cde30d047f2d8bf7098bc6e5ac9003938d0e13caed05ceecd6bbf32d[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[35m[object Object][39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m56c42b97-3e03-4036-9d2c-c7d07acdcee2[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T22:44:27.665Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
00:44:40 - [32minfo[39m: Using current directory as template folder
00:44:40 - [32minfo[39m: Loading a default sample.txt file.
00:44:40 - [32minfo[39m: Loading a single default request.json file.
00:44:40 - [32minfo[39m: Loading a default state.json file.
00:44:40 - [34mdebug[39m: fromDirectory
00:44:40 - [34mdebug[39m: fromDirectory
00:44:40 - [34mdebug[39m: fromDirectory
00:44:40 - [34mdebug[39m: fromDirectory
00:44:40 - [34mdebug[39m: fromDirectory
00:44:40 - [34mdebug[39m: fromDirectory
00:44:40 - [34mdebug[39m: fromDirectory
00:44:40 - [34mdebug[39m: constructor
00:44:40 - [34mdebug[39m: constructor
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processDirectory
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: fromDirectory
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: fromDirectory
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:40 - [34mdebug[39m: isFileInNodeModuleDir
00:44:40 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: fromDirectory
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processDirectory
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: fromDirectory
00:44:41 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],{"name": "joh"});
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(vfuzzyModel), "name")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],{"name": "joh"});
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(vfuzzyModel), "name")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



00:44:41 - [34mdebug[39m: fromDirectory
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: isFileInNodeModuleDir
00:44:41 - [34mdebug[39m: processFile
00:44:41 - [34mdebug[39m: fromDirectory
00:44:41 - [34mdebug[39m: buildGrammar
00:44:41 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
00:44:41 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
00:44:41 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
00:44:41 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
00:44:41 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
00:44:41 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
00:44:41 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
00:44:41 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
00:44:41 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
00:44:41 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
00:44:41 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
00:44:41 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
00:44:41 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
00:44:41 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
00:44:41 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
00:44:41 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
00:44:41 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "d6f1db84-1c44-46d1-b132-71af6776db69",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


FuzzyModel -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyModel",
        name : data[0]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
00:44:41 - [34mdebug[39m: fromDirectory
00:44:41 - [34mdebug[39m: fromDirectory
00:44:41 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"d6f1db84-1c44-46d1-b132-71af6776db69","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:44:41 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"d6f1db84-1c44-46d1-b132-71af6776db69","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:44:41 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
00:44:41 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
00:44:41 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
00:44:41 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-03090cb400d7084558f04e172297c1bb5a276c0f9addfb2b7437e63655ba468f[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[35mjoh[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35mcb3dbf9e-8ebd-4f9e-baa9-ddccc8a23f43[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T22:44:41.951Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
00:45:20 - [32minfo[39m: Using current directory as template folder
00:45:20 - [32minfo[39m: Loading a default sample.txt file.
00:45:20 - [32minfo[39m: Loading a single default request.json file.
00:45:20 - [32minfo[39m: Loading a default state.json file.
00:45:20 - [34mdebug[39m: fromDirectory
00:45:20 - [34mdebug[39m: fromDirectory
00:45:20 - [34mdebug[39m: fromDirectory
00:45:20 - [34mdebug[39m: fromDirectory
00:45:20 - [34mdebug[39m: fromDirectory
00:45:20 - [34mdebug[39m: fromDirectory
00:45:20 - [34mdebug[39m: fromDirectory
00:45:20 - [34mdebug[39m: constructor
00:45:20 - [34mdebug[39m: constructor
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processDirectory
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: fromDirectory
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: fromDirectory
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: fromDirectory
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processDirectory
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: isFileInNodeModuleDir
00:45:20 - [34mdebug[39m: processFile
00:45:20 - [34mdebug[39m: fromDirectory
00:45:20 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 34 character 46]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 34 character 46]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:45:20 - [32minfo[39m: undefined
00:45:31 - [32minfo[39m: Using current directory as template folder
00:45:31 - [32minfo[39m: Loading a default sample.txt file.
00:45:31 - [32minfo[39m: Loading a single default request.json file.
00:45:31 - [32minfo[39m: Loading a default state.json file.
00:45:31 - [34mdebug[39m: fromDirectory
00:45:31 - [34mdebug[39m: fromDirectory
00:45:31 - [34mdebug[39m: fromDirectory
00:45:31 - [34mdebug[39m: fromDirectory
00:45:31 - [34mdebug[39m: fromDirectory
00:45:31 - [34mdebug[39m: fromDirectory
00:45:31 - [34mdebug[39m: fromDirectory
00:45:31 - [34mdebug[39m: constructor
00:45:31 - [34mdebug[39m: constructor
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processDirectory
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: fromDirectory
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: fromDirectory
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:31 - [34mdebug[39m: isFileInNodeModuleDir
00:45:31 - [34mdebug[39m: processFile
00:45:32 - [34mdebug[39m: fromDirectory
00:45:32 - [34mdebug[39m: isFileInNodeModuleDir
00:45:32 - [34mdebug[39m: isFileInNodeModuleDir
00:45:32 - [34mdebug[39m: isFileInNodeModuleDir
00:45:32 - [34mdebug[39m: isFileInNodeModuleDir
00:45:32 - [34mdebug[39m: isFileInNodeModuleDir
00:45:32 - [34mdebug[39m: processDirectory
00:45:32 - [34mdebug[39m: isFileInNodeModuleDir
00:45:32 - [34mdebug[39m: processFile
00:45:32 - [34mdebug[39m: isFileInNodeModuleDir
00:45:32 - [34mdebug[39m: processFile
00:45:32 - [34mdebug[39m: isFileInNodeModuleDir
00:45:32 - [34mdebug[39m: processFile
00:45:32 - [34mdebug[39m: isFileInNodeModuleDir
00:45:32 - [34mdebug[39m: processFile
00:45:32 - [34mdebug[39m: fromDirectory
00:45:32 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 35 character 6]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 35 character 6]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:45:32 - [32minfo[39m: undefined
00:45:42 - [32minfo[39m: Using current directory as template folder
00:45:42 - [32minfo[39m: Loading a default sample.txt file.
00:45:42 - [32minfo[39m: Loading a single default request.json file.
00:45:42 - [32minfo[39m: Loading a default state.json file.
00:45:42 - [34mdebug[39m: fromDirectory
00:45:42 - [34mdebug[39m: fromDirectory
00:45:42 - [34mdebug[39m: fromDirectory
00:45:42 - [34mdebug[39m: fromDirectory
00:45:42 - [34mdebug[39m: fromDirectory
00:45:42 - [34mdebug[39m: fromDirectory
00:45:42 - [34mdebug[39m: fromDirectory
00:45:42 - [34mdebug[39m: constructor
00:45:42 - [34mdebug[39m: constructor
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processDirectory
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: fromDirectory
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: fromDirectory
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:42 - [34mdebug[39m: isFileInNodeModuleDir
00:45:42 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: fromDirectory
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processDirectory
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: fromDirectory
00:45:43 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": []}, {"inputVariables": []}));
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(vfuzzyModel), "name")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": []}, {"inputVariables": []}));
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(vfuzzyModel), "name")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



00:45:43 - [34mdebug[39m: fromDirectory
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: isFileInNodeModuleDir
00:45:43 - [34mdebug[39m: processFile
00:45:43 - [34mdebug[39m: fromDirectory
00:45:43 - [34mdebug[39m: buildGrammar
00:45:43 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
00:45:43 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
00:45:43 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
00:45:43 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
00:45:43 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
00:45:43 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
00:45:43 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
00:45:43 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
00:45:43 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
00:45:43 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
00:45:43 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
00:45:43 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
00:45:43 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
00:45:43 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
00:45:43 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
00:45:43 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
00:45:43 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "72bba899-f0b1-4e94-bd18-bf57968fd694",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
00:45:43 - [34mdebug[39m: fromDirectory
00:45:43 - [34mdebug[39m: fromDirectory
00:45:43 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"72bba899-f0b1-4e94-bd18-bf57968fd694","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:45:43 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"72bba899-f0b1-4e94-bd18-bf57968fd694","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:45:43 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
00:45:43 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
00:45:43 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
00:45:43 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-e63136dc9eb24a43765b0fb65a356976c1db09946cff2aaf16717f28a8e0f213[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m4cc6b4f6-91ca-4f47-b4ed-994988105018[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T22:45:43.582Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
00:45:58 - [32minfo[39m: Using current directory as template folder
00:45:58 - [32minfo[39m: Loading a default sample.txt file.
00:45:58 - [32minfo[39m: Loading a single default request.json file.
00:45:58 - [32minfo[39m: Loading a default state.json file.
00:45:58 - [34mdebug[39m: fromDirectory
00:45:58 - [34mdebug[39m: fromDirectory
00:45:58 - [34mdebug[39m: fromDirectory
00:45:58 - [34mdebug[39m: fromDirectory
00:45:58 - [34mdebug[39m: fromDirectory
00:45:58 - [34mdebug[39m: fromDirectory
00:45:58 - [34mdebug[39m: fromDirectory
00:45:58 - [34mdebug[39m: constructor
00:45:58 - [34mdebug[39m: constructor
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processDirectory
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: fromDirectory
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: fromDirectory
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:58 - [34mdebug[39m: isFileInNodeModuleDir
00:45:58 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: fromDirectory
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processDirectory
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: fromDirectory
00:45:59 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": []}, {"inputVariables": []}));
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(vfuzzyModel), "fuzzyRules")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": []}, {"inputVariables": []}));
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(vfuzzyModel), "fuzzyRules")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



00:45:59 - [34mdebug[39m: fromDirectory
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: isFileInNodeModuleDir
00:45:59 - [34mdebug[39m: processFile
00:45:59 - [34mdebug[39m: fromDirectory
00:45:59 - [34mdebug[39m: buildGrammar
00:45:59 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
00:45:59 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
00:45:59 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
00:45:59 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
00:45:59 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
00:45:59 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
00:45:59 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
00:45:59 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
00:45:59 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
00:45:59 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
00:45:59 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
00:45:59 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
00:45:59 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
00:45:59 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
00:45:59 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
00:45:59 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
00:45:59 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "f7b43b06-7c27-4675-9b3c-be8f75a5f6d6",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
00:45:59 - [34mdebug[39m: fromDirectory
00:45:59 - [34mdebug[39m: fromDirectory
00:45:59 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"f7b43b06-7c27-4675-9b3c-be8f75a5f6d6","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:45:59 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"f7b43b06-7c27-4675-9b3c-be8f75a5f6d6","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:45:59 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
00:45:59 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
00:45:59 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
00:45:59 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-687b6df224781b0db2cc6fd2bae8f9a90a43531a237d6204ec669ef0ff147ac5[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m7afb1a26-679f-4313-8d7c-b6ca833cace4[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T22:45:59.729Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
00:48:03 - [32minfo[39m: Using current directory as template folder
00:48:03 - [32minfo[39m: Loading a default sample.txt file.
00:48:03 - [32minfo[39m: Loading a single default request.json file.
00:48:03 - [32minfo[39m: Loading a default state.json file.
00:48:03 - [34mdebug[39m: fromDirectory
00:48:03 - [34mdebug[39m: fromDirectory
00:48:03 - [34mdebug[39m: fromDirectory
00:48:03 - [34mdebug[39m: fromDirectory
00:48:03 - [34mdebug[39m: fromDirectory
00:48:03 - [34mdebug[39m: fromDirectory
00:48:03 - [34mdebug[39m: fromDirectory
00:48:03 - [34mdebug[39m: constructor
00:48:03 - [34mdebug[39m: constructor
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processDirectory
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: fromDirectory
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: fromDirectory
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:03 - [34mdebug[39m: isFileInNodeModuleDir
00:48:03 - [34mdebug[39m: processFile
00:48:04 - [34mdebug[39m: fromDirectory
00:48:04 - [34mdebug[39m: isFileInNodeModuleDir
00:48:04 - [34mdebug[39m: isFileInNodeModuleDir
00:48:04 - [34mdebug[39m: isFileInNodeModuleDir
00:48:04 - [34mdebug[39m: isFileInNodeModuleDir
00:48:04 - [34mdebug[39m: isFileInNodeModuleDir
00:48:04 - [34mdebug[39m: processDirectory
00:48:04 - [34mdebug[39m: isFileInNodeModuleDir
00:48:04 - [34mdebug[39m: processFile
00:48:04 - [34mdebug[39m: isFileInNodeModuleDir
00:48:04 - [34mdebug[39m: processFile
00:48:04 - [34mdebug[39m: isFileInNodeModuleDir
00:48:04 - [34mdebug[39m: processFile
00:48:04 - [34mdebug[39m: isFileInNodeModuleDir
00:48:04 - [34mdebug[39m: processFile
00:48:04 - [34mdebug[39m: fromDirectory
00:48:04 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 34 character 55]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 34 character 55]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:48:04 - [32minfo[39m: undefined
00:48:16 - [32minfo[39m: Using current directory as template folder
00:48:16 - [32minfo[39m: Loading a default sample.txt file.
00:48:16 - [32minfo[39m: Loading a single default request.json file.
00:48:16 - [32minfo[39m: Loading a default state.json file.
00:48:16 - [34mdebug[39m: fromDirectory
00:48:16 - [34mdebug[39m: fromDirectory
00:48:16 - [34mdebug[39m: fromDirectory
00:48:16 - [34mdebug[39m: fromDirectory
00:48:16 - [34mdebug[39m: fromDirectory
00:48:16 - [34mdebug[39m: fromDirectory
00:48:16 - [34mdebug[39m: fromDirectory
00:48:16 - [34mdebug[39m: constructor
00:48:16 - [34mdebug[39m: constructor
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processDirectory
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: fromDirectory
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: fromDirectory
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: fromDirectory
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processDirectory
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: isFileInNodeModuleDir
00:48:16 - [34mdebug[39m: processFile
00:48:16 - [34mdebug[39m: fromDirectory
00:48:17 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vshipSize = brand(["org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable"],concat({"terms": []}, concat({"description": "Ship size"}, {"InputVariableId": "1"})));
          var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": [vshipSize]}, {"inputVariables": []}));
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(vfuzzyModel), "fuzzyRules")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vshipSize = brand(["org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable"],concat({"terms": []}, concat({"description": "Ship size"}, {"InputVariableId": "1"})));
        var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": [vshipSize]}, {"inputVariables": []}));
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(vfuzzyModel), "fuzzyRules")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



00:48:17 - [34mdebug[39m: fromDirectory
00:48:17 - [34mdebug[39m: isFileInNodeModuleDir
00:48:17 - [34mdebug[39m: processFile
00:48:17 - [34mdebug[39m: isFileInNodeModuleDir
00:48:17 - [34mdebug[39m: processFile
00:48:17 - [34mdebug[39m: isFileInNodeModuleDir
00:48:17 - [34mdebug[39m: processFile
00:48:17 - [34mdebug[39m: isFileInNodeModuleDir
00:48:17 - [34mdebug[39m: processFile
00:48:17 - [34mdebug[39m: isFileInNodeModuleDir
00:48:17 - [34mdebug[39m: processFile
00:48:17 - [34mdebug[39m: isFileInNodeModuleDir
00:48:17 - [34mdebug[39m: processFile
00:48:17 - [34mdebug[39m: isFileInNodeModuleDir
00:48:17 - [34mdebug[39m: processFile
00:48:17 - [34mdebug[39m: isFileInNodeModuleDir
00:48:17 - [34mdebug[39m: processFile
00:48:17 - [34mdebug[39m: isFileInNodeModuleDir
00:48:17 - [34mdebug[39m: processFile
00:48:17 - [34mdebug[39m: isFileInNodeModuleDir
00:48:17 - [34mdebug[39m: processFile
00:48:17 - [34mdebug[39m: fromDirectory
00:48:17 - [34mdebug[39m: buildGrammar
00:48:17 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
00:48:17 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
00:48:17 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
00:48:17 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
00:48:17 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
00:48:17 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
00:48:17 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
00:48:17 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
00:48:17 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
00:48:17 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
00:48:17 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
00:48:17 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
00:48:17 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
00:48:17 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
00:48:17 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
00:48:17 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
00:48:17 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "d63bc7dd-4fb2-4f7e-a334-4ccf31e8e863",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
00:48:17 - [34mdebug[39m: fromDirectory
00:48:17 - [34mdebug[39m: fromDirectory
00:48:17 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"d63bc7dd-4fb2-4f7e-a334-4ccf31e8e863","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:48:17 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"d63bc7dd-4fb2-4f7e-a334-4ccf31e8e863","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:48:17 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
00:48:17 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
00:48:17 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
00:48:17 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-b391b5840261052ec7044d121b78d458315cc8a1d75666a9b258cdd6ea7c8c34[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[35m[object Object][39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m2edf746b-60fc-434c-8ab0-f0630b1995f8[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T22:48:17.327Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
00:48:29 - [32minfo[39m: Using current directory as template folder
00:48:29 - [32minfo[39m: Loading a default sample.txt file.
00:48:29 - [32minfo[39m: Loading a single default request.json file.
00:48:29 - [32minfo[39m: Loading a default state.json file.
00:48:29 - [34mdebug[39m: fromDirectory
00:48:29 - [34mdebug[39m: fromDirectory
00:48:29 - [34mdebug[39m: fromDirectory
00:48:29 - [34mdebug[39m: fromDirectory
00:48:29 - [34mdebug[39m: fromDirectory
00:48:29 - [34mdebug[39m: fromDirectory
00:48:29 - [34mdebug[39m: fromDirectory
00:48:29 - [34mdebug[39m: constructor
00:48:29 - [34mdebug[39m: constructor
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processDirectory
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: fromDirectory
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: fromDirectory
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:29 - [34mdebug[39m: isFileInNodeModuleDir
00:48:29 - [34mdebug[39m: processFile
00:48:30 - [34mdebug[39m: fromDirectory
00:48:30 - [34mdebug[39m: isFileInNodeModuleDir
00:48:30 - [34mdebug[39m: isFileInNodeModuleDir
00:48:30 - [34mdebug[39m: isFileInNodeModuleDir
00:48:30 - [34mdebug[39m: isFileInNodeModuleDir
00:48:30 - [34mdebug[39m: isFileInNodeModuleDir
00:48:30 - [34mdebug[39m: processDirectory
00:48:30 - [34mdebug[39m: isFileInNodeModuleDir
00:48:30 - [34mdebug[39m: processFile
00:48:30 - [34mdebug[39m: isFileInNodeModuleDir
00:48:30 - [34mdebug[39m: processFile
00:48:30 - [34mdebug[39m: isFileInNodeModuleDir
00:48:30 - [34mdebug[39m: processFile
00:48:30 - [34mdebug[39m: isFileInNodeModuleDir
00:48:30 - [34mdebug[39m: processFile
00:48:30 - [34mdebug[39m: fromDirectory
00:48:30 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 57 character 32]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 57 character 32]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:48:30 - [32minfo[39m: undefined
00:49:00 - [32minfo[39m: Using current directory as template folder
00:49:00 - [32minfo[39m: Loading a default sample.txt file.
00:49:00 - [32minfo[39m: Loading a single default request.json file.
00:49:00 - [32minfo[39m: Loading a default state.json file.
00:49:00 - [34mdebug[39m: fromDirectory
00:49:00 - [34mdebug[39m: fromDirectory
00:49:00 - [34mdebug[39m: fromDirectory
00:49:00 - [34mdebug[39m: fromDirectory
00:49:00 - [34mdebug[39m: fromDirectory
00:49:00 - [34mdebug[39m: fromDirectory
00:49:00 - [34mdebug[39m: fromDirectory
00:49:00 - [34mdebug[39m: constructor
00:49:00 - [34mdebug[39m: constructor
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processDirectory
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: fromDirectory
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: fromDirectory
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:00 - [34mdebug[39m: isFileInNodeModuleDir
00:49:00 - [34mdebug[39m: processFile
00:49:01 - [34mdebug[39m: fromDirectory
00:49:01 - [34mdebug[39m: isFileInNodeModuleDir
00:49:01 - [34mdebug[39m: isFileInNodeModuleDir
00:49:01 - [34mdebug[39m: isFileInNodeModuleDir
00:49:01 - [34mdebug[39m: isFileInNodeModuleDir
00:49:01 - [34mdebug[39m: isFileInNodeModuleDir
00:49:01 - [34mdebug[39m: processDirectory
00:49:01 - [34mdebug[39m: isFileInNodeModuleDir
00:49:01 - [34mdebug[39m: processFile
00:49:01 - [34mdebug[39m: isFileInNodeModuleDir
00:49:01 - [34mdebug[39m: processFile
00:49:01 - [34mdebug[39m: isFileInNodeModuleDir
00:49:01 - [34mdebug[39m: processFile
00:49:01 - [34mdebug[39m: isFileInNodeModuleDir
00:49:01 - [34mdebug[39m: processFile
00:49:01 - [34mdebug[39m: fromDirectory
00:49:01 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 57 character 32]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 57 character 32]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:49:01 - [32minfo[39m: undefined
00:49:13 - [32minfo[39m: Using current directory as template folder
00:49:13 - [32minfo[39m: Loading a default sample.txt file.
00:49:13 - [32minfo[39m: Loading a single default request.json file.
00:49:13 - [32minfo[39m: Loading a default state.json file.
00:49:13 - [34mdebug[39m: fromDirectory
00:49:13 - [34mdebug[39m: fromDirectory
00:49:13 - [34mdebug[39m: fromDirectory
00:49:13 - [34mdebug[39m: fromDirectory
00:49:13 - [34mdebug[39m: fromDirectory
00:49:13 - [34mdebug[39m: fromDirectory
00:49:13 - [34mdebug[39m: fromDirectory
00:49:13 - [34mdebug[39m: constructor
00:49:13 - [34mdebug[39m: constructor
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processDirectory
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: fromDirectory
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: fromDirectory
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:13 - [34mdebug[39m: isFileInNodeModuleDir
00:49:13 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: fromDirectory
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processDirectory
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: fromDirectory
00:49:14 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vshipSize = brand(["org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable"],concat({"terms": []}, concat({"description": "Ship size"}, {"InputVariableId": "1"})));
          var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": [vshipSize]}, {"inputVariables": []}));
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(vfuzzyModel), "fuzzyRules")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vshipSize = brand(["org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable"],concat({"terms": []}, concat({"description": "Ship size"}, {"InputVariableId": "1"})));
        var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": [vshipSize]}, {"inputVariables": []}));
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(vfuzzyModel), "fuzzyRules")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



00:49:14 - [34mdebug[39m: fromDirectory
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: isFileInNodeModuleDir
00:49:14 - [34mdebug[39m: processFile
00:49:14 - [34mdebug[39m: fromDirectory
00:49:14 - [34mdebug[39m: buildGrammar
00:49:14 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
00:49:14 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
00:49:14 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
00:49:14 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
00:49:14 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
00:49:14 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
00:49:14 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
00:49:14 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
00:49:14 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
00:49:14 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
00:49:14 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
00:49:14 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
00:49:14 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
00:49:14 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
00:49:14 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
00:49:14 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
00:49:14 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "b09e7b01-0889-4066-a93c-392f3cea19e7",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
00:49:14 - [34mdebug[39m: fromDirectory
00:49:14 - [34mdebug[39m: fromDirectory
00:49:14 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"b09e7b01-0889-4066-a93c-392f3cea19e7","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:49:14 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"b09e7b01-0889-4066-a93c-392f3cea19e7","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:49:14 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
00:49:14 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
00:49:14 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
00:49:14 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-9788791c1bfad5db79ad611d9dab9b28634d15920fb40ed68a5a8c7ff4b48845[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[35m[object Object][39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35mdc4c2fd7-152a-469b-b5a0-e1901e067268[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T22:49:14.736Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
00:50:10 - [32minfo[39m: Using current directory as template folder
00:50:10 - [32minfo[39m: Loading a default sample.txt file.
00:50:10 - [32minfo[39m: Loading a single default request.json file.
00:50:10 - [32minfo[39m: Loading a default state.json file.
00:50:10 - [34mdebug[39m: fromDirectory
00:50:10 - [34mdebug[39m: fromDirectory
00:50:10 - [34mdebug[39m: fromDirectory
00:50:10 - [34mdebug[39m: fromDirectory
00:50:10 - [34mdebug[39m: fromDirectory
00:50:10 - [34mdebug[39m: fromDirectory
00:50:10 - [34mdebug[39m: fromDirectory
00:50:10 - [34mdebug[39m: constructor
00:50:10 - [34mdebug[39m: constructor
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processDirectory
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: fromDirectory
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: fromDirectory
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:10 - [34mdebug[39m: isFileInNodeModuleDir
00:50:10 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: fromDirectory
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processDirectory
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: fromDirectory
00:50:11 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vshipSize = brand(["org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable"],concat({"terms": []}, concat({"description": "Ship size"}, {"InputVariableId": "1"})));
          var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": [vshipSize]}, {"inputVariables": []}));
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(deref(unbrand(vfuzzyModel), "fuzzyRules")), "first")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vshipSize = brand(["org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable"],concat({"terms": []}, concat({"description": "Ship size"}, {"InputVariableId": "1"})));
        var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": [vshipSize]}, {"inputVariables": []}));
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(deref(unbrand(vfuzzyModel), "fuzzyRules")), "first")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



00:50:11 - [34mdebug[39m: fromDirectory
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: isFileInNodeModuleDir
00:50:11 - [34mdebug[39m: processFile
00:50:11 - [34mdebug[39m: fromDirectory
00:50:11 - [34mdebug[39m: buildGrammar
00:50:11 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
00:50:11 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
00:50:11 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
00:50:11 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
00:50:11 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
00:50:11 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
00:50:11 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
00:50:11 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
00:50:11 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
00:50:11 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
00:50:11 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
00:50:11 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
00:50:11 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
00:50:11 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
00:50:11 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
00:50:11 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
00:50:11 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "17a56662-d60c-4677-94ee-e41fc590f05f",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
00:50:11 - [34mdebug[39m: fromDirectory
00:50:11 - [34mdebug[39m: fromDirectory
00:50:11 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"17a56662-d60c-4677-94ee-e41fc590f05f","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:50:11 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"17a56662-d60c-4677-94ee-e41fc590f05f","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
00:50:11 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
00:50:11 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
00:50:11 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
00:50:11 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-8b173518f1f8958e5a7434e896662834dda9440ad90a419bc43bc0d25ca9b484[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m21fbaf27-53bf-4877-8109-e6cc030f3758[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T22:50:11.786Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
00:50:33 - [32minfo[39m: Using current directory as template folder
00:50:33 - [32minfo[39m: Loading a default sample.txt file.
00:50:33 - [32minfo[39m: Loading a single default request.json file.
00:50:33 - [32minfo[39m: Loading a default state.json file.
00:50:33 - [34mdebug[39m: fromDirectory
00:50:33 - [34mdebug[39m: fromDirectory
00:50:33 - [34mdebug[39m: fromDirectory
00:50:33 - [34mdebug[39m: fromDirectory
00:50:33 - [34mdebug[39m: fromDirectory
00:50:33 - [34mdebug[39m: fromDirectory
00:50:33 - [34mdebug[39m: fromDirectory
00:50:33 - [34mdebug[39m: constructor
00:50:33 - [34mdebug[39m: constructor
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processDirectory
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: fromDirectory
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: fromDirectory
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: fromDirectory
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processDirectory
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: isFileInNodeModuleDir
00:50:33 - [34mdebug[39m: processFile
00:50:33 - [34mdebug[39m: fromDirectory
00:50:33 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 57 character 32]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 57 character 32]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
00:50:33 - [32minfo[39m: undefined
01:01:26 - [32minfo[39m: Using current directory as template folder
01:01:26 - [32minfo[39m: Loading a default sample.txt file.
01:01:26 - [32minfo[39m: Loading a single default request.json file.
01:01:26 - [32minfo[39m: Loading a default state.json file.
01:01:26 - [34mdebug[39m: fromDirectory
01:01:26 - [34mdebug[39m: fromDirectory
01:01:26 - [34mdebug[39m: fromDirectory
01:01:26 - [34mdebug[39m: fromDirectory
01:01:26 - [34mdebug[39m: fromDirectory
01:01:26 - [34mdebug[39m: fromDirectory
01:01:26 - [34mdebug[39m: fromDirectory
01:01:26 - [34mdebug[39m: constructor
01:01:26 - [34mdebug[39m: constructor
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processDirectory
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: fromDirectory
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: fromDirectory
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: fromDirectory
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processDirectory
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: isFileInNodeModuleDir
01:01:26 - [34mdebug[39m: processFile
01:01:26 - [34mdebug[39m: fromDirectory
01:01:27 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 47 character 4]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 47 character 4]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
01:01:27 - [32minfo[39m: undefined
01:02:56 - [32minfo[39m: Using current directory as template folder
01:02:56 - [32minfo[39m: Loading a default sample.txt file.
01:02:56 - [32minfo[39m: Loading a single default request.json file.
01:02:56 - [32minfo[39m: Loading a default state.json file.
01:02:56 - [34mdebug[39m: fromDirectory
01:02:56 - [34mdebug[39m: fromDirectory
01:02:56 - [34mdebug[39m: fromDirectory
01:02:56 - [34mdebug[39m: fromDirectory
01:02:56 - [34mdebug[39m: fromDirectory
01:02:56 - [34mdebug[39m: fromDirectory
01:02:56 - [34mdebug[39m: fromDirectory
01:02:56 - [34mdebug[39m: constructor
01:02:56 - [34mdebug[39m: constructor
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processDirectory
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: fromDirectory
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: fromDirectory
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:56 - [34mdebug[39m: isFileInNodeModuleDir
01:02:56 - [34mdebug[39m: processFile
01:02:57 - [34mdebug[39m: fromDirectory
01:02:57 - [34mdebug[39m: isFileInNodeModuleDir
01:02:57 - [34mdebug[39m: isFileInNodeModuleDir
01:02:57 - [34mdebug[39m: isFileInNodeModuleDir
01:02:57 - [34mdebug[39m: isFileInNodeModuleDir
01:02:57 - [34mdebug[39m: isFileInNodeModuleDir
01:02:57 - [34mdebug[39m: processDirectory
01:02:57 - [34mdebug[39m: isFileInNodeModuleDir
01:02:57 - [34mdebug[39m: processFile
01:02:57 - [34mdebug[39m: isFileInNodeModuleDir
01:02:57 - [34mdebug[39m: processFile
01:02:57 - [34mdebug[39m: isFileInNodeModuleDir
01:02:57 - [34mdebug[39m: processFile
01:02:57 - [34mdebug[39m: isFileInNodeModuleDir
01:02:57 - [34mdebug[39m: processFile
01:02:57 - [34mdebug[39m: fromDirectory
01:02:57 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 47 character 4]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 47 character 4]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
01:02:57 - [32minfo[39m: undefined
01:03:12 - [32minfo[39m: Using current directory as template folder
01:03:12 - [32minfo[39m: Loading a default sample.txt file.
01:03:12 - [32minfo[39m: Loading a single default request.json file.
01:03:12 - [32minfo[39m: Loading a default state.json file.
01:03:12 - [34mdebug[39m: fromDirectory
01:03:12 - [34mdebug[39m: fromDirectory
01:03:12 - [34mdebug[39m: fromDirectory
01:03:12 - [34mdebug[39m: fromDirectory
01:03:12 - [34mdebug[39m: fromDirectory
01:03:12 - [34mdebug[39m: fromDirectory
01:03:12 - [34mdebug[39m: fromDirectory
01:03:12 - [34mdebug[39m: constructor
01:03:12 - [34mdebug[39m: constructor
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processDirectory
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: fromDirectory
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: fromDirectory
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: fromDirectory
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processDirectory
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: isFileInNodeModuleDir
01:03:12 - [34mdebug[39m: processFile
01:03:12 - [34mdebug[39m: fromDirectory
01:03:12 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 47 character 4]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 47 character 4]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
01:03:12 - [32minfo[39m: undefined
01:03:30 - [32minfo[39m: Using current directory as template folder
01:03:30 - [32minfo[39m: Loading a default sample.txt file.
01:03:30 - [32minfo[39m: Loading a single default request.json file.
01:03:30 - [32minfo[39m: Loading a default state.json file.
01:03:30 - [34mdebug[39m: fromDirectory
01:03:30 - [34mdebug[39m: fromDirectory
01:03:30 - [34mdebug[39m: fromDirectory
01:03:30 - [34mdebug[39m: fromDirectory
01:03:30 - [34mdebug[39m: fromDirectory
01:03:30 - [34mdebug[39m: fromDirectory
01:03:30 - [34mdebug[39m: fromDirectory
01:03:30 - [34mdebug[39m: constructor
01:03:30 - [34mdebug[39m: constructor
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processDirectory
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: fromDirectory
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: fromDirectory
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: fromDirectory
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processDirectory
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: isFileInNodeModuleDir
01:03:30 - [34mdebug[39m: processFile
01:03:30 - [34mdebug[39m: fromDirectory
01:03:31 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vshipSize = brand(["org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable"],concat({"terms": []}, concat({"description": "Ship size"}, {"InputVariableId": "1"})));
          var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": [vshipSize]}, {"inputVariables": []}));
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(vfuzzyModel), "fuzzyRules")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vshipSize = brand(["org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable"],concat({"terms": []}, concat({"description": "Ship size"}, {"InputVariableId": "1"})));
        var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": [vshipSize]}, {"inputVariables": []}));
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": deref(unbrand(vfuzzyModel), "fuzzyRules")}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



01:03:31 - [34mdebug[39m: fromDirectory
01:03:31 - [34mdebug[39m: isFileInNodeModuleDir
01:03:31 - [34mdebug[39m: processFile
01:03:31 - [34mdebug[39m: isFileInNodeModuleDir
01:03:31 - [34mdebug[39m: processFile
01:03:31 - [34mdebug[39m: isFileInNodeModuleDir
01:03:31 - [34mdebug[39m: processFile
01:03:31 - [34mdebug[39m: isFileInNodeModuleDir
01:03:31 - [34mdebug[39m: processFile
01:03:31 - [34mdebug[39m: isFileInNodeModuleDir
01:03:31 - [34mdebug[39m: processFile
01:03:31 - [34mdebug[39m: isFileInNodeModuleDir
01:03:31 - [34mdebug[39m: processFile
01:03:31 - [34mdebug[39m: isFileInNodeModuleDir
01:03:31 - [34mdebug[39m: processFile
01:03:31 - [34mdebug[39m: isFileInNodeModuleDir
01:03:31 - [34mdebug[39m: processFile
01:03:31 - [34mdebug[39m: isFileInNodeModuleDir
01:03:31 - [34mdebug[39m: processFile
01:03:31 - [34mdebug[39m: isFileInNodeModuleDir
01:03:31 - [34mdebug[39m: processFile
01:03:31 - [34mdebug[39m: fromDirectory
01:03:31 - [34mdebug[39m: buildGrammar
01:03:31 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
01:03:31 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
01:03:31 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
01:03:31 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
01:03:31 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
01:03:31 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
01:03:31 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
01:03:31 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
01:03:31 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
01:03:31 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
01:03:31 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
01:03:31 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
01:03:31 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
01:03:31 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
01:03:31 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
01:03:31 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
01:03:31 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "d485e2de-2827-42d7-9403-fe7adebc3a5d",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
01:03:31 - [34mdebug[39m: fromDirectory
01:03:31 - [34mdebug[39m: fromDirectory
01:03:31 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"d485e2de-2827-42d7-9403-fe7adebc3a5d","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
01:03:31 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"d485e2de-2827-42d7-9403-fe7adebc3a5d","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
01:03:31 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
01:03:31 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
01:03:31 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
01:03:31 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-ef5efbaf8e76ce1e1722a40121a61cfb5dd58cc6a712014dbbd198b6d2f46fbc[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[35m[object Object][39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m80694e98-f32b-4d38-bd11-e36fdc80b59b[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-08T23:03:31.476Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
13:26:22 - [32minfo[39m: Using current directory as template folder
13:26:22 - [32minfo[39m: Loading a default sample.txt file.
13:26:22 - [32minfo[39m: Loading a single default request.json file.
13:26:22 - [32minfo[39m: Loading a default state.json file.
13:26:22 - [34mdebug[39m: fromDirectory
13:26:22 - [34mdebug[39m: fromDirectory
13:26:22 - [34mdebug[39m: fromDirectory
13:26:22 - [34mdebug[39m: fromDirectory
13:26:22 - [34mdebug[39m: fromDirectory
13:26:22 - [34mdebug[39m: fromDirectory
13:26:22 - [34mdebug[39m: fromDirectory
13:26:22 - [34mdebug[39m: constructor
13:26:22 - [34mdebug[39m: constructor
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processDirectory
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: fromDirectory
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: fromDirectory
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:22 - [34mdebug[39m: isFileInNodeModuleDir
13:26:22 - [34mdebug[39m: processFile
13:26:25 - [34mdebug[39m: fromDirectory
13:26:25 - [34mdebug[39m: isFileInNodeModuleDir
13:26:25 - [34mdebug[39m: isFileInNodeModuleDir
13:26:25 - [34mdebug[39m: isFileInNodeModuleDir
13:26:25 - [34mdebug[39m: isFileInNodeModuleDir
13:26:25 - [34mdebug[39m: isFileInNodeModuleDir
13:26:25 - [34mdebug[39m: processDirectory
13:26:25 - [34mdebug[39m: isFileInNodeModuleDir
13:26:25 - [34mdebug[39m: processFile
13:26:25 - [34mdebug[39m: isFileInNodeModuleDir
13:26:25 - [34mdebug[39m: processFile
13:26:25 - [34mdebug[39m: isFileInNodeModuleDir
13:26:25 - [34mdebug[39m: processFile
13:26:25 - [34mdebug[39m: isFileInNodeModuleDir
13:26:25 - [34mdebug[39m: processFile
13:26:25 - [34mdebug[39m: fromDirectory
13:26:25 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 55 character 32]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 55 character 32]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
13:26:25 - [32minfo[39m: undefined
13:42:16 - [32minfo[39m: Using current directory as template folder
13:42:16 - [32minfo[39m: Loading a default sample.txt file.
13:42:16 - [32minfo[39m: Loading a single default request.json file.
13:42:16 - [32minfo[39m: Loading a default state.json file.
13:42:16 - [34mdebug[39m: fromDirectory
13:42:16 - [34mdebug[39m: fromDirectory
13:42:16 - [34mdebug[39m: fromDirectory
13:42:16 - [34mdebug[39m: fromDirectory
13:42:16 - [34mdebug[39m: fromDirectory
13:42:16 - [34mdebug[39m: fromDirectory
13:42:16 - [34mdebug[39m: fromDirectory
13:42:16 - [34mdebug[39m: constructor
13:42:16 - [34mdebug[39m: constructor
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processDirectory
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: fromDirectory
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: fromDirectory
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:16 - [34mdebug[39m: isFileInNodeModuleDir
13:42:16 - [34mdebug[39m: processFile
13:42:21 - [34mdebug[39m: fromDirectory
13:42:21 - [34mdebug[39m: isFileInNodeModuleDir
13:42:21 - [34mdebug[39m: isFileInNodeModuleDir
13:42:21 - [34mdebug[39m: isFileInNodeModuleDir
13:42:21 - [34mdebug[39m: isFileInNodeModuleDir
13:42:21 - [34mdebug[39m: isFileInNodeModuleDir
13:42:21 - [34mdebug[39m: processDirectory
13:42:21 - [34mdebug[39m: isFileInNodeModuleDir
13:42:21 - [34mdebug[39m: processFile
13:42:21 - [34mdebug[39m: isFileInNodeModuleDir
13:42:21 - [34mdebug[39m: processFile
13:42:21 - [34mdebug[39m: isFileInNodeModuleDir
13:42:21 - [34mdebug[39m: processFile
13:42:21 - [34mdebug[39m: isFileInNodeModuleDir
13:42:21 - [34mdebug[39m: processFile
13:42:21 - [34mdebug[39m: fromDirectory
13:42:21 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 54 character 41]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 54 character 41]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
13:42:21 - [32minfo[39m: undefined
13:42:39 - [32minfo[39m: Using current directory as template folder
13:42:39 - [32minfo[39m: Loading a default sample.txt file.
13:42:39 - [32minfo[39m: Loading a single default request.json file.
13:42:39 - [32minfo[39m: Loading a default state.json file.
13:42:39 - [34mdebug[39m: fromDirectory
13:42:39 - [34mdebug[39m: fromDirectory
13:42:39 - [34mdebug[39m: fromDirectory
13:42:39 - [34mdebug[39m: fromDirectory
13:42:39 - [34mdebug[39m: fromDirectory
13:42:39 - [34mdebug[39m: fromDirectory
13:42:39 - [34mdebug[39m: fromDirectory
13:42:39 - [34mdebug[39m: constructor
13:42:39 - [34mdebug[39m: constructor
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processDirectory
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: fromDirectory
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: fromDirectory
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:39 - [34mdebug[39m: isFileInNodeModuleDir
13:42:39 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: fromDirectory
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processDirectory
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: fromDirectory
13:42:40 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vshipSize = brand(["org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable"],concat({"terms": []}, concat({"description": "Ship size"}, {"InputVariableId": "1"})));
          var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": [vshipSize]}, {"inputVariables": []}));
          var vp1 = deref(unbrand(vfuzzyModel), "fuzzyRules");
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": toString(vp1)}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vshipSize = brand(["org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable"],concat({"terms": []}, concat({"description": "Ship size"}, {"InputVariableId": "1"})));
        var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": [vshipSize]}, {"inputVariables": []}));
        var vp1 = deref(unbrand(vfuzzyModel), "fuzzyRules");
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": toString(vp1)}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



13:42:40 - [34mdebug[39m: fromDirectory
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: isFileInNodeModuleDir
13:42:40 - [34mdebug[39m: processFile
13:42:40 - [34mdebug[39m: fromDirectory
13:42:40 - [34mdebug[39m: buildGrammar
13:42:40 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
13:42:40 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
13:42:40 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
13:42:40 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
13:42:40 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
13:42:40 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
13:42:40 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
13:42:40 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
13:42:40 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
13:42:40 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
13:42:40 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
13:42:40 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
13:42:40 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
13:42:40 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
13:42:40 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
13:42:40 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
13:42:40 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "0cf0e880-fb35-4ab2-b0d2-203cf11ea425",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
13:42:40 - [34mdebug[39m: fromDirectory
13:42:40 - [34mdebug[39m: fromDirectory
13:42:40 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"0cf0e880-fb35-4ab2-b0d2-203cf11ea425","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
13:42:40 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"0cf0e880-fb35-4ab2-b0d2-203cf11ea425","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
13:42:40 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
13:42:40 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
13:42:40 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
13:42:40 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-54f25e9b2269061a03492d2f89bfcfe3667e8d921bb23c18b7e9ece936a3dad6[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[35m[{terms: [], description: Ship size, InputVariableId: 1, $class: org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable}][39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m1d17ebc2-c470-4c15-a09f-c550fbe096f6[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-09T11:42:40.632Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
14:12:47 - [32minfo[39m: Using current directory as template folder
14:12:47 - [32minfo[39m: Loading a default sample.txt file.
14:12:47 - [32minfo[39m: Loading a single default request.json file.
14:12:47 - [32minfo[39m: Loading a default state.json file.
14:12:47 - [34mdebug[39m: fromDirectory
14:12:47 - [34mdebug[39m: fromDirectory
14:12:47 - [34mdebug[39m: fromDirectory
14:12:47 - [34mdebug[39m: fromDirectory
14:12:47 - [34mdebug[39m: fromDirectory
14:12:47 - [34mdebug[39m: fromDirectory
14:12:47 - [34mdebug[39m: fromDirectory
14:12:47 - [34mdebug[39m: constructor
14:12:47 - [34mdebug[39m: constructor
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processDirectory
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: fromDirectory
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: fromDirectory
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:47 - [34mdebug[39m: isFileInNodeModuleDir
14:12:47 - [34mdebug[39m: processFile
14:12:50 - [34mdebug[39m: fromDirectory
14:12:50 - [34mdebug[39m: isFileInNodeModuleDir
14:12:50 - [34mdebug[39m: isFileInNodeModuleDir
14:12:50 - [34mdebug[39m: isFileInNodeModuleDir
14:12:50 - [34mdebug[39m: isFileInNodeModuleDir
14:12:50 - [34mdebug[39m: isFileInNodeModuleDir
14:12:50 - [34mdebug[39m: processDirectory
14:12:50 - [34mdebug[39m: isFileInNodeModuleDir
14:12:50 - [34mdebug[39m: processFile
14:12:50 - [34mdebug[39m: isFileInNodeModuleDir
14:12:50 - [34mdebug[39m: processFile
14:12:50 - [34mdebug[39m: isFileInNodeModuleDir
14:12:50 - [34mdebug[39m: processFile
14:12:50 - [34mdebug[39m: isFileInNodeModuleDir
14:12:50 - [34mdebug[39m: processFile
14:12:50 - [34mdebug[39m: fromDirectory
14:12:50 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 54 character 41]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 54 character 41]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
14:12:50 - [32minfo[39m: undefined
14:13:33 - [32minfo[39m: Using current directory as template folder
14:13:33 - [32minfo[39m: Loading a default sample.txt file.
14:13:33 - [32minfo[39m: Loading a single default request.json file.
14:13:33 - [32minfo[39m: Loading a default state.json file.
14:13:33 - [34mdebug[39m: fromDirectory
14:13:33 - [34mdebug[39m: fromDirectory
14:13:33 - [34mdebug[39m: fromDirectory
14:13:33 - [34mdebug[39m: fromDirectory
14:13:33 - [34mdebug[39m: fromDirectory
14:13:33 - [34mdebug[39m: fromDirectory
14:13:33 - [34mdebug[39m: fromDirectory
14:13:33 - [34mdebug[39m: constructor
14:13:33 - [34mdebug[39m: constructor
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processDirectory
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: fromDirectory
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: fromDirectory
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:33 - [34mdebug[39m: isFileInNodeModuleDir
14:13:33 - [34mdebug[39m: processFile
14:13:34 - [34mdebug[39m: fromDirectory
14:13:34 - [34mdebug[39m: isFileInNodeModuleDir
14:13:34 - [34mdebug[39m: isFileInNodeModuleDir
14:13:34 - [34mdebug[39m: isFileInNodeModuleDir
14:13:34 - [34mdebug[39m: isFileInNodeModuleDir
14:13:34 - [34mdebug[39m: isFileInNodeModuleDir
14:13:34 - [34mdebug[39m: processDirectory
14:13:34 - [34mdebug[39m: isFileInNodeModuleDir
14:13:34 - [34mdebug[39m: processFile
14:13:34 - [34mdebug[39m: isFileInNodeModuleDir
14:13:34 - [34mdebug[39m: processFile
14:13:34 - [34mdebug[39m: isFileInNodeModuleDir
14:13:34 - [34mdebug[39m: processFile
14:13:34 - [34mdebug[39m: isFileInNodeModuleDir
14:13:34 - [34mdebug[39m: processFile
14:13:34 - [34mdebug[39m: fromDirectory
14:13:34 - [31merror[39m: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 44 character 50]
Error: In: /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/AccordTemplates/latedeliveryandpenalty/lib/logic.ergo [Parse error at line 44 character 50]
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:969:35)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
14:13:34 - [32minfo[39m: undefined
14:13:45 - [32minfo[39m: Using current directory as template folder
14:13:45 - [32minfo[39m: Loading a default sample.txt file.
14:13:45 - [32minfo[39m: Loading a single default request.json file.
14:13:45 - [32minfo[39m: Loading a default state.json file.
14:13:45 - [34mdebug[39m: fromDirectory
14:13:45 - [34mdebug[39m: fromDirectory
14:13:45 - [34mdebug[39m: fromDirectory
14:13:45 - [34mdebug[39m: fromDirectory
14:13:45 - [34mdebug[39m: fromDirectory
14:13:45 - [34mdebug[39m: fromDirectory
14:13:45 - [34mdebug[39m: fromDirectory
14:13:45 - [34mdebug[39m: constructor
14:13:45 - [34mdebug[39m: constructor
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processDirectory
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: fromDirectory
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: fromDirectory
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:45 - [34mdebug[39m: isFileInNodeModuleDir
14:13:45 - [34mdebug[39m: processFile
14:13:47 - [34mdebug[39m: fromDirectory
14:13:47 - [34mdebug[39m: isFileInNodeModuleDir
14:13:47 - [34mdebug[39m: isFileInNodeModuleDir
14:13:47 - [34mdebug[39m: isFileInNodeModuleDir
14:13:47 - [34mdebug[39m: isFileInNodeModuleDir
14:13:47 - [34mdebug[39m: isFileInNodeModuleDir
14:13:47 - [34mdebug[39m: processDirectory
14:13:47 - [34mdebug[39m: isFileInNodeModuleDir
14:13:47 - [34mdebug[39m: processFile
14:13:47 - [34mdebug[39m: isFileInNodeModuleDir
14:13:47 - [34mdebug[39m: processFile
14:13:47 - [34mdebug[39m: isFileInNodeModuleDir
14:13:47 - [34mdebug[39m: processFile
14:13:47 - [34mdebug[39m: isFileInNodeModuleDir
14:13:47 - [34mdebug[39m: processFile
14:13:47 - [34mdebug[39m: fromDirectory
14:13:48 - [34mdebug[39m: Compiled Ergo to Javascript:
/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* Initialize inheritance */
var inheritance = null;
/* "standard library" (implementation of unary and binary operators) */
function unwrap(doc) {
    // Unwrap for Enhanced TxStore format
    if ("state" in doc && !("$class" in doc)) {
        if (doc.state == "COMMITTED")
            return JSON.parse(doc.currentValue);
        else
            return null; // Not sure if we will need something more fancy for un-committed data
    }
    // Leave as-is
    else
        return doc;
}
function concat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2)
        if (!(key2 in r1))
            result[key2] = r2[key2];
    return result;
}
function contains(v, b) {
    for (var i=0; i<b.length; i++)
        if (equal(v, toLeft(b[i])))
            return true;
    return false;
}
function distinct(b) {
    var result = [ ];
    for (var i=0; i<b.length; i++) {
        var v = b[i];
        var dup = false;
        for (var j=0; j<result.length;j++) {
            if (equal(v,result[j])) { dup = true; break; }
        }
        if (!(dup)) { result.push(v); } else { dup = false; }
    }
    return result;
}
function fastdistinct(b) {
    b1 = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    b1.sort(compare);
    var result = [ ];
    var v1 = null;
    var v2 = null;
    for (var i=0; i<b1.length; i++) {
        var v1 = b1[i];
        if (i == (b1.length -1)) {
            result.push(v1);
        }
        else {
            v2 = b1[i+1];
            if (equal(v1,v2)) {
            } else {
                result.push(v1);
            }
            v1 = v2;
        }
    }
    return result;
}
function compare(v1, v2) {
    var t1 = typeof v1, t2 = typeof v2;
    if (t1 != t2)
        return t1 < t2 ? -1 : +1;
    var a1 = {}.toString.apply(v1), a2 = {}.toString.apply(v2);
    if (a1 != a2)
        return a1 < a2 ? -1 : +1;
    if (a1 == "[object Array]") {
        v1 = v1.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
        v2 = v2.slice(); /* So we do the sort/compare on a clone of the original array */
        v1.sort(compare);
        v2.sort(compare);
    }
    if (t1 == "object") {
        var fields1 = [];
        var fields2 = [];
        for (var f1 in v1) { fields1.push(f1); }
        for (var f2 in v2) { fields2.push(f2); }
        fields1 = fields1.sort(compare);
        fields2 = fields2.sort(compare);
        for (var i = 0; i < fields1.length; i++) {
            if (!(fields1[i] in v2))
                return -1;
            var fc = compare(v1[fields1[i]], v2[fields1[i]]);
            if (fc != 0)
                return fc;
        }
        for (var i = 0; i < fields2.length; i++) {
            if (!(fields2[i] in v1))
                return +1;
        }
        return 0;
    }
    if (v1 != v2)
        return v1 < v2 ? -1 : +1;
    return 0;
}
function equal(v1, v2) {
    return compare(v1, v2) == 0;
}
function compareOfMultipleCriterias(scl) {
    return function(a,b) {
        var current_compare = 0;
        for (var i=0; i<scl.length; i++) {
            var sc = scl[i];
            if ("asc" in sc) { current_compare = compare(deref(a,sc['asc']), deref(b,sc['asc'])); }
            else if ("desc" in sc) { current_compare = -(compare(deref(a,sc['asc']), deref(b,sc['asc']))); }

            if (current_compare == -1) { return -1; }
            else if(current_compare == 1) { return 1; }
        }
        return current_compare;
    }
    
}
function sort(b,scl) {
    var result = [ ];
    if (scl.length == 0) { return b; } // Check for no sorting criteria
    var compareFun = compareOfMultipleCriterias(scl);
    result = b.slice(); /* Sorting in place leads to inconsistencies, notably as it re-orders the input WM in the middle of processing */
    result.sort(compareFun);
    return result;
}
function flatten(aOuter) {
    var result = [ ];
    for (var iOuter=0, nOuter=aOuter.length; iOuter<nOuter; iOuter++) {
        var aInner = aOuter[iOuter];
        for (var iInner=0, nInner=aInner.length; iInner<nInner; iInner++)
            result.push(aInner[iInner]);
    }
    return result;
}
function mergeConcat(r1, r2) {
    var result = { };
    for (var key1 in r1)
        result[key1] = r1[key1];
    for (var key2 in r2) {
        if (key2 in r1) {
            if (!equal(r1[key2], r2[key2])) {
                return [ ];
            }
        } else {
            result[key2] = r2[key2];
        }
    }
    return [ result ];
}
function project(r1, p2) {
    var result = { };
    for (var key1 in r1) {
        if (!(p2.indexOf(key1) == -1))
            result[key1] = r1[key1];
    }
    return result;
}
function remove(r, f) {
    var result = { };
    for (var key in r)
        if (key != f)
            result[key] = r[key];
    return result;
}
function sum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i];
    return result;
}
function arithMean(b) {
    var len = b.length;
    if(len == 0) {
        return 0;
    } else {
        return sum(b)/len;
    }
}
function toString(v) {
    return toStringQ(v, "");
}
function toStringQ(v, quote) {
    if (v === null)
        return "null";
    var t = typeof v;
    if (t == "string")
        return quote + v + quote;
    if (t == "boolean")
        return "" + v;
    if (t == "number") {
        if (Math.floor(v) == v) return (new Number(v)).toFixed(1); // Make sure there is always decimal point
        else return "" + v;
    }
    if ({}.toString.apply(v) == "[object Array]") {
        v = v.slice();
        v.sort();
        var result = "[";
        for (var i=0, n=v.length; i<n; i++) {
            if (i > 0)
                result += ", ";
            result += toStringQ(v[i], quote);
        }
        return result + "]";
    }
    if(v.hasOwnProperty('nat')){
        return "" + v.nat;
    }
    var result2 = "{";
    var first = true;
    for (var key in v) {
        if (first) first = false; else result2 += ", ";
        result2 += toStringQ(key, quote) + ": " + toStringQ(v[key], quote);
    }
    return result2 + "}";
}
function bunion(b1, b2) {
    var result = [ ];
    for (var i1=0; i1<b1.length; i1++)
        result.push(b1[i1]);
    for (var i2=0; i2<b2.length; i2++)
        result.push(b2[i2]);
    return result;
}
function bminus(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == (-1)) { result.push(v1[i1]); } else { i2++; }
        } else {
            result.push(v1[i1]);
        }
    }
    return result;
}
function bmin(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) i2++;
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) result.push(v1[i1]);
        }
    }
    return result;
}
function bmax(b1, b2) {
    var result = [ ];
    var v1 = b1.slice();
    var v2 = b2.slice();
    v1.sort(compare);
    v2.sort(compare);
    var i2=0;
    var length2=v2.length;
    var comp=0;
    for (var i1=0; i1<v1.length; i1++) {
        while ((i2 < length2) && (compare(v1[i1],v2[i2]) == 1)) { result.push(v2[i2]); i2++; }
        if (i2 < length2) {
            if(compare(v1[i1],v2[i2]) == 0) i2++;
        }
        result.push(v1[i1]);
    }
    while (i2 < length2) { result.push(v2[i2]); i2++; }
    return result;
}
function sub_brand(b1,b2) {
    var bsub=null;
    var bsup=null;
    var inh = [];
    if (inheritance) { inh = inheritance; };
    for (var i=0; i<inh.length; i++) {
        bsub = inh[i].sub;
        bsup = inh[i].sup;
        if ((b1 == bsub) && (b2 == bsup)) return true;
    }
    return false;
}
function left(v) {
    return { left : v };
}
function right(v) {
    return { right : v };
}
function mustBeArray(obj) {
    if (Array.isArray(obj))
        return;
    var e = new Error("Expected an array but got: " + JSON.stringify(obj));
    throw e;
}
function cast(brands,v) {
    //logger.info("CASTING: "+brands[0]);
    //logger.info("FOR OBJECT: "+JSON.stringify(v));
    mustBeArray(brands);
    if ("$class" in v)
        return enhanced_cast(brands,v);
    var type = v.type;
    mustBeArray(type);
    if (brands.length == 1 && brands[0] == "Any") { /* cast to top of inheritance is built-in */
        return left(v);
    }
    brands:
    for (var i in brands) {
        var b = brands[i];
        for (var j in type) {
            var t = type[j];
            if (equal(t,b) || sub_brand(t,b))
                continue brands;
        }
        /* the brand b does not appear in the type, so the cast fails */
        return right(null);
    }
    /* All brands appear in the type, so the cast succeeds */
    return left(v);
}
function enhanced_cast(brands,v) {
    var type = v.$class;
    if (brands.length != 1)
        throw "Can't handle multiple brands yet";
    var brand = brands[0];
    if (brand == type || brand == "Any" || sub_brand(type, brand)) {
        return left(v);
    }
    return right(null);
}
function singleton(v) {
    if (v.length == 1) {
        return left(v[0]);
    } else {
        return right(null); /* Not a singleton */
    }
}
function unbrand(v) {
    if (typeof v === "object")
        if ("$class" in v) {
            return remove(v,"$class");
        } else {
            return ("data" in v) ? v.data : v;
        }
    throw "TypeError: unbrand called on non-object";
}
function brand(b,v) {
    v['$class'] = b[0];
    return v
}
function either(v) {
    if (v == null)
        return false;
    if (typeof v === "object")
        return !("right" in v);
    return true;
}
function toLeft(v) {
    if (typeof v === "object") {
        if ("left" in v)
            return v.left;
        if ("$value" in v)
            return v.$value;
        if (looksLikeRelationship(v))
            return v["key"];
    }
    return v;
}
function toRight(v) {
    if (v === null)
        return null;
    if (typeof v === "object" && "right" in v)
        return v.right;
    return undefined;
}
function deref(receiver, member) {
    if (typeof receiver === "object" && member in receiver) {
        var ans = receiver[member];
        if (ans === null) {
            return null;
        }
        if (typeof ans === "object" && looksLikeRelationship(ans))
            ans = left(ans["key"]);
        if (("$class" in receiver) && typeof ans === "object" && !("left" in ans) && !Array.isArray(ans))
            ans = left(ans);
        return ans;
    }
    return undefined;
}
function looksLikeRelationship(v) {
    // As the name suggests, this is only heuristic.  We call it a relationship if it has two or three members.
    // A "key" and "type" member must be among those.   A third member, if present, must be $class and must denote
    // the relationship class.
    var hasKey = false;
    var hasType = false;
    for (var member in v)
        if (member == "key")
            hasKey = true;
    else if (member == "type")
        hasType = true;
    else if (member == "$class" && v["$class"] == "com.ibm.ia.model.Relationship")
        continue;
    else
        return false;
    return hasKey && hasType;
}
function mkWorld(v) {
    return { "WORLD" : v };
}

// from: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions?redirectlocale=en-US&redirectslug=JavaScript%2FGuide%2FRegular_Expressions
function escapeRegExp(string){
    return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

// Nat operations

function natPlus(v1, v2) {
    return { "nat" : v1.nat + v2.nat };
}
function natMinus(v1, v2) {
    return { "nat" : v1.nat - v2.nat };
}
function natMult(v1, v2) {
    return { "nat" : v1.nat * v2.nat };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natDiv(v1, v2) {
    return { "nat" : Math.floor(v1.nat / v2.nat) };
}
function natRem(v1, v2) {
    return { "nat" : Math.floor(v1.nat % v2.nat) };
}
function natMin(v1, v2) {
    return { "nat" : Math.min(v1.nat,v2.nat) };
}
function natMax(v1, v2) {
    return { "nat" : Math.max(v1.nat,v2.nat) };
}
function natAbs(v) {
    return { "nat" : Math.abs(v.nat) };
}
function natLog2(v) {
    return { "nat" : Math.floor(Math.log2(v.nat)) }; // Default Z.log2 is log_inf, biggest integer lower than log2
}
function natSqrt(v) {
    return { "nat" : Math.floor(Math.sqrt(v.nat)) }; // See Z.sqrt biggest integer lower than sqrt
}
function natSum(b) {
    var result = 0;
    for (var i=0; i<b.length; i++)
        result += b[i].nat;
    return { "nat" : result };
}
function natMinApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.min.apply(Math,numbers) };
}
function natMaxApply(b) {
    var numbers = [ ];
    for (var i=0; i<b.length; i++)
        numbers.push(b[i].nat);
    return { "nat" : Math.max.apply(Math,numbers) };
}
function natArithMean(b) {
    var len = b.length;
    if(len == 0) {
        return { "nat" : 0 };
    } else {
        return { "nat" : Math.floor(natSum(b)/len) };
    }
}
function count(v) {
    //return { "nat" : v.length };
    return v.length; /* XXX To be fixed */
}
function floatOfNat(v) {
    return v.nat;
}
function substring(v, start, len) {
    return v.substring(start,len);
}
function substringNoLength(v, start) {
    return v.substring(start);
}
/* Addendum to for dateTime and duration */

var DAY = "day";
var MONTH = "month";
var QUARTER = "quarter";
var YEAR = "year";

function dateTimeComponent(part, date) {
    date = mustBeDate(date);
    switch(part) {
    case DAY:
        return date.dayOfMonth();
    case MONTH:
        return date.month();
    case YEAR:
        return date.year();
    case QUARTER:
        return date.quarter();
    default:
        throw new Error("Unknown date part: " + part);
    }
}

function dateTimeFromString(stringDate) {
    return moment(stringDate);
}

function dateTimeDurationFromString(stringDuration) {
    // TODO verify what the string format for durations is going to be.
    // Here we assume a number adjoined to a valid unit with a dash.
    if (typeof stringDuration === "string") {
	      parts = stringDuration.split("-");
	      if (parts.length === 2) {
	          mustBeUnit(parts[1]);
            return moment.duration(parseFloat(parts[0]),parts[1]+"s");
        }
    }
    throw new Error("Not well formed duration input: " + stringDuration);
}

function dateTimePointPlus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.add(duration);
}

function dateTimePointMinus(date, duration) {
    date = mustBeDate(date);
    duration = mustBeDuration(duration);
    return date.substract(duration);
}

function dateTimePointNe(date1, date2) {
    return compareDates(date1, date2) != 0;
}

function dateTimePointLt(date1, date2) {
    return compareDates(date1,date2) < 0;
}

function dateTimePointLe(date1, date2) {
    return compareDates(date1, date2) <= 0;
}

function dateTimePointGt(date1, date2) {
    return compareDates(date1, date2) > 0;
}

function dateTimePointGe(date1, date2) {
    return compareDates(date1, date2) >= 0;
}

function dateTimeDurationDays(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'days');
}
function dateTimeDurationSeconds(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    return date1.diff(date2,'seconds');
}

function compareDates(date1, date2) {
    date1 = mustBeDate(date1);
    date2 = mustBeDate(date2);
    if (date1.isBefore(date2)) {
        return -1;
    } else if (date1.isAfter(date2)) {
        return 1;
    } else if (date1.isSame(date2)) {
        return 0;
    }
    throw new Error("Unexpected failure: compareDates")
}

function dateNewYear(date, year) {
    date = mustBeDate(date);
    return date.year(year);
}

function dateNewMonth(date, month) {
    date = mustBeDate(date);
    return date.month(month);
}

function dateNewDay(date, day) {
    date = mustBeDate(date);
    return date.day(day);
}

function makeDate(year, month, day) {
    return moment({ 'year' :year, 'month' :month, 'day' :day });
}

function mustBeDate(date) {
    if (typeof date == "string") {
        return moment(date);
    } else {
        return date.clone();
    }
}

function mustBeDuration(duration) {
    if (typeof duration == "string") {
        return moment.duration(duration);
    } else {
        return duration.clone();
    }
}

function mustBeUnit(unit) {
    if (unit === DAY || unit === MONTH || unit === QUARTER || unit === YEAR)
	      return;
    throw new Error("Expected a duration unit but got " + JSON.stringify(unit));
}

'use strict';
/*eslint-disable no-unused-vars*/
/*eslint-disable no-undef*/
/*eslint-disable no-var*/


/**
 * Execute the smart clause
 * @param {Context} context - the Accord context
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest} context.request - the incoming request
 * @param {org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse} context.response - the response
 * @param {org.hyperledger.composer.system.Event} context.emit - the emitted events
 * @param {org.accordproject.cicero.contract.AccordContractState} context.state - the state
 * @AccordClauseLogic
 */
function LateDeliveryAndPenalty_latedeliveryandpenalty(context) {
  let pcontext = { 'request' : serializer.toJSON(context.request,{permitResourcesForRelationships:true}), 'state': serializer.toJSON(context.state,{permitResourcesForRelationships:true}), 'contract': serializer.toJSON(context.contract,{permitResourcesForRelationships:true}), 'emit': context.emit, 'now': context.now};
  //logger.info('ergo context: '+JSON.stringify(pcontext))
  let result = new LateDeliveryAndPenalty().latedeliveryandpenalty(pcontext);
  if (result.hasOwnProperty('left')) {
    //logger.info('ergo result: '+JSON.stringify(result))
    context.response = serializer.fromJSON(result.left.response, {validate: false, acceptResourcesForRelationships: true},{permitResourcesForRelationships:true});
    context.state = serializer.fromJSON(result.left.state, {validate: false, acceptResourcesForRelationships: true});
    let emitResult = [];
    for (let i = 0; i < result.left.emit.length; i++) {
      emitResult.push(serializer.fromJSON(result.left.emit[i], {validate: false, acceptResourcesForRelationships: true}));
    }
    context.emit = emitResult;
    return context;
  } else {
    throw new Error(result.right);
  }
}
class LateDeliveryAndPenalty {
  main(context) {
    var vnow = deref(context, "now");
    var vcontract = deref(context, "contract");
    var vrequest = deref(context, "request");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit_0 = vemit;
    var vX$match0 = vrequest;
    var res1 = null;
    if (either(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0))) {
      var vX$case0 = null;
      vX$case0 = toLeft(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"left" : {"$main": vX$case0}};
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(cast(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest"],vX$match0));
      res1 = {"right" : null};
    }
    var res4 = null;
    if (either(res1)) {
      var vX$case0_0 = null;
      vX$case0_0 = toLeft(res1);
      var vX$case0 = vX$case0_0;
      var vX$main = deref(vX$case0, "$main");
      var vrequest_0 = vX$main;
      var vemit_0 = vlemit_0;
      var vstate_0 = vlstate_0;
      var vcontract_0 = vcontract;
      var vlstate = vstate_0;
      var vlemit = vemit_0;
      var vagreed = deref(unbrand(vrequest_0), "agreedDelivery");
      var vp2 = vnow;
      var vp1 = vagreed;
      var t3;
      if (!(dateTimePointLt(vp1, vp2))) {
        t3 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
      } else {
        var t2;
        if (!((!(deref(unbrand(vcontract_0), "forceMajeure")) || !(deref(unbrand(vrequest_0), "forceMajeure"))))) {
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
        } else {
          var vp2 = vagreed;
          var vp1 = vnow;
          var vdiff = dateTimeDurationDays(vp1, vp2);
          var vshipSize = brand(["org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable"],concat({"terms": []}, concat({"description": "Ship size"}, {"InputVariableId": "1"})));
          var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": [vshipSize]}, {"inputVariables": []}));
          var voutput = deref(unbrand(vfuzzyModel), "fuzzyRules");
          var vp1 = voutput;
          t2 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": toString(vp1)}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
        }
        t3 = t2;
      }
      res4 = t3;
    } else {
      var vX$case1 = null;
      vX$case1 = toRight(res1);
      res4 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": ""})};
    }
    return res4;
  }
  init(context) {
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate_0 = vstate;
    var vlemit = vemit;
    var vlstate = {"$class": "org.accordproject.cicero.contract.AccordContractState", "stateId": "1"};
    return {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": {"$class": "org.accordproject.cicero.runtime.Response"}}))};
  }
  latedeliveryandpenalty(context) {
    var vnow = deref(context, "now");
    var vrequest = deref(context, "request");
    var vcontract = deref(context, "contract");
    var vemit = deref(context, "emit");
    var vstate = deref(context, "state");
    var vlstate = vstate;
    var vlemit = vemit;
    var vagreed = deref(unbrand(vrequest), "agreedDelivery");
    var vp2 = vnow;
    var vp1 = vagreed;
    var t2;
    if (!(dateTimePointLt(vp1, vp2))) {
      t2 = {"right" : brand(["org.accordproject.latedeliveryandpenalty.Error"],{"message": "Cannot exercise late delivery before delivery date"})};
    } else {
      var t1;
      if (!((!(deref(unbrand(vcontract), "forceMajeure")) || !(deref(unbrand(vrequest), "forceMajeure"))))) {
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"buyerMayTerminate": true}, {"penalty": 0.0}))}))};
      } else {
        var vp2 = vagreed;
        var vp1 = vnow;
        var vdiff = dateTimeDurationDays(vp1, vp2);
        var vshipSize = brand(["org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable"],concat({"terms": []}, concat({"description": "Ship size"}, {"InputVariableId": "1"})));
        var vfuzzyModel = brand(["org.accordproject.latedeliveryandpenalty.FuzzyModel"],concat({"fuzzyRules": [vshipSize]}, {"inputVariables": []}));
        var voutput = deref(unbrand(vfuzzyModel), "fuzzyRules");
        var vp1 = voutput;
        t1 = {"left" : concat({"emit": vlemit}, concat({"state": vlstate}, {"response": brand(["org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse"],concat({"aaa": toString(vp1)}, concat({"buyerMayTerminate": true}, {"penalty": 100.0})))}))};
      }
      t2 = t1;
    }
    return t2;
  }
}

/*eslint-enable no-unused-vars*/
/*eslint-enable no-undef*/



14:13:48 - [34mdebug[39m: fromDirectory
14:13:48 - [34mdebug[39m: isFileInNodeModuleDir
14:13:48 - [34mdebug[39m: processFile
14:13:48 - [34mdebug[39m: isFileInNodeModuleDir
14:13:48 - [34mdebug[39m: processFile
14:13:48 - [34mdebug[39m: isFileInNodeModuleDir
14:13:48 - [34mdebug[39m: processFile
14:13:48 - [34mdebug[39m: isFileInNodeModuleDir
14:13:48 - [34mdebug[39m: processFile
14:13:48 - [34mdebug[39m: isFileInNodeModuleDir
14:13:48 - [34mdebug[39m: processFile
14:13:48 - [34mdebug[39m: isFileInNodeModuleDir
14:13:48 - [34mdebug[39m: processFile
14:13:48 - [34mdebug[39m: isFileInNodeModuleDir
14:13:48 - [34mdebug[39m: processFile
14:13:48 - [34mdebug[39m: isFileInNodeModuleDir
14:13:48 - [34mdebug[39m: processFile
14:13:48 - [34mdebug[39m: isFileInNodeModuleDir
14:13:48 - [34mdebug[39m: processFile
14:13:48 - [34mdebug[39m: isFileInNodeModuleDir
14:13:48 - [34mdebug[39m: processFile
14:13:48 - [34mdebug[39m: isFileInNodeModuleDir
14:13:48 - [34mdebug[39m: processFile
14:13:48 - [34mdebug[39m: fromDirectory
14:13:48 - [34mdebug[39m: buildGrammar
14:13:48 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
14:13:48 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
14:13:48 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
14:13:48 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
14:13:48 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
14:13:48 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
14:13:48 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
14:13:48 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
14:13:48 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
14:13:48 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
14:13:48 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
14:13:48 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
14:13:48 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
14:13:48 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
14:13:48 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
14:13:48 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
14:13:48 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "2f5abf8c-1138-4e64-8bc5-8c685624ffa9",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
14:13:48 - [34mdebug[39m: fromDirectory
14:13:48 - [34mdebug[39m: fromDirectory
14:13:48 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"2f5abf8c-1138-4e64-8bc5-8c685624ffa9","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
14:13:48 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"2f5abf8c-1138-4e64-8bc5-8c685624ffa9","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
14:13:48 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
14:13:48 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                LateDeliveryAndPenalty_latedeliveryandpenalty(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
14:13:48 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
14:13:48 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-13e519afaaad7de723aa06fd89c0004f25a344c55451ce503e96df1f1e445b8c[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m100[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[35m[{terms: [], description: Ship size, InputVariableId: 1, $class: org.accordproject.latedeliveryandpenalty.FuzzyLinguisticVariable}][39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m1ee007b3-e22f-4aeb-b907-fe3685d38148[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-09T12:13:48.460Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
21:50:32 - [32minfo[39m: Using current directory as template folder
21:50:32 - [32minfo[39m: Loading a default sample.txt file.
21:50:32 - [32minfo[39m: Loading a single default request.json file.
21:50:32 - [32minfo[39m: Loading a default state.json file.
21:50:32 - [34mdebug[39m: fromDirectory
21:50:32 - [34mdebug[39m: fromDirectory
21:50:32 - [34mdebug[39m: fromDirectory
21:50:32 - [34mdebug[39m: fromDirectory
21:50:32 - [34mdebug[39m: fromDirectory
21:50:32 - [34mdebug[39m: fromDirectory
21:50:32 - [34mdebug[39m: fromDirectory
21:50:32 - [34mdebug[39m: constructor
21:50:32 - [34mdebug[39m: constructor
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processDirectory
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: fromDirectory
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: fromDirectory
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:32 - [34mdebug[39m: isFileInNodeModuleDir
21:50:32 - [34mdebug[39m: processFile
21:50:37 - [34mdebug[39m: fromDirectory
21:50:37 - [34mdebug[39m: isFileInNodeModuleDir
21:50:37 - [34mdebug[39m: isFileInNodeModuleDir
21:50:37 - [34mdebug[39m: isFileInNodeModuleDir
21:50:37 - [34mdebug[39m: isFileInNodeModuleDir
21:50:37 - [34mdebug[39m: isFileInNodeModuleDir
21:50:37 - [34mdebug[39m: processDirectory
21:50:37 - [34mdebug[39m: isFileInNodeModuleDir
21:50:37 - [34mdebug[39m: processFile
21:50:37 - [34mdebug[39m: isFileInNodeModuleDir
21:50:37 - [34mdebug[39m: processFile
21:50:37 - [34mdebug[39m: isFileInNodeModuleDir
21:50:37 - [34mdebug[39m: processFile
21:50:37 - [34mdebug[39m: isFileInNodeModuleDir
21:50:37 - [34mdebug[39m: processFile
21:50:37 - [34mdebug[39m: isFileInNodeModuleDir
21:50:37 - [34mdebug[39m: processFile
21:50:37 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/FuzzySystem.js: Malformed JSDoc comment: *
    * @param [rules] rules - the Variable to add to inputVariables
    *

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/FuzzySystem.js: Malformed JSDoc comment: *
    * @param [rules] rules - the Variable to add to inputVariables
    *

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
21:50:37 - [32minfo[39m: undefined
21:50:58 - [32minfo[39m: Using current directory as template folder
21:50:58 - [32minfo[39m: Loading a default sample.txt file.
21:50:58 - [32minfo[39m: Loading a single default request.json file.
21:50:58 - [32minfo[39m: Loading a default state.json file.
21:50:58 - [34mdebug[39m: fromDirectory
21:50:58 - [34mdebug[39m: fromDirectory
21:50:58 - [34mdebug[39m: fromDirectory
21:50:58 - [34mdebug[39m: fromDirectory
21:50:58 - [34mdebug[39m: fromDirectory
21:50:58 - [34mdebug[39m: fromDirectory
21:50:58 - [34mdebug[39m: fromDirectory
21:50:58 - [34mdebug[39m: constructor
21:50:58 - [34mdebug[39m: constructor
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processDirectory
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: fromDirectory
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: fromDirectory
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:50:58 - [34mdebug[39m: isFileInNodeModuleDir
21:50:58 - [34mdebug[39m: processFile
21:51:01 - [34mdebug[39m: fromDirectory
21:51:01 - [34mdebug[39m: isFileInNodeModuleDir
21:51:01 - [34mdebug[39m: isFileInNodeModuleDir
21:51:01 - [34mdebug[39m: isFileInNodeModuleDir
21:51:01 - [34mdebug[39m: isFileInNodeModuleDir
21:51:01 - [34mdebug[39m: isFileInNodeModuleDir
21:51:01 - [34mdebug[39m: processDirectory
21:51:01 - [34mdebug[39m: isFileInNodeModuleDir
21:51:01 - [34mdebug[39m: processFile
21:51:01 - [34mdebug[39m: isFileInNodeModuleDir
21:51:01 - [34mdebug[39m: processFile
21:51:01 - [34mdebug[39m: isFileInNodeModuleDir
21:51:01 - [34mdebug[39m: processFile
21:51:01 - [34mdebug[39m: isFileInNodeModuleDir
21:51:01 - [34mdebug[39m: processFile
21:51:01 - [34mdebug[39m: isFileInNodeModuleDir
21:51:01 - [34mdebug[39m: processFile
21:51:01 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/FuzzySystem.js: Malformed JSDoc comment: *
    * @param [rules] rules - the Variable to add to inputVariables
    *

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/FuzzySystem.js: Malformed JSDoc comment: *
    * @param [rules] rules - the Variable to add to inputVariables
    *

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
21:51:01 - [32minfo[39m: undefined
22:01:23 - [32minfo[39m: Using current directory as template folder
22:01:23 - [32minfo[39m: Loading a default sample.txt file.
22:01:23 - [34mdebug[39m: fromDirectory
22:01:23 - [34mdebug[39m: fromDirectory
22:01:23 - [34mdebug[39m: fromDirectory
22:01:23 - [34mdebug[39m: fromDirectory
22:01:23 - [34mdebug[39m: fromDirectory
22:01:23 - [34mdebug[39m: fromDirectory
22:01:23 - [34mdebug[39m: fromDirectory
22:01:23 - [34mdebug[39m: constructor
22:01:23 - [34mdebug[39m: constructor
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processDirectory
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: fromDirectory
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: fromDirectory
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:23 - [34mdebug[39m: isFileInNodeModuleDir
22:01:23 - [34mdebug[39m: processFile
22:01:51 - [34mdebug[39m: fromDirectory
22:01:51 - [34mdebug[39m: isFileInNodeModuleDir
22:01:51 - [34mdebug[39m: isFileInNodeModuleDir
22:01:51 - [34mdebug[39m: isFileInNodeModuleDir
22:01:51 - [34mdebug[39m: isFileInNodeModuleDir
22:01:51 - [34mdebug[39m: isFileInNodeModuleDir
22:01:51 - [34mdebug[39m: processDirectory
22:01:51 - [34mdebug[39m: isFileInNodeModuleDir
22:01:51 - [34mdebug[39m: processFile
22:01:51 - [34mdebug[39m: isFileInNodeModuleDir
22:01:51 - [34mdebug[39m: processFile
22:01:51 - [34mdebug[39m: isFileInNodeModuleDir
22:01:51 - [34mdebug[39m: processFile
22:01:51 - [34mdebug[39m: isFileInNodeModuleDir
22:01:51 - [34mdebug[39m: processFile
22:01:51 - [34mdebug[39m: isFileInNodeModuleDir
22:01:51 - [34mdebug[39m: processFile
22:01:51 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/FuzzySystem.js: Malformed JSDoc comment: *
    * @param [rules] rules - the Variable to add to inputVariables
    *

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/FuzzySystem.js: Malformed JSDoc comment: *
    * @param [rules] rules - the Variable to add to inputVariables
    *

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
22:01:51 - [32minfo[39m: undefined
22:07:11 - [32minfo[39m: Using current directory as template folder
22:07:11 - [32minfo[39m: Loading a default sample.txt file.
22:07:11 - [34mdebug[39m: fromDirectory
22:07:11 - [34mdebug[39m: fromDirectory
22:07:11 - [34mdebug[39m: fromDirectory
22:07:11 - [34mdebug[39m: fromDirectory
22:07:11 - [34mdebug[39m: fromDirectory
22:07:11 - [34mdebug[39m: fromDirectory
22:07:11 - [34mdebug[39m: fromDirectory
22:07:12 - [34mdebug[39m: constructor
22:07:12 - [34mdebug[39m: constructor
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processDirectory
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: fromDirectory
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: fromDirectory
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:12 - [34mdebug[39m: isFileInNodeModuleDir
22:07:12 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: fromDirectory
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processDirectory
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: fromDirectory
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: isFileInNodeModuleDir
22:07:16 - [34mdebug[39m: processFile
22:07:16 - [34mdebug[39m: fromDirectory
22:07:16 - [34mdebug[39m: buildGrammar
22:07:16 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
22:07:16 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
22:07:16 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
22:07:16 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
22:07:16 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
22:07:16 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
22:07:16 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
22:07:16 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
22:07:16 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
22:07:16 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
22:07:16 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
22:07:16 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
22:07:16 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
22:07:16 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
22:07:16 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
22:07:16 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
22:07:16 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "2c94d79f-48de-416c-ae69-b641a09df5ad",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
22:07:16 - [34mdebug[39m: fromDirectory
22:07:16 - [34mdebug[39m: fromDirectory
22:07:16 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"2c94d79f-48de-416c-ae69-b641a09df5ad","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:07:16 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"2c94d79f-48de-416c-ae69-b641a09df5ad","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:07:16 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause[39m[33m"[39m[33m,[39m
  [33m"[39m[32mclauseId[39m[33m"[39m[33m: [39m[33m"[39m[35m2c94d79f-48de-416c-ae69-b641a09df5ad[39m[33m"[39m[33m,[39m
  [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32muncertainPenalty[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
  [33m"[39m[32mpenaltyPercentage[39m[33m"[39m[33m: [39m[36m10.5[39m[33m,[39m
  [33m"[39m[32mcapPercentage[39m[33m"[39m[33m: [39m[36m55[39m[33m,[39m
  [33m"[39m[32mtermination[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.time.Duration[39m[33m"[39m[33m,[39m
    [33m"[39m[32mamount[39m[33m"[39m[33m: [39m[36m15[39m[33m,[39m
    [33m"[39m[32munit[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mfractionalPart[39m[33m"[39m[33m: [39m[33m"[39m[35mdays[39m[33m"[39m
[33m}[39m
22:07:22 - [32minfo[39m: Using current directory as template folder
22:07:22 - [32minfo[39m: Loading a default sample.txt file.
22:07:22 - [32minfo[39m: Loading a single default request.json file.
22:07:22 - [32minfo[39m: Loading a default state.json file.
22:07:22 - [34mdebug[39m: fromDirectory
22:07:22 - [34mdebug[39m: fromDirectory
22:07:22 - [34mdebug[39m: fromDirectory
22:07:22 - [34mdebug[39m: fromDirectory
22:07:22 - [34mdebug[39m: fromDirectory
22:07:22 - [34mdebug[39m: fromDirectory
22:07:22 - [34mdebug[39m: fromDirectory
22:07:22 - [34mdebug[39m: constructor
22:07:22 - [34mdebug[39m: constructor
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processDirectory
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: fromDirectory
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: fromDirectory
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:22 - [34mdebug[39m: isFileInNodeModuleDir
22:07:22 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: fromDirectory
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processDirectory
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: fromDirectory
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: isFileInNodeModuleDir
22:07:23 - [34mdebug[39m: processFile
22:07:23 - [34mdebug[39m: fromDirectory
22:07:23 - [34mdebug[39m: buildGrammar
22:07:23 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
22:07:23 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
22:07:23 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
22:07:23 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
22:07:23 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
22:07:23 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
22:07:23 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
22:07:23 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
22:07:23 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
22:07:23 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
22:07:23 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
22:07:23 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
22:07:23 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
22:07:23 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
22:07:23 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
22:07:23 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
22:07:23 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "ae7ce574-a9d5-42cd-b9b3-a0d20b3b4cdb",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
22:07:23 - [34mdebug[39m: fromDirectory
22:07:23 - [34mdebug[39m: fromDirectory
22:07:23 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"ae7ce574-a9d5-42cd-b9b3-a0d20b3b4cdb","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:07:23 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"ae7ce574-a9d5-42cd-b9b3-a0d20b3b4cdb","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:07:23 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
22:07:23 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
22:07:23 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
22:07:23 - [32minfo[39m: CICERO-ENGINE
22:07:23 - [31merror[39m: Model violation in instance org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse#1c1b4ead-253f-4ec2-9e35-e5303e18ba01 field aaa has value org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause#ae7ce574-a9d5-42cd-b9b3-a0d20b3b4cdb (org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause) expected type String
ValidationException: Model violation in instance org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse#1c1b4ead-253f-4ec2-9e35-e5303e18ba01 field aaa has value org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause#ae7ce574-a9d5-42cd-b9b3-a0d20b3b4cdb (org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause) expected type String
    at Function.reportFieldTypeViolation (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer/resourcevalidator.js:433:15)
    at ResourceValidator.checkItem (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer/resourcevalidator.js:321:35)
    at ResourceValidator.visitField (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer/resourcevalidator.js:223:22)
    at ResourceValidator.visit (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer/resourcevalidator.js:80:25)
    at Field.accept (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/decorated.js:54:24)
    at ResourceValidator.visitClassDeclaration (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer/resourcevalidator.js:176:26)
    at ResourceValidator.visit (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer/resourcevalidator.js:76:25)
    at TransactionDeclaration.accept (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/decorated.js:54:24)
    at ValidatedResource.validate (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/model/validatedresource.js:124:26)
    at Engine.execute (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-engine/lib/engine.js:243:25)
22:07:23 - [32minfo[39m: undefined
22:10:33 - [32minfo[39m: Using current directory as template folder
22:10:33 - [32minfo[39m: Loading a default sample.txt file.
22:10:33 - [34mdebug[39m: fromDirectory
22:10:33 - [34mdebug[39m: fromDirectory
22:10:33 - [34mdebug[39m: fromDirectory
22:10:33 - [34mdebug[39m: fromDirectory
22:10:33 - [34mdebug[39m: fromDirectory
22:10:33 - [34mdebug[39m: fromDirectory
22:10:33 - [34mdebug[39m: fromDirectory
22:10:33 - [34mdebug[39m: constructor
22:10:33 - [34mdebug[39m: constructor
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processDirectory
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: fromDirectory
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: fromDirectory
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:33 - [34mdebug[39m: isFileInNodeModuleDir
22:10:33 - [34mdebug[39m: processFile
22:10:34 - [34mdebug[39m: fromDirectory
22:10:34 - [34mdebug[39m: isFileInNodeModuleDir
22:10:34 - [34mdebug[39m: isFileInNodeModuleDir
22:10:34 - [34mdebug[39m: isFileInNodeModuleDir
22:10:34 - [34mdebug[39m: isFileInNodeModuleDir
22:10:34 - [34mdebug[39m: isFileInNodeModuleDir
22:10:34 - [34mdebug[39m: isFileInNodeModuleDir
22:10:34 - [34mdebug[39m: processDirectory
22:10:34 - [34mdebug[39m: isFileInNodeModuleDir
22:10:34 - [34mdebug[39m: processFile
22:10:34 - [34mdebug[39m: isFileInNodeModuleDir
22:10:34 - [34mdebug[39m: processFile
22:10:34 - [34mdebug[39m: isFileInNodeModuleDir
22:10:34 - [34mdebug[39m: processFile
22:10:34 - [34mdebug[39m: isFileInNodeModuleDir
22:10:34 - [34mdebug[39m: processFile
22:10:34 - [34mdebug[39m: isFileInNodeModuleDir
22:10:34 - [34mdebug[39m: processFile
22:10:34 - [34mdebug[39m: isFileInNodeModuleDir
22:10:34 - [34mdebug[39m: processFile
22:10:34 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
22:10:34 - [32minfo[39m: undefined
22:10:52 - [32minfo[39m: Using current directory as template folder
22:10:52 - [32minfo[39m: Loading a default sample.txt file.
22:10:52 - [32minfo[39m: Loading a single default request.json file.
22:10:52 - [32minfo[39m: Loading a default state.json file.
22:10:52 - [34mdebug[39m: fromDirectory
22:10:52 - [34mdebug[39m: fromDirectory
22:10:52 - [34mdebug[39m: fromDirectory
22:10:52 - [34mdebug[39m: fromDirectory
22:10:52 - [34mdebug[39m: fromDirectory
22:10:52 - [34mdebug[39m: fromDirectory
22:10:52 - [34mdebug[39m: fromDirectory
22:10:52 - [34mdebug[39m: constructor
22:10:52 - [34mdebug[39m: constructor
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processDirectory
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: fromDirectory
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: fromDirectory
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:52 - [34mdebug[39m: isFileInNodeModuleDir
22:10:52 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: fromDirectory
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processDirectory
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: fromDirectory
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: isFileInNodeModuleDir
22:10:53 - [34mdebug[39m: processFile
22:10:53 - [34mdebug[39m: fromDirectory
22:10:53 - [34mdebug[39m: buildGrammar
22:10:53 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
22:10:53 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
22:10:53 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
22:10:53 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
22:10:53 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
22:10:53 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
22:10:53 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
22:10:53 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
22:10:53 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
22:10:53 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
22:10:53 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
22:10:53 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
22:10:53 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
22:10:53 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
22:10:53 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
22:10:53 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
22:10:53 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "be0eaad3-eebe-4553-92af-107bd7bb4863",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
22:10:53 - [34mdebug[39m: fromDirectory
22:10:53 - [34mdebug[39m: fromDirectory
22:10:53 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"be0eaad3-eebe-4553-92af-107bd7bb4863","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:10:53 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"be0eaad3-eebe-4553-92af-107bd7bb4863","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:10:53 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
22:10:53 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
22:10:53 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
22:10:53 - [32minfo[39m: CICERO-ENGINE
22:10:53 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-f0919838a91c3672c2edb82296b005b82a28c615dc012fe770a657fb011955f9[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m1340[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[33m"[39m[35mHello[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35mda6fcfad-1410-48e3-8dae-f422894e85c6[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-12T20:10:53.670Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
22:11:55 - [32minfo[39m: Using current directory as template folder
22:11:55 - [32minfo[39m: Loading a default sample.txt file.
22:11:55 - [32minfo[39m: Loading a single default request.json file.
22:11:55 - [32minfo[39m: Loading a default state.json file.
22:11:55 - [34mdebug[39m: fromDirectory
22:11:55 - [34mdebug[39m: fromDirectory
22:11:55 - [34mdebug[39m: fromDirectory
22:11:55 - [34mdebug[39m: fromDirectory
22:11:55 - [34mdebug[39m: fromDirectory
22:11:55 - [34mdebug[39m: fromDirectory
22:11:55 - [34mdebug[39m: fromDirectory
22:11:55 - [34mdebug[39m: constructor
22:11:55 - [34mdebug[39m: constructor
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processDirectory
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: fromDirectory
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: fromDirectory
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:55 - [34mdebug[39m: isFileInNodeModuleDir
22:11:55 - [34mdebug[39m: processFile
22:11:56 - [34mdebug[39m: fromDirectory
22:11:56 - [34mdebug[39m: isFileInNodeModuleDir
22:11:56 - [34mdebug[39m: isFileInNodeModuleDir
22:11:56 - [34mdebug[39m: isFileInNodeModuleDir
22:11:56 - [34mdebug[39m: isFileInNodeModuleDir
22:11:56 - [34mdebug[39m: isFileInNodeModuleDir
22:11:56 - [34mdebug[39m: isFileInNodeModuleDir
22:11:56 - [34mdebug[39m: processDirectory
22:11:56 - [34mdebug[39m: isFileInNodeModuleDir
22:11:56 - [34mdebug[39m: processFile
22:11:56 - [34mdebug[39m: isFileInNodeModuleDir
22:11:56 - [34mdebug[39m: processFile
22:11:56 - [34mdebug[39m: isFileInNodeModuleDir
22:11:56 - [34mdebug[39m: processFile
22:11:56 - [34mdebug[39m: isFileInNodeModuleDir
22:11:56 - [34mdebug[39m: processFile
22:11:56 - [34mdebug[39m: isFileInNodeModuleDir
22:11:56 - [34mdebug[39m: processFile
22:11:56 - [34mdebug[39m: isFileInNodeModuleDir
22:11:56 - [34mdebug[39m: processFile
22:11:56 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
22:11:56 - [32minfo[39m: undefined
22:12:28 - [32minfo[39m: Using current directory as template folder
22:12:28 - [32minfo[39m: Loading a default sample.txt file.
22:12:28 - [32minfo[39m: Loading a single default request.json file.
22:12:28 - [32minfo[39m: Loading a default state.json file.
22:12:28 - [34mdebug[39m: fromDirectory
22:12:28 - [34mdebug[39m: fromDirectory
22:12:28 - [34mdebug[39m: fromDirectory
22:12:28 - [34mdebug[39m: fromDirectory
22:12:28 - [34mdebug[39m: fromDirectory
22:12:28 - [34mdebug[39m: fromDirectory
22:12:28 - [34mdebug[39m: fromDirectory
22:12:28 - [34mdebug[39m: constructor
22:12:28 - [34mdebug[39m: constructor
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processDirectory
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: fromDirectory
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: fromDirectory
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:28 - [34mdebug[39m: isFileInNodeModuleDir
22:12:28 - [34mdebug[39m: processFile
22:12:29 - [34mdebug[39m: fromDirectory
22:12:29 - [34mdebug[39m: isFileInNodeModuleDir
22:12:29 - [34mdebug[39m: isFileInNodeModuleDir
22:12:29 - [34mdebug[39m: isFileInNodeModuleDir
22:12:29 - [34mdebug[39m: isFileInNodeModuleDir
22:12:29 - [34mdebug[39m: isFileInNodeModuleDir
22:12:29 - [34mdebug[39m: isFileInNodeModuleDir
22:12:29 - [34mdebug[39m: processDirectory
22:12:29 - [34mdebug[39m: isFileInNodeModuleDir
22:12:29 - [34mdebug[39m: processFile
22:12:29 - [34mdebug[39m: isFileInNodeModuleDir
22:12:29 - [34mdebug[39m: processFile
22:12:29 - [34mdebug[39m: isFileInNodeModuleDir
22:12:29 - [34mdebug[39m: processFile
22:12:29 - [34mdebug[39m: isFileInNodeModuleDir
22:12:29 - [34mdebug[39m: processFile
22:12:29 - [34mdebug[39m: isFileInNodeModuleDir
22:12:29 - [34mdebug[39m: processFile
22:12:29 - [34mdebug[39m: isFileInNodeModuleDir
22:12:29 - [34mdebug[39m: processFile
22:12:29 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
22:12:29 - [32minfo[39m: undefined
22:41:11 - [32minfo[39m: Using current directory as template folder
22:41:11 - [32minfo[39m: Loading a default sample.txt file.
22:41:11 - [32minfo[39m: Loading a single default request.json file.
22:41:11 - [32minfo[39m: Loading a default state.json file.
22:41:11 - [34mdebug[39m: fromDirectory
22:41:11 - [34mdebug[39m: fromDirectory
22:41:11 - [34mdebug[39m: fromDirectory
22:41:11 - [34mdebug[39m: fromDirectory
22:41:11 - [34mdebug[39m: fromDirectory
22:41:11 - [34mdebug[39m: fromDirectory
22:41:11 - [34mdebug[39m: fromDirectory
22:41:11 - [34mdebug[39m: constructor
22:41:11 - [34mdebug[39m: constructor
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processDirectory
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: fromDirectory
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: fromDirectory
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:11 - [34mdebug[39m: isFileInNodeModuleDir
22:41:11 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: fromDirectory
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processDirectory
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: fromDirectory
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: isFileInNodeModuleDir
22:41:12 - [34mdebug[39m: processFile
22:41:12 - [34mdebug[39m: fromDirectory
22:41:12 - [34mdebug[39m: buildGrammar
22:41:12 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
22:41:12 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
22:41:12 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
22:41:12 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
22:41:12 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
22:41:12 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
22:41:12 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
22:41:12 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
22:41:12 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
22:41:12 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
22:41:12 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
22:41:12 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
22:41:12 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
22:41:12 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
22:41:12 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
22:41:12 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
22:41:12 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "11347491-99cc-4726-b0a3-e209ba4fbdd4",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
22:41:12 - [34mdebug[39m: fromDirectory
22:41:12 - [34mdebug[39m: fromDirectory
22:41:12 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"11347491-99cc-4726-b0a3-e209ba4fbdd4","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:41:12 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"11347491-99cc-4726-b0a3-e209ba4fbdd4","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
22:41:12 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
22:41:12 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
22:41:12 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
22:41:12 - [31merror[39m: require is not defined
ReferenceError: require is not defined
    at vm.js:3:20
    at Script.runInContext (vm.js:102:20)
    at VM.run (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/vm2/lib/main.js:211:72)
    at Engine.execute (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-engine/lib/engine.js:239:27)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:151:45)
    at process._tickCallback (internal/process/next_tick.js:68:7)
22:41:12 - [32minfo[39m: undefined
10:26:27 - [32minfo[39m: Using current directory as template folder
10:26:27 - [32minfo[39m: Loading a default sample.txt file.
10:26:27 - [32minfo[39m: Loading a single default request.json file.
10:26:27 - [32minfo[39m: Loading a default state.json file.
10:26:27 - [34mdebug[39m: fromDirectory
10:26:27 - [34mdebug[39m: fromDirectory
10:26:27 - [34mdebug[39m: fromDirectory
10:26:27 - [34mdebug[39m: fromDirectory
10:26:27 - [34mdebug[39m: fromDirectory
10:26:27 - [34mdebug[39m: fromDirectory
10:26:27 - [34mdebug[39m: fromDirectory
10:26:27 - [34mdebug[39m: constructor
10:26:27 - [34mdebug[39m: constructor
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processDirectory
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: fromDirectory
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: fromDirectory
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:27 - [34mdebug[39m: isFileInNodeModuleDir
10:26:27 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: fromDirectory
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processDirectory
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: fromDirectory
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: isFileInNodeModuleDir
10:26:28 - [34mdebug[39m: processFile
10:26:28 - [34mdebug[39m: fromDirectory
10:26:28 - [34mdebug[39m: buildGrammar
10:26:28 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
10:26:28 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
10:26:28 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
10:26:28 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
10:26:28 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
10:26:28 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
10:26:28 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
10:26:28 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
10:26:28 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
10:26:28 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
10:26:28 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
10:26:28 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
10:26:28 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
10:26:28 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
10:26:28 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
10:26:28 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
10:26:28 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "019da3f5-eed0-455c-b95e-65c0026e51ab",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
10:26:28 - [34mdebug[39m: fromDirectory
10:26:28 - [34mdebug[39m: fromDirectory
10:26:28 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"019da3f5-eed0-455c-b95e-65c0026e51ab","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:26:28 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"019da3f5-eed0-455c-b95e-65c0026e51ab","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:26:28 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
10:26:28 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
10:26:28 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
10:26:28 - [31merror[39m: require is not defined
ReferenceError: require is not defined
    at vm.js:3:20
    at Script.runInContext (vm.js:102:20)
    at VM.run (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/vm2/lib/main.js:211:72)
    at Engine.execute (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-engine/lib/engine.js:239:27)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:151:45)
    at process._tickCallback (internal/process/next_tick.js:68:7)
10:26:28 - [32minfo[39m: undefined
10:27:06 - [32minfo[39m: Using current directory as template folder
10:27:06 - [32minfo[39m: Loading a default sample.txt file.
10:27:06 - [32minfo[39m: Loading a single default request.json file.
10:27:06 - [32minfo[39m: Loading a default state.json file.
10:27:06 - [34mdebug[39m: fromDirectory
10:27:06 - [34mdebug[39m: fromDirectory
10:27:06 - [34mdebug[39m: fromDirectory
10:27:06 - [34mdebug[39m: fromDirectory
10:27:06 - [34mdebug[39m: fromDirectory
10:27:06 - [34mdebug[39m: fromDirectory
10:27:06 - [34mdebug[39m: fromDirectory
10:27:06 - [34mdebug[39m: constructor
10:27:06 - [34mdebug[39m: constructor
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processDirectory
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: fromDirectory
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: fromDirectory
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:06 - [34mdebug[39m: isFileInNodeModuleDir
10:27:06 - [34mdebug[39m: processFile
10:27:07 - [34mdebug[39m: fromDirectory
10:27:07 - [34mdebug[39m: isFileInNodeModuleDir
10:27:07 - [34mdebug[39m: isFileInNodeModuleDir
10:27:07 - [34mdebug[39m: isFileInNodeModuleDir
10:27:07 - [34mdebug[39m: isFileInNodeModuleDir
10:27:07 - [34mdebug[39m: isFileInNodeModuleDir
10:27:07 - [34mdebug[39m: isFileInNodeModuleDir
10:27:07 - [34mdebug[39m: processDirectory
10:27:07 - [34mdebug[39m: isFileInNodeModuleDir
10:27:07 - [34mdebug[39m: processFile
10:27:07 - [34mdebug[39m: isFileInNodeModuleDir
10:27:07 - [34mdebug[39m: processFile
10:27:07 - [34mdebug[39m: isFileInNodeModuleDir
10:27:07 - [34mdebug[39m: processFile
10:27:07 - [34mdebug[39m: isFileInNodeModuleDir
10:27:07 - [34mdebug[39m: processFile
10:27:07 - [34mdebug[39m: isFileInNodeModuleDir
10:27:07 - [34mdebug[39m: processFile
10:27:07 - [34mdebug[39m: isFileInNodeModuleDir
10:27:07 - [34mdebug[39m: processFile
10:27:07 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
10:27:07 - [32minfo[39m: undefined
10:29:25 - [32minfo[39m: Using current directory as template folder
10:29:25 - [32minfo[39m: Loading a default sample.txt file.
10:29:25 - [32minfo[39m: Loading a single default request.json file.
10:29:25 - [32minfo[39m: Loading a default state.json file.
10:29:25 - [34mdebug[39m: fromDirectory
10:29:25 - [34mdebug[39m: fromDirectory
10:29:25 - [34mdebug[39m: fromDirectory
10:29:25 - [34mdebug[39m: fromDirectory
10:29:25 - [34mdebug[39m: fromDirectory
10:29:25 - [34mdebug[39m: fromDirectory
10:29:25 - [34mdebug[39m: fromDirectory
10:29:25 - [34mdebug[39m: constructor
10:29:25 - [34mdebug[39m: constructor
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processDirectory
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: fromDirectory
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: fromDirectory
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:25 - [34mdebug[39m: isFileInNodeModuleDir
10:29:25 - [34mdebug[39m: processFile
10:29:26 - [34mdebug[39m: fromDirectory
10:29:26 - [34mdebug[39m: isFileInNodeModuleDir
10:29:26 - [34mdebug[39m: isFileInNodeModuleDir
10:29:26 - [34mdebug[39m: isFileInNodeModuleDir
10:29:26 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processDirectory
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: fromDirectory
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: isFileInNodeModuleDir
10:29:27 - [34mdebug[39m: processFile
10:29:27 - [34mdebug[39m: fromDirectory
10:29:27 - [34mdebug[39m: buildGrammar
10:29:27 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
10:29:27 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
10:29:27 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
10:29:27 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
10:29:27 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
10:29:27 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
10:29:27 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
10:29:27 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
10:29:27 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
10:29:27 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
10:29:27 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
10:29:27 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
10:29:27 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
10:29:27 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
10:29:27 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
10:29:27 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
10:29:27 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "621eff3c-c1e4-4556-b1c2-0bba6ffc600a",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        transhipmentFigures : data[8],
        shipSize : data[10],
        malfunction : data[12],
        transactionId : data[14],
        timestamp : data[16]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
10:29:27 - [34mdebug[39m: fromDirectory
10:29:27 - [34mdebug[39m: fromDirectory
10:29:27 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"621eff3c-c1e4-4556-b1c2-0bba6ffc600a","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:29:27 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"621eff3c-c1e4-4556-b1c2-0bba6ffc600a","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:29:27 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
10:29:27 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
10:29:27 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
10:29:27 - [31merror[39m: require is not defined
ReferenceError: require is not defined
    at vm.js:3:1
    at Script.runInContext (vm.js:102:20)
    at VM.run (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/vm2/lib/main.js:211:72)
    at Engine.execute (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-engine/lib/engine.js:239:27)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:151:45)
    at process._tickCallback (internal/process/next_tick.js:68:7)
10:29:27 - [32minfo[39m: undefined
10:31:28 - [32minfo[39m: Using current directory as template folder
10:31:28 - [32minfo[39m: Loading a default sample.txt file.
10:31:28 - [32minfo[39m: Loading a single default request.json file.
10:31:28 - [32minfo[39m: Loading a default state.json file.
10:31:28 - [34mdebug[39m: fromDirectory
10:31:28 - [34mdebug[39m: fromDirectory
10:31:28 - [34mdebug[39m: fromDirectory
10:31:28 - [34mdebug[39m: fromDirectory
10:31:28 - [34mdebug[39m: fromDirectory
10:31:28 - [34mdebug[39m: fromDirectory
10:31:28 - [34mdebug[39m: fromDirectory
10:31:28 - [34mdebug[39m: constructor
10:31:28 - [34mdebug[39m: constructor
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processDirectory
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: fromDirectory
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: fromDirectory
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:28 - [34mdebug[39m: isFileInNodeModuleDir
10:31:28 - [34mdebug[39m: processFile
10:31:30 - [34mdebug[39m: fromDirectory
10:31:30 - [34mdebug[39m: isFileInNodeModuleDir
10:31:30 - [34mdebug[39m: isFileInNodeModuleDir
10:31:30 - [34mdebug[39m: isFileInNodeModuleDir
10:31:30 - [34mdebug[39m: isFileInNodeModuleDir
10:31:30 - [34mdebug[39m: isFileInNodeModuleDir
10:31:30 - [34mdebug[39m: isFileInNodeModuleDir
10:31:30 - [34mdebug[39m: processDirectory
10:31:30 - [34mdebug[39m: isFileInNodeModuleDir
10:31:30 - [34mdebug[39m: processFile
10:31:30 - [34mdebug[39m: isFileInNodeModuleDir
10:31:30 - [34mdebug[39m: processFile
10:31:30 - [34mdebug[39m: isFileInNodeModuleDir
10:31:30 - [34mdebug[39m: processFile
10:31:30 - [34mdebug[39m: isFileInNodeModuleDir
10:31:30 - [34mdebug[39m: processFile
10:31:30 - [34mdebug[39m: isFileInNodeModuleDir
10:31:30 - [34mdebug[39m: processFile
10:31:30 - [34mdebug[39m: isFileInNodeModuleDir
10:31:30 - [34mdebug[39m: processFile
10:31:30 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
10:31:30 - [32minfo[39m: undefined
10:35:27 - [32minfo[39m: Using current directory as template folder
10:35:27 - [32minfo[39m: Loading a default sample.txt file.
10:35:27 - [32minfo[39m: Loading a single default request.json file.
10:35:27 - [32minfo[39m: Loading a default state.json file.
10:35:27 - [34mdebug[39m: fromDirectory
10:35:27 - [34mdebug[39m: fromDirectory
10:35:27 - [34mdebug[39m: fromDirectory
10:35:27 - [34mdebug[39m: fromDirectory
10:35:27 - [34mdebug[39m: fromDirectory
10:35:27 - [34mdebug[39m: fromDirectory
10:35:27 - [34mdebug[39m: fromDirectory
10:35:27 - [34mdebug[39m: constructor
10:35:27 - [34mdebug[39m: constructor
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processDirectory
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: fromDirectory
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: fromDirectory
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:27 - [34mdebug[39m: isFileInNodeModuleDir
10:35:27 - [34mdebug[39m: processFile
10:35:28 - [34mdebug[39m: fromDirectory
10:35:28 - [34mdebug[39m: isFileInNodeModuleDir
10:35:28 - [34mdebug[39m: isFileInNodeModuleDir
10:35:28 - [34mdebug[39m: isFileInNodeModuleDir
10:35:28 - [34mdebug[39m: isFileInNodeModuleDir
10:35:28 - [34mdebug[39m: isFileInNodeModuleDir
10:35:28 - [34mdebug[39m: isFileInNodeModuleDir
10:35:28 - [34mdebug[39m: processDirectory
10:35:28 - [34mdebug[39m: isFileInNodeModuleDir
10:35:28 - [34mdebug[39m: processFile
10:35:28 - [34mdebug[39m: isFileInNodeModuleDir
10:35:28 - [34mdebug[39m: processFile
10:35:28 - [34mdebug[39m: isFileInNodeModuleDir
10:35:28 - [34mdebug[39m: processFile
10:35:28 - [34mdebug[39m: isFileInNodeModuleDir
10:35:28 - [34mdebug[39m: processFile
10:35:28 - [34mdebug[39m: isFileInNodeModuleDir
10:35:28 - [34mdebug[39m: processFile
10:35:28 - [34mdebug[39m: isFileInNodeModuleDir
10:35:28 - [34mdebug[39m: processFile
10:35:28 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
10:35:28 - [32minfo[39m: undefined
10:41:01 - [32minfo[39m: Using current directory as template folder
10:41:01 - [32minfo[39m: Loading a default sample.txt file.
10:41:01 - [32minfo[39m: Loading a single default request.json file.
10:41:01 - [32minfo[39m: Loading a default state.json file.
10:41:01 - [34mdebug[39m: fromDirectory
10:41:01 - [34mdebug[39m: fromDirectory
10:41:01 - [34mdebug[39m: fromDirectory
10:41:01 - [34mdebug[39m: fromDirectory
10:41:01 - [34mdebug[39m: fromDirectory
10:41:01 - [34mdebug[39m: fromDirectory
10:41:01 - [34mdebug[39m: fromDirectory
10:41:01 - [34mdebug[39m: constructor
10:41:01 - [34mdebug[39m: constructor
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processDirectory
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: fromDirectory
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: fromDirectory
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: fromDirectory
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processDirectory
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [34mdebug[39m: isFileInNodeModuleDir
10:41:01 - [34mdebug[39m: processFile
10:41:01 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
10:41:01 - [32minfo[39m: undefined
10:41:12 - [32minfo[39m: Using current directory as template folder
10:41:12 - [32minfo[39m: Loading a default sample.txt file.
10:41:12 - [32minfo[39m: Loading a single default request.json file.
10:41:12 - [32minfo[39m: Loading a default state.json file.
10:41:12 - [34mdebug[39m: fromDirectory
10:41:12 - [34mdebug[39m: fromDirectory
10:41:12 - [34mdebug[39m: fromDirectory
10:41:12 - [34mdebug[39m: fromDirectory
10:41:12 - [34mdebug[39m: fromDirectory
10:41:12 - [34mdebug[39m: fromDirectory
10:41:12 - [34mdebug[39m: fromDirectory
10:41:12 - [34mdebug[39m: constructor
10:41:12 - [34mdebug[39m: constructor
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processDirectory
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: fromDirectory
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: fromDirectory
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: fromDirectory
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processDirectory
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [34mdebug[39m: isFileInNodeModuleDir
10:41:12 - [34mdebug[39m: processFile
10:41:12 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
10:41:12 - [32minfo[39m: undefined
10:41:20 - [32minfo[39m: Using current directory as template folder
10:41:20 - [32minfo[39m: Loading a default sample.txt file.
10:41:20 - [32minfo[39m: Loading a single default request.json file.
10:41:20 - [32minfo[39m: Loading a default state.json file.
10:41:20 - [34mdebug[39m: fromDirectory
10:41:20 - [34mdebug[39m: fromDirectory
10:41:20 - [34mdebug[39m: fromDirectory
10:41:20 - [34mdebug[39m: fromDirectory
10:41:20 - [34mdebug[39m: fromDirectory
10:41:20 - [34mdebug[39m: fromDirectory
10:41:20 - [34mdebug[39m: fromDirectory
10:41:20 - [34mdebug[39m: constructor
10:41:20 - [34mdebug[39m: constructor
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processDirectory
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: fromDirectory
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: fromDirectory
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: fromDirectory
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processDirectory
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [34mdebug[39m: isFileInNodeModuleDir
10:41:20 - [34mdebug[39m: processFile
10:41:20 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
10:41:20 - [32minfo[39m: undefined
10:54:02 - [32minfo[39m: Using current directory as template folder
10:54:02 - [32minfo[39m: Loading a default sample.txt file.
10:54:02 - [32minfo[39m: Loading a single default request.json file.
10:54:02 - [32minfo[39m: Loading a default state.json file.
10:54:02 - [34mdebug[39m: fromDirectory
10:54:02 - [34mdebug[39m: fromDirectory
10:54:02 - [34mdebug[39m: fromDirectory
10:54:02 - [34mdebug[39m: fromDirectory
10:54:03 - [34mdebug[39m: fromDirectory
10:54:03 - [34mdebug[39m: fromDirectory
10:54:03 - [34mdebug[39m: fromDirectory
10:54:03 - [34mdebug[39m: constructor
10:54:03 - [34mdebug[39m: constructor
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processDirectory
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: fromDirectory
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: fromDirectory
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: fromDirectory
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processDirectory
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: fromDirectory
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: isFileInNodeModuleDir
10:54:03 - [34mdebug[39m: processFile
10:54:03 - [34mdebug[39m: fromDirectory
10:54:03 - [34mdebug[39m: buildGrammar
10:54:03 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
10:54:03 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
10:54:03 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
10:54:03 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
10:54:03 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
10:54:03 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
10:54:03 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
10:54:03 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
10:54:03 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
10:54:03 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
10:54:03 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
10:54:03 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
10:54:03 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
10:54:03 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
10:54:03 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
10:54:03 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
10:54:03 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "eb84fc5b-9ebc-4965-a9fd-4e7ff810d956",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Boolean:?  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        failure : data[8],
        transhipmentFigures : data[10],
        shipSize : data[12],
        malfunction : data[14],
        transactionId : data[16],
        timestamp : data[18]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
10:54:03 - [34mdebug[39m: fromDirectory
10:54:03 - [34mdebug[39m: fromDirectory
10:54:03 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"eb84fc5b-9ebc-4965-a9fd-4e7ff810d956","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:54:03 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"eb84fc5b-9ebc-4965-a9fd-4e7ff810d956","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:54:03 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
10:54:03 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
10:54:03 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
10:54:03 - [32minfo[39m: CICERO-ENGINE
10:54:03 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-da4de7e7decb08fb5bc842bcff5c2e22d40b32de103f4aba2eadab7b8a499ed0[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m1340[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m22079fc3-f56e-42db-bd35-c7fef1eded5a[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-13T08:54:03.803Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
10:55:04 - [32minfo[39m: Using current directory as template folder
10:55:04 - [32minfo[39m: Loading a default sample.txt file.
10:55:04 - [32minfo[39m: Loading a single default request.json file.
10:55:04 - [32minfo[39m: Loading a default state.json file.
10:55:04 - [34mdebug[39m: fromDirectory
10:55:04 - [34mdebug[39m: fromDirectory
10:55:04 - [34mdebug[39m: fromDirectory
10:55:04 - [34mdebug[39m: fromDirectory
10:55:04 - [34mdebug[39m: fromDirectory
10:55:04 - [34mdebug[39m: fromDirectory
10:55:04 - [34mdebug[39m: fromDirectory
10:55:04 - [34mdebug[39m: constructor
10:55:04 - [34mdebug[39m: constructor
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processDirectory
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: fromDirectory
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: fromDirectory
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:04 - [34mdebug[39m: isFileInNodeModuleDir
10:55:04 - [34mdebug[39m: processFile
10:55:05 - [34mdebug[39m: fromDirectory
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: processDirectory
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: processFile
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: processFile
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: processFile
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: processFile
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: processFile
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: processFile
10:55:05 - [34mdebug[39m: fromDirectory
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:05 - [34mdebug[39m: processFile
10:55:05 - [34mdebug[39m: isFileInNodeModuleDir
10:55:06 - [34mdebug[39m: processFile
10:55:06 - [34mdebug[39m: isFileInNodeModuleDir
10:55:06 - [34mdebug[39m: processFile
10:55:06 - [34mdebug[39m: isFileInNodeModuleDir
10:55:06 - [34mdebug[39m: processFile
10:55:06 - [34mdebug[39m: isFileInNodeModuleDir
10:55:06 - [34mdebug[39m: processFile
10:55:06 - [34mdebug[39m: isFileInNodeModuleDir
10:55:06 - [34mdebug[39m: processFile
10:55:06 - [34mdebug[39m: isFileInNodeModuleDir
10:55:06 - [34mdebug[39m: processFile
10:55:06 - [34mdebug[39m: isFileInNodeModuleDir
10:55:06 - [34mdebug[39m: processFile
10:55:06 - [34mdebug[39m: isFileInNodeModuleDir
10:55:06 - [34mdebug[39m: processFile
10:55:06 - [34mdebug[39m: isFileInNodeModuleDir
10:55:06 - [34mdebug[39m: processFile
10:55:06 - [34mdebug[39m: isFileInNodeModuleDir
10:55:06 - [34mdebug[39m: processFile
10:55:06 - [34mdebug[39m: fromDirectory
10:55:06 - [34mdebug[39m: buildGrammar
10:55:06 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
10:55:06 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
10:55:06 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
10:55:06 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
10:55:06 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
10:55:06 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
10:55:06 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
10:55:06 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
10:55:06 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
10:55:06 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
10:55:06 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
10:55:06 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
10:55:06 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
10:55:06 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
10:55:06 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
10:55:06 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
10:55:06 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "8bcc163d-f6d1-4fcf-a0e4-f92b8a2760f4",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Boolean:?  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        failure : data[8],
        transhipmentFigures : data[10],
        shipSize : data[12],
        malfunction : data[14],
        transactionId : data[16],
        timestamp : data[18]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
10:55:06 - [34mdebug[39m: fromDirectory
10:55:06 - [34mdebug[39m: fromDirectory
10:55:06 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"8bcc163d-f6d1-4fcf-a0e4-f92b8a2760f4","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:55:06 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"8bcc163d-f6d1-4fcf-a0e4-f92b8a2760f4","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:55:06 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
10:55:06 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
10:55:06 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
10:55:06 - [32minfo[39m: CICERO-ENGINE
10:55:06 - [31merror[39m: Cannot read property 'toString' of undefined
TypeError: Cannot read property 'toString' of undefined
    at execute (vm.js:16:50)
    at __dispatch (vm.js:324:17)
    at vm.js:313:9
    at Script.runInContext (vm.js:102:20)
    at VM.run (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/vm2/lib/main.js:211:72)
    at Engine.execute (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-engine/lib/engine.js:239:27)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:151:45)
    at process._tickCallback (internal/process/next_tick.js:68:7)
10:55:06 - [32minfo[39m: undefined
10:56:02 - [32minfo[39m: Using current directory as template folder
10:56:02 - [32minfo[39m: Loading a default sample.txt file.
10:56:02 - [32minfo[39m: Loading a single default request.json file.
10:56:02 - [32minfo[39m: Loading a default state.json file.
10:56:02 - [34mdebug[39m: fromDirectory
10:56:02 - [34mdebug[39m: fromDirectory
10:56:02 - [34mdebug[39m: fromDirectory
10:56:02 - [34mdebug[39m: fromDirectory
10:56:02 - [34mdebug[39m: fromDirectory
10:56:02 - [34mdebug[39m: fromDirectory
10:56:02 - [34mdebug[39m: fromDirectory
10:56:02 - [34mdebug[39m: constructor
10:56:02 - [34mdebug[39m: constructor
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processDirectory
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: fromDirectory
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: fromDirectory
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:02 - [34mdebug[39m: isFileInNodeModuleDir
10:56:02 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: fromDirectory
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processDirectory
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: fromDirectory
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: isFileInNodeModuleDir
10:56:03 - [34mdebug[39m: processFile
10:56:03 - [34mdebug[39m: fromDirectory
10:56:03 - [34mdebug[39m: buildGrammar
10:56:03 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
10:56:03 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
10:56:03 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
10:56:03 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
10:56:03 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
10:56:03 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
10:56:03 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
10:56:03 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
10:56:03 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
10:56:03 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
10:56:03 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
10:56:03 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
10:56:03 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
10:56:03 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
10:56:03 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
10:56:03 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
10:56:03 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "59382537-37d5-4723-a2a9-c7777887cf99",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Boolean:?  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        failure : data[8],
        transhipmentFigures : data[10],
        shipSize : data[12],
        malfunction : data[14],
        transactionId : data[16],
        timestamp : data[18]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  String:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
10:56:03 - [34mdebug[39m: fromDirectory
10:56:03 - [34mdebug[39m: fromDirectory
10:56:03 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"59382537-37d5-4723-a2a9-c7777887cf99","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:56:03 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"59382537-37d5-4723-a2a9-c7777887cf99","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:56:03 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
10:56:03 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
10:56:03 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
10:56:03 - [32minfo[39m: CICERO-ENGINE
10:56:03 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-831f3d5e8f2ef72aa4eca47a8f6758b5af10916b07107e3603a02f06ca70eb26[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m1340[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35mb204beec-f808-4bb1-8d4b-36acc7b0c704[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-13T08:56:03.492Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
10:56:29 - [32minfo[39m: Using current directory as template folder
10:56:29 - [32minfo[39m: Loading a default sample.txt file.
10:56:29 - [32minfo[39m: Loading a single default request.json file.
10:56:29 - [32minfo[39m: Loading a default state.json file.
10:56:29 - [34mdebug[39m: fromDirectory
10:56:29 - [34mdebug[39m: fromDirectory
10:56:29 - [34mdebug[39m: fromDirectory
10:56:29 - [34mdebug[39m: fromDirectory
10:56:29 - [34mdebug[39m: fromDirectory
10:56:29 - [34mdebug[39m: fromDirectory
10:56:29 - [34mdebug[39m: fromDirectory
10:56:29 - [34mdebug[39m: constructor
10:56:29 - [34mdebug[39m: constructor
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processDirectory
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: fromDirectory
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: fromDirectory
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:29 - [34mdebug[39m: isFileInNodeModuleDir
10:56:29 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: fromDirectory
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processDirectory
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: fromDirectory
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: isFileInNodeModuleDir
10:56:30 - [34mdebug[39m: processFile
10:56:30 - [34mdebug[39m: fromDirectory
10:56:30 - [34mdebug[39m: buildGrammar
10:56:30 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
10:56:30 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
10:56:30 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
10:56:30 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
10:56:30 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
10:56:30 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
10:56:30 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
10:56:30 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
10:56:30 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
10:56:30 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
10:56:30 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
10:56:30 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
10:56:30 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
10:56:30 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
10:56:30 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
10:56:30 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
10:56:30 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "5d1c43f3-8c6c-4df2-a894-3f0fe1bce361",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Boolean:?  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        failure : data[8],
        transhipmentFigures : data[10],
        shipSize : data[12],
        malfunction : data[14],
        transactionId : data[16],
        timestamp : data[18]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
10:56:30 - [34mdebug[39m: fromDirectory
10:56:30 - [34mdebug[39m: fromDirectory
10:56:30 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"5d1c43f3-8c6c-4df2-a894-3f0fe1bce361","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:56:30 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"5d1c43f3-8c6c-4df2-a894-3f0fe1bce361","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:56:30 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
10:56:30 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
10:56:30 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
10:56:30 - [32minfo[39m: CICERO-ENGINE
10:56:30 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-e49938c81300b4639cec531e425934e2e9dcce3eb260033386f6109285572685[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m1340[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35mc7554cd2-3403-4eff-9d3c-232e7f9c66f1[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-13T08:56:30.338Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
10:57:27 - [32minfo[39m: Using current directory as template folder
10:57:27 - [32minfo[39m: Loading a default sample.txt file.
10:57:27 - [32minfo[39m: Loading a single default request.json file.
10:57:27 - [32minfo[39m: Loading a default state.json file.
10:57:27 - [34mdebug[39m: fromDirectory
10:57:27 - [34mdebug[39m: fromDirectory
10:57:27 - [34mdebug[39m: fromDirectory
10:57:27 - [34mdebug[39m: fromDirectory
10:57:27 - [34mdebug[39m: fromDirectory
10:57:27 - [34mdebug[39m: fromDirectory
10:57:27 - [34mdebug[39m: fromDirectory
10:57:27 - [34mdebug[39m: constructor
10:57:27 - [34mdebug[39m: constructor
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processDirectory
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: fromDirectory
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: fromDirectory
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:27 - [34mdebug[39m: isFileInNodeModuleDir
10:57:27 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: fromDirectory
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processDirectory
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: fromDirectory
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: isFileInNodeModuleDir
10:57:32 - [34mdebug[39m: processFile
10:57:32 - [34mdebug[39m: fromDirectory
10:57:32 - [34mdebug[39m: buildGrammar
10:57:32 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
10:57:32 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
10:57:32 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
10:57:32 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
10:57:32 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
10:57:32 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
10:57:32 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
10:57:32 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
10:57:32 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
10:57:32 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
10:57:32 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
10:57:32 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
10:57:32 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
10:57:32 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
10:57:32 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
10:57:32 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
10:57:32 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "0ff5667b-dae2-45e4-b667-96944df66e82",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Boolean:?  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        failure : data[8],
        transhipmentFigures : data[10],
        shipSize : data[12],
        malfunction : data[14],
        transactionId : data[16],
        timestamp : data[18]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        aaa : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
10:57:32 - [34mdebug[39m: fromDirectory
10:57:32 - [34mdebug[39m: fromDirectory
10:57:32 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"0ff5667b-dae2-45e4-b667-96944df66e82","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:57:32 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"0ff5667b-dae2-45e4-b667-96944df66e82","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
10:57:32 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
10:57:32 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
10:57:32 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
10:57:32 - [32minfo[39m: CICERO-ENGINE
10:57:32 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-0c05d410848f469407ade2b756fbeea2e2157ea1c994f732ad8e89129cb529f7[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m1340[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32maaa[39m[33m"[39m[33m: [39m[36m16.30550138658582[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m18c3151a-7d97-4edf-9ed6-7a6bea819d1a[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-13T08:57:32.659Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
11:34:21 - [32minfo[39m: Using current directory as template folder
11:34:21 - [32minfo[39m: Loading a default sample.txt file.
11:34:21 - [32minfo[39m: Loading a single default request.json file.
11:34:21 - [32minfo[39m: Loading a default state.json file.
11:34:21 - [34mdebug[39m: fromDirectory
11:34:21 - [34mdebug[39m: fromDirectory
11:34:21 - [34mdebug[39m: fromDirectory
11:34:21 - [34mdebug[39m: fromDirectory
11:34:21 - [34mdebug[39m: fromDirectory
11:34:21 - [34mdebug[39m: fromDirectory
11:34:21 - [34mdebug[39m: fromDirectory
11:34:21 - [34mdebug[39m: constructor
11:34:21 - [34mdebug[39m: constructor
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processDirectory
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: fromDirectory
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: fromDirectory
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: fromDirectory
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processDirectory
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: fromDirectory
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: isFileInNodeModuleDir
11:34:21 - [34mdebug[39m: processFile
11:34:21 - [34mdebug[39m: fromDirectory
11:34:21 - [34mdebug[39m: buildGrammar
11:34:21 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
11:34:21 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
11:34:21 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
11:34:21 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
11:34:21 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
11:34:21 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
11:34:21 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
11:34:21 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
11:34:21 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
11:34:21 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
11:34:21 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
11:34:21 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
11:34:21 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
11:34:21 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
11:34:21 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
11:34:21 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
11:34:21 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "3da03af9-9424-4a5b-86b0-a495f306af17",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Boolean:?  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        failure : data[8],
        transhipmentFigures : data[10],
        shipSize : data[12],
        malfunction : data[14],
        transactionId : data[16],
        timestamp : data[18]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        DeliveryExtensionDays : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
11:34:22 - [34mdebug[39m: fromDirectory
11:34:22 - [34mdebug[39m: fromDirectory
11:34:22 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"3da03af9-9424-4a5b-86b0-a495f306af17","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:34:22 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"3da03af9-9424-4a5b-86b0-a495f306af17","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:34:22 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
11:34:22 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
11:34:22 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
11:34:22 - [32minfo[39m: CICERO-ENGINE
11:34:22 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-080d21aad8bd100c3eb15ebc22f9f7466813f4787db7c1530863ea02423295bb[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m[33m,[39m
    [33m"[39m[32mfailure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtranshipmentFigures[39m[33m"[39m[33m: [39m[36m5[39m[33m,[39m
    [33m"[39m[32mshipSize[39m[33m"[39m[33m: [39m[36m10[39m[33m,[39m
    [33m"[39m[32mmalfunction[39m[33m"[39m[33m: [39m[36m5[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m1340[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32mDeliveryExtensionDays[39m[33m"[39m[33m: [39m[36m15.187495979931837[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m67a9f993-3bea-4889-b388-0ee1074029b3[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-13T09:34:22.061Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
11:34:31 - [32minfo[39m: Using current directory as template folder
11:34:31 - [32minfo[39m: Loading a default sample.txt file.
11:34:31 - [32minfo[39m: Loading a single default request.json file.
11:34:31 - [32minfo[39m: Loading a default state.json file.
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: constructor
11:34:31 - [34mdebug[39m: constructor
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processDirectory
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processDirectory
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: isFileInNodeModuleDir
11:34:31 - [34mdebug[39m: processFile
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: buildGrammar
11:34:31 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
11:34:31 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
11:34:31 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
11:34:31 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
11:34:31 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
11:34:31 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
11:34:31 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
11:34:31 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
11:34:31 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
11:34:31 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
11:34:31 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
11:34:31 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
11:34:31 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
11:34:31 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
11:34:31 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
11:34:31 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
11:34:31 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "b6bb9420-bbfe-4d33-8fa9-7a196d8ba43d",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Boolean:?  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        failure : data[8],
        transhipmentFigures : data[10],
        shipSize : data[12],
        malfunction : data[14],
        transactionId : data[16],
        timestamp : data[18]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        DeliveryExtensionDays : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: fromDirectory
11:34:31 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"b6bb9420-bbfe-4d33-8fa9-7a196d8ba43d","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:34:31 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"b6bb9420-bbfe-4d33-8fa9-7a196d8ba43d","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:34:31 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
11:34:31 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
11:34:31 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
11:34:31 - [32minfo[39m: CICERO-ENGINE
11:34:31 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-e2d8628a342d68e8d7799758960cff3704eb470169919e283b5c0018bbd4f325[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m[33m,[39m
    [33m"[39m[32mfailure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtranshipmentFigures[39m[33m"[39m[33m: [39m[36m5[39m[33m,[39m
    [33m"[39m[32mshipSize[39m[33m"[39m[33m: [39m[36m5[39m[33m,[39m
    [33m"[39m[32mmalfunction[39m[33m"[39m[33m: [39m[36m5[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m1340[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32mDeliveryExtensionDays[39m[33m"[39m[33m: [39m[36m14.99999999999997[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m55ed38a5-5bc6-407c-8926-e36b190b1188[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-13T09:34:31.868Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
11:34:40 - [32minfo[39m: Using current directory as template folder
11:34:40 - [32minfo[39m: Loading a default sample.txt file.
11:34:40 - [32minfo[39m: Loading a single default request.json file.
11:34:40 - [32minfo[39m: Loading a default state.json file.
11:34:40 - [34mdebug[39m: fromDirectory
11:34:40 - [34mdebug[39m: fromDirectory
11:34:40 - [34mdebug[39m: fromDirectory
11:34:40 - [34mdebug[39m: fromDirectory
11:34:40 - [34mdebug[39m: fromDirectory
11:34:40 - [34mdebug[39m: fromDirectory
11:34:40 - [34mdebug[39m: fromDirectory
11:34:40 - [34mdebug[39m: constructor
11:34:40 - [34mdebug[39m: constructor
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processDirectory
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: fromDirectory
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: fromDirectory
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: fromDirectory
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processDirectory
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: fromDirectory
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: isFileInNodeModuleDir
11:34:40 - [34mdebug[39m: processFile
11:34:40 - [34mdebug[39m: fromDirectory
11:34:40 - [34mdebug[39m: buildGrammar
11:34:40 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
11:34:40 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
11:34:40 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
11:34:40 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
11:34:40 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
11:34:40 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
11:34:40 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
11:34:40 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
11:34:40 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
11:34:40 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
11:34:40 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
11:34:40 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
11:34:40 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
11:34:40 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
11:34:40 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
11:34:40 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
11:34:40 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "a747d03b-d3b2-41ed-983b-4ecb09be9bba",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Boolean:?  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        failure : data[8],
        transhipmentFigures : data[10],
        shipSize : data[12],
        malfunction : data[14],
        transactionId : data[16],
        timestamp : data[18]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        DeliveryExtensionDays : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
11:34:41 - [34mdebug[39m: fromDirectory
11:34:41 - [34mdebug[39m: fromDirectory
11:34:41 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"a747d03b-d3b2-41ed-983b-4ecb09be9bba","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:34:41 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"a747d03b-d3b2-41ed-983b-4ecb09be9bba","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:34:41 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
11:34:41 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
11:34:41 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
11:34:41 - [32minfo[39m: CICERO-ENGINE
11:34:41 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-fe3184c45af8590293f72ab967ea67d60c1d60d19e8fdf519064a93b58193d4d[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m[33m,[39m
    [33m"[39m[32mfailure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtranshipmentFigures[39m[33m"[39m[33m: [39m[36m2[39m[33m,[39m
    [33m"[39m[32mshipSize[39m[33m"[39m[33m: [39m[36m1[39m[33m,[39m
    [33m"[39m[32mmalfunction[39m[33m"[39m[33m: [39m[36m5[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m1340[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32mDeliveryExtensionDays[39m[33m"[39m[33m: [39m[36m14.999999999999943[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35mf0635e82-fe9b-4624-8d36-0db343d35350[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-13T09:34:41.088Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
11:34:45 - [32minfo[39m: Using current directory as template folder
11:34:45 - [32minfo[39m: Loading a default sample.txt file.
11:34:45 - [32minfo[39m: Loading a single default request.json file.
11:34:45 - [32minfo[39m: Loading a default state.json file.
11:34:45 - [34mdebug[39m: fromDirectory
11:34:45 - [34mdebug[39m: fromDirectory
11:34:45 - [34mdebug[39m: fromDirectory
11:34:45 - [34mdebug[39m: fromDirectory
11:34:45 - [34mdebug[39m: fromDirectory
11:34:45 - [34mdebug[39m: fromDirectory
11:34:45 - [34mdebug[39m: fromDirectory
11:34:45 - [34mdebug[39m: constructor
11:34:45 - [34mdebug[39m: constructor
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processDirectory
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: fromDirectory
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: fromDirectory
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:45 - [34mdebug[39m: isFileInNodeModuleDir
11:34:45 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: fromDirectory
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processDirectory
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: fromDirectory
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: isFileInNodeModuleDir
11:34:46 - [34mdebug[39m: processFile
11:34:46 - [34mdebug[39m: fromDirectory
11:34:46 - [34mdebug[39m: buildGrammar
11:34:46 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
11:34:46 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
11:34:46 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
11:34:46 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
11:34:46 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
11:34:46 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
11:34:46 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
11:34:46 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
11:34:46 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
11:34:46 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
11:34:46 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
11:34:46 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
11:34:46 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
11:34:46 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
11:34:46 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
11:34:46 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
11:34:46 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "1a7040a2-3f3c-400a-b93f-c00a0d4aaec8",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Boolean:?  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        failure : data[8],
        transhipmentFigures : data[10],
        shipSize : data[12],
        malfunction : data[14],
        transactionId : data[16],
        timestamp : data[18]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        DeliveryExtensionDays : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
11:34:46 - [34mdebug[39m: fromDirectory
11:34:46 - [34mdebug[39m: fromDirectory
11:34:46 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"1a7040a2-3f3c-400a-b93f-c00a0d4aaec8","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:34:46 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"1a7040a2-3f3c-400a-b93f-c00a0d4aaec8","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:34:46 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
11:34:46 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
11:34:46 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
11:34:46 - [32minfo[39m: CICERO-ENGINE
11:34:46 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-33fbaa4a8b945c253ac8a038964b54b584b163eb439447d307cb705854894b89[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m[33m,[39m
    [33m"[39m[32mfailure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtranshipmentFigures[39m[33m"[39m[33m: [39m[36m2[39m[33m,[39m
    [33m"[39m[32mshipSize[39m[33m"[39m[33m: [39m[36m1[39m[33m,[39m
    [33m"[39m[32mmalfunction[39m[33m"[39m[33m: [39m[36m1[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m1340[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32mDeliveryExtensionDays[39m[33m"[39m[33m: [39m[36m14.069463165233488[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35mf8a05ba3-b159-4ff7-b655-b684d82c1db6[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-13T09:34:46.636Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
11:34:56 - [32minfo[39m: Using current directory as template folder
11:34:56 - [32minfo[39m: Loading a default sample.txt file.
11:34:56 - [32minfo[39m: Loading a single default request.json file.
11:34:56 - [32minfo[39m: Loading a default state.json file.
11:34:56 - [34mdebug[39m: fromDirectory
11:34:56 - [34mdebug[39m: fromDirectory
11:34:56 - [34mdebug[39m: fromDirectory
11:34:56 - [34mdebug[39m: fromDirectory
11:34:56 - [34mdebug[39m: fromDirectory
11:34:56 - [34mdebug[39m: fromDirectory
11:34:56 - [34mdebug[39m: fromDirectory
11:34:56 - [34mdebug[39m: constructor
11:34:56 - [34mdebug[39m: constructor
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processDirectory
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: fromDirectory
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: fromDirectory
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:56 - [34mdebug[39m: isFileInNodeModuleDir
11:34:56 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: fromDirectory
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processDirectory
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: fromDirectory
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: isFileInNodeModuleDir
11:34:57 - [34mdebug[39m: processFile
11:34:57 - [34mdebug[39m: fromDirectory
11:34:57 - [34mdebug[39m: buildGrammar
11:34:57 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
11:34:57 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
11:34:57 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
11:34:57 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
11:34:57 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
11:34:57 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
11:34:57 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
11:34:57 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
11:34:57 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
11:34:57 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
11:34:57 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
11:34:57 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
11:34:57 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
11:34:57 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
11:34:57 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
11:34:57 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
11:34:57 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "36e9a006-216e-44e8-9f76-ce255c5cd413",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Boolean:?  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        failure : data[8],
        transhipmentFigures : data[10],
        shipSize : data[12],
        malfunction : data[14],
        transactionId : data[16],
        timestamp : data[18]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        DeliveryExtensionDays : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
11:34:57 - [34mdebug[39m: fromDirectory
11:34:57 - [34mdebug[39m: fromDirectory
11:34:57 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"36e9a006-216e-44e8-9f76-ce255c5cd413","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:34:57 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"36e9a006-216e-44e8-9f76-ce255c5cd413","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:34:57 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
11:34:57 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
11:34:57 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
11:34:57 - [32minfo[39m: CICERO-ENGINE
11:34:57 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-95a98f36d08ee12700f52ffe413fc134873de7b3ed3ba4e2282ef469e504673f[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m[33m,[39m
    [33m"[39m[32mfailure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtranshipmentFigures[39m[33m"[39m[33m: [39m[36m6[39m[33m,[39m
    [33m"[39m[32mshipSize[39m[33m"[39m[33m: [39m[36m3[39m[33m,[39m
    [33m"[39m[32mmalfunction[39m[33m"[39m[33m: [39m[36m7[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m1340[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32mDeliveryExtensionDays[39m[33m"[39m[33m: [39m[36m14.999999999999979[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35md9134e45-e06a-48dc-b67e-8a8d66ee4492[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-13T09:34:57.905Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
11:36:56 - [32minfo[39m: Using current directory as template folder
11:36:56 - [32minfo[39m: Loading a default sample.txt file.
11:36:56 - [32minfo[39m: Loading a single default request.json file.
11:36:56 - [32minfo[39m: Loading a default state.json file.
11:36:56 - [34mdebug[39m: fromDirectory
11:36:56 - [34mdebug[39m: fromDirectory
11:36:56 - [34mdebug[39m: fromDirectory
11:36:56 - [34mdebug[39m: fromDirectory
11:36:56 - [34mdebug[39m: fromDirectory
11:36:56 - [34mdebug[39m: fromDirectory
11:36:56 - [34mdebug[39m: fromDirectory
11:36:56 - [34mdebug[39m: constructor
11:36:56 - [34mdebug[39m: constructor
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processDirectory
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: fromDirectory
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: fromDirectory
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:56 - [34mdebug[39m: isFileInNodeModuleDir
11:36:56 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: fromDirectory
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processDirectory
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: fromDirectory
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: isFileInNodeModuleDir
11:36:57 - [34mdebug[39m: processFile
11:36:57 - [34mdebug[39m: fromDirectory
11:36:57 - [34mdebug[39m: buildGrammar
11:36:57 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
11:36:57 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
11:36:57 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
11:36:57 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
11:36:57 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
11:36:57 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
11:36:57 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
11:36:57 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
11:36:57 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
11:36:57 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
11:36:57 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
11:36:57 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
11:36:57 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
11:36:57 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
11:36:57 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
11:36:57 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
11:36:57 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "6d13007f-4854-4962-8f13-f312511b6189",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Boolean:?  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        failure : data[8],
        transhipmentFigures : data[10],
        shipSize : data[12],
        malfunction : data[14],
        transactionId : data[16],
        timestamp : data[18]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        DeliveryExtensionDays : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
11:36:57 - [34mdebug[39m: fromDirectory
11:36:57 - [34mdebug[39m: fromDirectory
11:36:57 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"6d13007f-4854-4962-8f13-f312511b6189","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:36:57 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"6d13007f-4854-4962-8f13-f312511b6189","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:36:57 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
11:36:57 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
11:36:57 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
11:36:57 - [32minfo[39m: CICERO-ENGINE
11:36:57 - [32minfo[39m:
[33m{[39m
  [33m"[39m[32mclause[39m[33m"[39m[33m: [39m[33m"[39m[35mlatedeliveryandpenalty@0.2.0-67f6c40343fc78f97762d45486edc7e5bad779dadd3d95d78272e8ae40ac4d46[39m[33m"[39m[33m,[39m
  [33m"[39m[32mrequest[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest[39m[33m"[39m[33m,[39m
    [33m"[39m[32mforceMajeure[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32magreedDelivery[39m[33m"[39m[33m: [39m[33m"[39m[35mJuli 6, 2018 03:24:00[39m[33m"[39m[33m,[39m
    [33m"[39m[32mdeliveredAt[39m[33m"[39m[33m: [39m[90mnull[39m[33m,[39m
    [33m"[39m[32mgoodsValue[39m[33m"[39m[33m: [39m[36m200[39m[33m,[39m
    [33m"[39m[32mfailure[39m[33m"[39m[33m: [39m[31mtrue[39m[33m,[39m
    [33m"[39m[32mtranshipmentFigures[39m[33m"[39m[33m: [39m[36m6[39m[33m,[39m
    [33m"[39m[32mshipSize[39m[33m"[39m[33m: [39m[36m7[39m[33m,[39m
    [33m"[39m[32mmalfunction[39m[33m"[39m[33m: [39m[36m7[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mresponse[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse[39m[33m"[39m[33m,[39m
    [33m"[39m[32mpenalty[39m[33m"[39m[33m: [39m[36m1340[39m[33m,[39m
    [33m"[39m[32mbuyerMayTerminate[39m[33m"[39m[33m: [39m[31mfalse[39m[33m,[39m
    [33m"[39m[32mDeliveryExtensionDays[39m[33m"[39m[33m: [39m[36m14.999999999999979[39m[33m,[39m
    [33m"[39m[32mtransactionId[39m[33m"[39m[33m: [39m[33m"[39m[35m0093f809-a074-4a1a-b609-f0279d5363b4[39m[33m"[39m[33m,[39m
    [33m"[39m[32mtimestamp[39m[33m"[39m[33m: [39m[33m"[39m[35m2018-07-13T09:36:57.370Z[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32mstate[39m[33m"[39m[33m: [39m[33m{[39m
    [33m"[39m[32m$class[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState[39m[33m"[39m[33m,[39m
    [33m"[39m[32mstateId[39m[33m"[39m[33m: [39m[33m"[39m[35morg.accordproject.cicero.contract.AccordContractState#1[39m[33m"[39m
  [33m}[39m[33m,[39m
  [33m"[39m[32memit[39m[33m"[39m[33m: [39m[33m[[39m[33m][39m
[33m}[39m
11:37:13 - [32minfo[39m: Using current directory as template folder
11:37:13 - [32minfo[39m: Loading a default sample.txt file.
11:37:13 - [32minfo[39m: Loading a single default request.json file.
11:37:13 - [32minfo[39m: Loading a default state.json file.
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: constructor
11:37:13 - [34mdebug[39m: constructor
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processDirectory
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processDirectory
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: isFileInNodeModuleDir
11:37:13 - [34mdebug[39m: processFile
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: buildGrammar
11:37:13 - [34mdebug[39m: Template AST {"type":"ContractTemplate","data":[{"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1},{"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}},{"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108},{"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}},{"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193},{"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}},{"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}},{"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359},{"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}},{"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405},{"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}},{"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478},{"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}},{"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}]}
11:37:13 - [34mdebug[39m: element rule0 {"type":"Chunk","value":"Late Delivery and Penalty. In case of delayed delivery","text":"Late Delivery and Penalty. In case of delayed delivery[{","offset":0,"lineBreaks":0,"line":1,"col":1}
11:37:13 - [34mdebug[39m: element rule1 {"type":"BooleanBinding","string":{"type":"varstring","value":"\" except for Force Majeure cases,\"","text":"\" except for Force Majeure cases,\"","offset":56,"lineBreaks":0,"line":1,"col":57},"fieldName":{"type":"varid","value":"forceMajeure","text":"forceMajeure","offset":93,"lineBreaks":0,"line":1,"col":94}}
11:37:13 - [34mdebug[39m: element rule2 {"type":"Chunk","value":" the Seller shall pay to the Buyer for ","text":" the Seller shall pay to the Buyer for [{","offset":107,"lineBreaks":0,"line":1,"col":108}
11:37:13 - [34mdebug[39m: element rule3 {"type":"BooleanBinding","string":{"type":"varstring","value":"\"a okay amount of days\"","text":"\"a okay amount of days\"","offset":148,"lineBreaks":0,"line":1,"col":149},"fieldName":{"type":"varid","value":"uncertainPenalty","text":"uncertainPenalty","offset":174,"lineBreaks":0,"line":1,"col":175}}
11:37:13 - [34mdebug[39m: element rule4 {"type":"Chunk","value":" of delay penalty amounting to ","text":" of delay penalty amounting to [{","offset":192,"lineBreaks":0,"line":1,"col":193}
11:37:13 - [34mdebug[39m: element rule5 {"type":"Binding","fieldName":{"type":"varid","value":"penaltyPercentage","text":"penaltyPercentage","offset":225,"lineBreaks":0,"line":1,"col":226}}
11:37:13 - [34mdebug[39m: element rule6 {"type":"Chunk","value":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a ","text":"% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a [{","offset":244,"lineBreaks":0,"line":1,"col":245}
11:37:13 - [34mdebug[39m: element rule7 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":342,"lineBreaks":0,"line":1,"col":343}}
11:37:13 - [34mdebug[39m: element rule8 {"type":"Chunk","value":" is to be considered a full ","text":" is to be considered a full [{","offset":358,"lineBreaks":0,"line":1,"col":359}
11:37:13 - [34mdebug[39m: element rule9 {"type":"Binding","fieldName":{"type":"varid","value":"fractionalPart","text":"fractionalPart","offset":388,"lineBreaks":0,"line":1,"col":389}}
11:37:13 - [34mdebug[39m: element rule10 {"type":"Chunk","value":". The total amount of penalty shall not however, exceed ","text":". The total amount of penalty shall not however, exceed [{","offset":404,"lineBreaks":0,"line":1,"col":405}
11:37:13 - [34mdebug[39m: element rule11 {"type":"Binding","fieldName":{"type":"varid","value":"capPercentage","text":"capPercentage","offset":462,"lineBreaks":0,"line":1,"col":463}}
11:37:13 - [34mdebug[39m: element rule12 {"type":"Chunk","value":"% of the total value of the Equipment involved in late delivery. If the delay is more than ","text":"% of the total value of the Equipment involved in late delivery. If the delay is more than [{","offset":477,"lineBreaks":0,"line":1,"col":478}
11:37:13 - [34mdebug[39m: element rule13 {"type":"Binding","fieldName":{"type":"varid","value":"termination","text":"termination","offset":570,"lineBreaks":0,"line":1,"col":571}}
11:37:13 - [34mdebug[39m: element rule14 {"type":"LastChunk","value":", the Buyer is entitled to terminate this Contract.","text":", the Buyer is entitled to terminate this Contract.","offset":583,"lineBreaks":0,"line":1,"col":584}
11:37:13 - [34mdebug[39m: Generated template grammar# Dynamically Generated
@builtin "number.ne"
@builtin "string.ne"
@builtin "whitespace.ne"
@{%
    function compact(v) {
        if (Array.isArray(v)) {
            return v.reduce((a, v) => (v === null || v === undefined || (v && v.length === 0) ) ? a : (a.push(v), a), []);
        } else {
            return v;
        }
    }

    function flatten(v) {
        let r;
        if (Array.isArray(v)) {
            r = v.reduce((a,v) => (a.push(...((v && Array.isArray(v)) ? flatten(v) : [v])), a), []);
        } else {
            r = v;
        }
        r = compact(r);
        return r;
        }
%}


rule -> rule0 rule1 rule2 rule3 rule4 rule5 rule6 rule7 rule8 rule9 rule10 rule11 rule12 rule13 rule14 
{% ([ rule0,rule1,rule2,rule3,rule4,rule5,rule6,rule7,rule8,rule9,rule10,rule11,rule12,rule13,rule14 ]) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        clauseId : "fb0dba6f-43ae-475b-a832-17c76dae2aaf",
        forceMajeure : rule1,
        uncertainPenalty : rule3,
        penaltyPercentage : rule5,
        capPercentage : rule11,
        termination : rule13,
        fractionalPart : rule7,
    };
}
%}

ROOT -> rule0 
{% ([ rule0 ]) => {
    return {
        
        
    };
}
%}



rule0 -> "Late Delivery and Penalty. In case of delayed delivery" 


rule1 -> " except for Force Majeure cases,":? {% (d) => {return d[0] !== null;}%} # forceMajeure 


rule2 -> " the Seller shall pay to the Buyer for " 


rule3 -> "a okay amount of days":? {% (d) => {return d[0] !== null;}%} # uncertainPenalty 


rule4 -> " of delay penalty amounting to " 


rule5 -> Double {% id %} # penaltyPercentage 


rule6 -> "% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a " 


rule7 -> TemporalUnit {% id %} # fractionalPart 


rule8 -> " is to be considered a full " 


rule9 -> TemporalUnit {% id %} # fractionalPart 


rule10 -> ". The total amount of penalty shall not however, exceed " 


rule11 -> Double {% id %} # capPercentage 


rule12 -> "% of the total value of the Equipment involved in late delivery. If the delay is more than " 


rule13 -> Duration {% id %} # termination 


rule14 -> ", the Buyer is entitled to terminate this Contract." 


FuzzyModel -> String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyModel",
        inputVariables : data[0],
        rules : data[2]
    };
}
%}


FuzzyLinguisticVariable -> String  __  String  __  String 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticVariable",
        InputVariableId : data[0],
        description : data[2],
        terms : data[4]
    };
}
%}


TermType -> "TRIANGULAR" {% id %} | "TRAPEZOIDAL" {% id %} 


FuzzyLinguisticTerm -> String  __  String  __  TermType  __  Double:+ 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyLinguisticTerm",
        termID : data[0],
        name : data[2],
        type : data[4],
        values : data[6]
    };
}
%}


FuzzyRule -> String  __  String:+  __  String  __  Double 

{% ( data ) => {
    return {
        $class: "org.proseminar.joshuahoogstraat.fuzzysolver.FuzzyRule",
        ruleId : data[0],
        connectedTermIds : data[2],
        resultTermId : data[4],
        wheight : data[6]
    };
}
%}


LateDeliveryAndPenaltyClause -> Boolean:?  __  Duration:?  __  Boolean:?  __  Double  __  Double  __  Duration  __  TemporalUnit  __  String 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause",
        forceMajeure : data[0],
        penaltyDuration : data[2],
        uncertainPenalty : data[4],
        penaltyPercentage : data[6],
        capPercentage : data[8],
        termination : data[10],
        fractionalPart : data[12],
        clauseId : data[14]
    };
}
%}


LateDeliveryAndPenaltyRequest -> Boolean  __  DateTime  __  DateTime:?  __  Double  __  Boolean:?  __  Double:?  __  Double:?  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest",
        forceMajeure : data[0],
        agreedDelivery : data[2],
        deliveredAt : data[4],
        goodsValue : data[6],
        failure : data[8],
        transhipmentFigures : data[10],
        shipSize : data[12],
        malfunction : data[14],
        transactionId : data[16],
        timestamp : data[18]
    };
}
%}


LateDeliveryAndPenaltyResponse -> Double  __  Boolean  __  Double:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse",
        penalty : data[0],
        buyerMayTerminate : data[2],
        DeliveryExtensionDays : data[4],
        transactionId : data[6],
        timestamp : data[8]
    };
}
%}


AccordContractState -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordContractState",
        stateId : data[0]
    };
}
%}


AccordParty -> String 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.contract.AccordParty",
        partyId : data[0]
    };
}
%}


Request -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Request",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


Response -> String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Response",
        transactionId : data[0],
        timestamp : data[2]
    };
}
%}


PaymentObligation -> MonetaryAmount  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.PaymentObligation",
        amount : data[0],
        description : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


NotificationObligation -> String  __  String  __  String  __  String  __  String  __  DateTime:?  __  String  __  DateTime 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.NotificationObligation",
        title : data[0],
        message : data[2],
        contract : data[4],
        promisor : data[6],
        promisee : data[8],
        deadline : data[10],
        eventId : data[12],
        timestamp : data[14]
    };
}
%}


Payload -> AccordContract  __  Request  __  AccordContractState:? 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Payload",
        contract : data[0],
        request : data[2],
        state : data[4]
    };
}
%}


Success -> Response  __  AccordContractState  __  Event:+ 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Success",
        response : data[0],
        state : data[2],
        emit : data[4]
    };
}
%}


Failure -> ErrorResponse 

{% ( data ) => {
    return {
        $class: "org.accordproject.cicero.runtime.Failure",
        error : data[0]
    };
}
%}


TemporalUnit -> "seconds" {% id %} | "minutes" {% id %} | "hours" {% id %} | "days" {% id %} | "weeks" {% id %} | "years" {% id %} 


Duration -> Long  __  TemporalUnit 

{% ( data ) => {
    return {
        $class: "org.accordproject.time.Duration",
        amount : data[0],
        unit : data[2]
    };
}
%}


CryptoMonetaryAmount -> Double  __  CryptoCurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.CryptoMonetaryAmount",
        doubleValue : data[0],
        cryptoCurrencyCode : data[2]
    };
}
%}


CryptoCurrencyCode -> "ADA" {% id %} | "BCH" {% id %} | "BTC" {% id %} | "DASH" {% id %} | "EOS" {% id %} | "ETC" {% id %} | "ETH" {% id %} | "LTC" {% id %} | "NEO" {% id %} | "XLM" {% id %} | "XMR" {% id %} | "XRP" {% id %} | "ZEC" {% id %} 


MonetaryAmount -> Double  __  CurrencyCode 

{% ( data ) => {
    return {
        $class: "org.accordproject.money.MonetaryAmount",
        doubleValue : data[0],
        currencyCode : data[2]
    };
}
%}


CurrencyCode -> "AED" {% id %} | "AFN" {% id %} | "ALL" {% id %} | "AMD" {% id %} | "ANG" {% id %} | "AOA" {% id %} | "ARS" {% id %} | "AUD" {% id %} | "AWG" {% id %} | "AZN" {% id %} | "BAM" {% id %} | "BBD" {% id %} | "BDT" {% id %} | "BGN" {% id %} | "BHD" {% id %} | "BIF" {% id %} | "BMD" {% id %} | "BND" {% id %} | "BOB" {% id %} | "BOV" {% id %} | "BRL" {% id %} | "BSD" {% id %} | "BTN" {% id %} | "BWP" {% id %} | "BYN" {% id %} | "BZD" {% id %} | "CAD" {% id %} | "CDF" {% id %} | "CHE" {% id %} | "CHF" {% id %} | "CHW" {% id %} | "CLF" {% id %} | "CLP" {% id %} | "CNY" {% id %} | "COP" {% id %} | "COU" {% id %} | "CRC" {% id %} | "CUC" {% id %} | "CUP" {% id %} | "CVE" {% id %} | "CZK" {% id %} | "DJF" {% id %} | "DKK" {% id %} | "DOP" {% id %} | "DZD" {% id %} | "EGP" {% id %} | "ERN" {% id %} | "ETB" {% id %} | "EUR" {% id %} | "FJD" {% id %} | "FKP" {% id %} | "GBP" {% id %} | "GEL" {% id %} | "GHS" {% id %} | "GIP" {% id %} | "GMD" {% id %} | "GNF" {% id %} | "GTQ" {% id %} | "GYD" {% id %} | "HKD" {% id %} | "HNL" {% id %} | "HRK" {% id %} | "HTG" {% id %} | "HUF" {% id %} | "IDR" {% id %} | "ILS" {% id %} | "INR" {% id %} | "IQD" {% id %} | "IRR" {% id %} | "ISK" {% id %} | "JMD" {% id %} | "JOD" {% id %} | "JPY" {% id %} | "KES" {% id %} | "KGS" {% id %} | "KHR" {% id %} | "KMF" {% id %} | "KPW" {% id %} | "KRW" {% id %} | "KWD" {% id %} | "KYD" {% id %} | "KZT" {% id %} | "LAK" {% id %} | "LBP" {% id %} | "LKR" {% id %} | "LRD" {% id %} | "LSL" {% id %} | "LYD" {% id %} | "MAD" {% id %} | "MDL" {% id %} | "MGA" {% id %} | "MKD" {% id %} | "MMK" {% id %} | "MNT" {% id %} | "MOP" {% id %} | "MRU" {% id %} | "MUR" {% id %} | "MVR" {% id %} | "MWK" {% id %} | "MXN" {% id %} | "MXV" {% id %} | "MYR" {% id %} | "MZN" {% id %} | "NAD" {% id %} | "NGN" {% id %} | "NIO" {% id %} | "NOK" {% id %} | "NPR" {% id %} | "NZD" {% id %} | "OMR" {% id %} | "PAB" {% id %} | "PEN" {% id %} | "PGK" {% id %} | "PHP" {% id %} | "PKR" {% id %} | "PLN" {% id %} | "PYG" {% id %} | "QAR" {% id %} | "RON" {% id %} | "RSD" {% id %} | "RUB" {% id %} | "RWF" {% id %} | "SAR" {% id %} | "SBD" {% id %} | "SCR" {% id %} | "SDG" {% id %} | "SEK" {% id %} | "SGD" {% id %} | "SHP" {% id %} | "SLL" {% id %} | "SOS" {% id %} | "SRD" {% id %} | "SSP" {% id %} | "STN" {% id %} | "SVC" {% id %} | "SYP" {% id %} | "SZL" {% id %} | "THB" {% id %} | "TJS" {% id %} | "TMT" {% id %} | "TND" {% id %} | "TOP" {% id %} | "TRY" {% id %} | "TTD" {% id %} | "TWD" {% id %} | "TZS" {% id %} | "UAH" {% id %} | "UGX" {% id %} | "USD" {% id %} | "USN" {% id %} | "UYI" {% id %} | "UYU" {% id %} | "UZS" {% id %} | "VEF" {% id %} | "VND" {% id %} | "VUV" {% id %} | "WST" {% id %} | "XAF" {% id %} | "XAG" {% id %} | "XAU" {% id %} | "XBA" {% id %} | "XBB" {% id %} | "XBC" {% id %} | "XBD" {% id %} | "XCD" {% id %} | "XDR" {% id %} | "XOF" {% id %} | "XPD" {% id %} | "XPF" {% id %} | "XPT" {% id %} | "XSU" {% id %} | "XTS" {% id %} | "XUA" {% id %} | "XXX" {% id %} | "YER" {% id %} | "ZAR" {% id %} | "ZMW" {% id %} | "ZWL" {% id %} 



# Basic types
NUMBER -> [0-9] 
{% (d) => {return parseInt(d[0]);}%}

DOUBLE_NUMBER -> NUMBER NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

MONTH -> DOUBLE_NUMBER
DAY -> DOUBLE_NUMBER
YEAR -> DOUBLE_NUMBER DOUBLE_NUMBER
{% (d) => {return '' + d[0] + d[1]}%}

DATE -> MONTH "/" DAY "/" YEAR
{% (d) => {return '' + d[4] + '-' + d[0] + '-' + d[2]}%}

Word -> [\S]:*
{% (d) => {return d[0].join('');}%}

BRACKET_PHRASE -> "[" Word (__ Word):* "]" {% ((d) => {return d[1] + ' ' + flatten(d[2]).join(" ");}) %}

String -> dqstring {% id %}
Double -> decimal {% id %}
Integer -> int {% id %}
Long -> int {% id %}
Boolean -> "true" {% id %} | "false" {% id %}
DateTime -> DATE  {% id %}
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: fromDirectory
11:37:13 - [34mdebug[39m: Result of parsing: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"fb0dba6f-43ae-475b-a832-17c76dae2aaf","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:37:13 - [34mdebug[39m: Setting clause data: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyClause","clauseId":"fb0dba6f-43ae-475b-a832-17c76dae2aaf","forceMajeure":true,"uncertainPenalty":true,"penaltyPercentage":10.5,"capPercentage":55,"termination":{"$class":"org.accordproject.time.Duration","amount":15,"unit":"days"},"fractionalPart":"days"}
11:37:13 - [34mdebug[39m: Engine processing request org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest with state org.accordproject.cicero.contract.AccordContractState
11:37:13 - [34mdebug[39m: 
        __dispatch(contract,data,request,state,moment());

        function __dispatch(contract,data,request,state,now) {
            switch(request.getFullyQualifiedType()) {
        
            case 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyRequest':
                let type0 = 'org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse';
                let ns0 = type0.substr(0, type0.lastIndexOf('.'));
                let clazz0 = type0.substr(type0.lastIndexOf('.')+1);
                let response0 = factory.newTransaction(ns0, clazz0);
                let context0 = {request: request, state: state, contract: contract, data: data, response: response0, emit: [], now: now};
                execute(context0);
                return { response: context0.response, state: context0.state, emit: context0.emit };
            break;
            default:
                throw new Error('No function handler for: ' + request.getFullyQualifiedType() );
            } // switch
            return 'oops';
        }
        
11:37:13 - [34mdebug[39m: 
        __init(contract,data,request,moment());

        function __init(contract,data,request,now) {
        
                return { response: serializer.fromJSON({ '$class': 'org.accordproject.cicero.runtime.Response' }, {validate: false, acceptResourcesForRelationships: true}), state: serializer.fromJSON({ '$class': 'org.accordproject.cicero.contract.AccordContractState', 'stateId' : 'org.accordproject.cicero.contract.AccordContractState#1' }, {validate: false, acceptResourcesForRelationships: true}), emit: [] };
        }
        
11:37:13 - [32minfo[39m: CICERO-ENGINE
11:37:13 - [31merror[39m: Generated invalid JSON: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse","penalty":1340,"buyerMayTerminate":false,"DeliveryExtensionDays":NaN,"transactionId":"22dfbd95-df3a-48f1-92ee-69e396bc0d0e","timestamp":"2018-07-13T09:37:13.891Z"}
Error: Generated invalid JSON: {"$class":"org.accordproject.latedeliveryandpenalty.LateDeliveryAndPenaltyResponse","penalty":1340,"buyerMayTerminate":false,"DeliveryExtensionDays":NaN,"transactionId":"22dfbd95-df3a-48f1-92ee-69e396bc0d0e","timestamp":"2018-07-13T09:37:13.891Z"}
    at Serializer.toJSON (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/serializer.js:130:19)
    at Engine.execute (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-engine/lib/engine.js:244:57)
    at Template.fromDirectory.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/lib/commands.js:151:45)
    at process._tickCallback (internal/process/next_tick.js:68:7)
11:37:13 - [32minfo[39m: undefined
09:46:24 - [32minfo[39m: Using current directory as template folder
09:46:24 - [32minfo[39m: Loading a default sample.txt file.
09:46:24 - [32minfo[39m: Loading a single default request.json file.
09:46:24 - [32minfo[39m: Loading a default state.json file.
09:46:24 - [34mdebug[39m: fromDirectory
09:46:24 - [34mdebug[39m: fromDirectory
09:46:24 - [34mdebug[39m: fromDirectory
09:46:24 - [34mdebug[39m: fromDirectory
09:46:24 - [34mdebug[39m: fromDirectory
09:46:24 - [34mdebug[39m: fromDirectory
09:46:24 - [34mdebug[39m: fromDirectory
09:46:24 - [34mdebug[39m: constructor
09:46:24 - [34mdebug[39m: constructor
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processDirectory
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: fromDirectory
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: fromDirectory
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:24 - [34mdebug[39m: isFileInNodeModuleDir
09:46:24 - [34mdebug[39m: processFile
09:46:29 - [34mdebug[39m: fromDirectory
09:46:29 - [34mdebug[39m: isFileInNodeModuleDir
09:46:29 - [34mdebug[39m: isFileInNodeModuleDir
09:46:29 - [34mdebug[39m: isFileInNodeModuleDir
09:46:29 - [34mdebug[39m: isFileInNodeModuleDir
09:46:29 - [34mdebug[39m: isFileInNodeModuleDir
09:46:29 - [34mdebug[39m: isFileInNodeModuleDir
09:46:29 - [34mdebug[39m: processDirectory
09:46:29 - [34mdebug[39m: isFileInNodeModuleDir
09:46:29 - [34mdebug[39m: processFile
09:46:29 - [34mdebug[39m: isFileInNodeModuleDir
09:46:29 - [34mdebug[39m: processFile
09:46:29 - [34mdebug[39m: isFileInNodeModuleDir
09:46:29 - [34mdebug[39m: processFile
09:46:29 - [34mdebug[39m: isFileInNodeModuleDir
09:46:29 - [34mdebug[39m: processFile
09:46:29 - [34mdebug[39m: isFileInNodeModuleDir
09:46:29 - [34mdebug[39m: processFile
09:46:29 - [34mdebug[39m: isFileInNodeModuleDir
09:46:29 - [34mdebug[39m: processFile
09:46:29 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/FuzzySystem.js: 'import' and 'export' may appear only with 'sourceType: module' (1:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/FuzzySystem.js: 'import' and 'export' may appear only with 'sourceType: module' (1:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
09:46:29 - [32minfo[39m: undefined
09:48:07 - [32minfo[39m: Using current directory as template folder
09:48:07 - [32minfo[39m: Loading a default sample.txt file.
09:48:07 - [32minfo[39m: Loading a single default request.json file.
09:48:07 - [32minfo[39m: Loading a default state.json file.
09:48:07 - [34mdebug[39m: fromDirectory
09:48:07 - [34mdebug[39m: fromDirectory
09:48:07 - [34mdebug[39m: fromDirectory
09:48:07 - [34mdebug[39m: fromDirectory
09:48:07 - [34mdebug[39m: fromDirectory
09:48:07 - [34mdebug[39m: fromDirectory
09:48:07 - [34mdebug[39m: fromDirectory
09:48:07 - [34mdebug[39m: constructor
09:48:07 - [34mdebug[39m: constructor
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processDirectory
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: fromDirectory
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: fromDirectory
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:07 - [34mdebug[39m: isFileInNodeModuleDir
09:48:07 - [34mdebug[39m: processFile
09:48:08 - [34mdebug[39m: fromDirectory
09:48:08 - [34mdebug[39m: isFileInNodeModuleDir
09:48:08 - [34mdebug[39m: isFileInNodeModuleDir
09:48:08 - [34mdebug[39m: isFileInNodeModuleDir
09:48:08 - [34mdebug[39m: isFileInNodeModuleDir
09:48:08 - [34mdebug[39m: isFileInNodeModuleDir
09:48:08 - [34mdebug[39m: isFileInNodeModuleDir
09:48:08 - [34mdebug[39m: processDirectory
09:48:08 - [34mdebug[39m: isFileInNodeModuleDir
09:48:08 - [34mdebug[39m: processFile
09:48:08 - [34mdebug[39m: isFileInNodeModuleDir
09:48:08 - [34mdebug[39m: processFile
09:48:08 - [34mdebug[39m: isFileInNodeModuleDir
09:48:08 - [34mdebug[39m: processFile
09:48:08 - [34mdebug[39m: isFileInNodeModuleDir
09:48:08 - [34mdebug[39m: processFile
09:48:08 - [34mdebug[39m: isFileInNodeModuleDir
09:48:08 - [34mdebug[39m: processFile
09:48:08 - [34mdebug[39m: isFileInNodeModuleDir
09:48:08 - [34mdebug[39m: processFile
09:48:08 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/FuzzySystem.js: 'import' and 'export' may appear only with 'sourceType: module' (1:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/FuzzySystem.js: 'import' and 'export' may appear only with 'sourceType: module' (1:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
09:48:08 - [32minfo[39m: undefined
09:48:25 - [32minfo[39m: Using current directory as template folder
09:48:25 - [32minfo[39m: Loading a default sample.txt file.
09:48:25 - [32minfo[39m: Loading a single default request.json file.
09:48:25 - [32minfo[39m: Loading a default state.json file.
09:48:25 - [34mdebug[39m: fromDirectory
09:48:25 - [34mdebug[39m: fromDirectory
09:48:25 - [34mdebug[39m: fromDirectory
09:48:25 - [34mdebug[39m: fromDirectory
09:48:25 - [34mdebug[39m: fromDirectory
09:48:25 - [34mdebug[39m: fromDirectory
09:48:25 - [34mdebug[39m: fromDirectory
09:48:25 - [34mdebug[39m: constructor
09:48:25 - [34mdebug[39m: constructor
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processDirectory
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: fromDirectory
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: fromDirectory
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: fromDirectory
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processDirectory
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [34mdebug[39m: isFileInNodeModuleDir
09:48:25 - [34mdebug[39m: processFile
09:48:25 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/FuzzySystem.js: 'import' and 'export' may appear only with 'sourceType: module' (1:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/FuzzySystem.js: 'import' and 'export' may appear only with 'sourceType: module' (1:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
09:48:25 - [32minfo[39m: undefined
09:58:47 - [32minfo[39m: Using current directory as template folder
09:58:47 - [32minfo[39m: Loading a default sample.txt file.
09:58:47 - [32minfo[39m: Loading a single default request.json file.
09:58:47 - [32minfo[39m: Loading a default state.json file.
09:58:47 - [34mdebug[39m: fromDirectory
09:58:47 - [34mdebug[39m: fromDirectory
09:58:47 - [34mdebug[39m: fromDirectory
09:58:47 - [34mdebug[39m: fromDirectory
09:58:47 - [34mdebug[39m: fromDirectory
09:58:47 - [34mdebug[39m: fromDirectory
09:58:47 - [34mdebug[39m: fromDirectory
09:58:47 - [34mdebug[39m: constructor
09:58:47 - [34mdebug[39m: constructor
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processDirectory
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: fromDirectory
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: fromDirectory
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:47 - [34mdebug[39m: isFileInNodeModuleDir
09:58:47 - [34mdebug[39m: processFile
09:58:49 - [34mdebug[39m: fromDirectory
09:58:49 - [34mdebug[39m: isFileInNodeModuleDir
09:58:50 - [34mdebug[39m: isFileInNodeModuleDir
09:58:50 - [34mdebug[39m: isFileInNodeModuleDir
09:58:50 - [34mdebug[39m: isFileInNodeModuleDir
09:58:50 - [34mdebug[39m: isFileInNodeModuleDir
09:58:50 - [34mdebug[39m: isFileInNodeModuleDir
09:58:50 - [34mdebug[39m: processDirectory
09:58:50 - [34mdebug[39m: isFileInNodeModuleDir
09:58:50 - [34mdebug[39m: processFile
09:58:50 - [34mdebug[39m: isFileInNodeModuleDir
09:58:50 - [34mdebug[39m: processFile
09:58:50 - [34mdebug[39m: isFileInNodeModuleDir
09:58:50 - [34mdebug[39m: processFile
09:58:50 - [34mdebug[39m: isFileInNodeModuleDir
09:58:50 - [34mdebug[39m: processFile
09:58:50 - [34mdebug[39m: isFileInNodeModuleDir
09:58:50 - [34mdebug[39m: processFile
09:58:50 - [34mdebug[39m: isFileInNodeModuleDir
09:58:50 - [34mdebug[39m: processFile
09:58:50 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
09:58:50 - [32minfo[39m: undefined
10:03:00 - [32minfo[39m: Using current directory as template folder
10:03:00 - [32minfo[39m: Loading a default sample.txt file.
10:03:00 - [32minfo[39m: Loading a single default request.json file.
10:03:00 - [32minfo[39m: Loading a default state.json file.
10:03:00 - [34mdebug[39m: fromDirectory
10:03:00 - [34mdebug[39m: fromDirectory
10:03:00 - [34mdebug[39m: fromDirectory
10:03:00 - [34mdebug[39m: fromDirectory
10:03:00 - [34mdebug[39m: fromDirectory
10:03:00 - [34mdebug[39m: fromDirectory
10:03:00 - [34mdebug[39m: fromDirectory
10:03:00 - [34mdebug[39m: constructor
10:03:00 - [34mdebug[39m: constructor
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processDirectory
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: fromDirectory
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: fromDirectory
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:00 - [34mdebug[39m: isFileInNodeModuleDir
10:03:00 - [34mdebug[39m: processFile
10:03:01 - [34mdebug[39m: fromDirectory
10:03:01 - [34mdebug[39m: isFileInNodeModuleDir
10:03:01 - [34mdebug[39m: isFileInNodeModuleDir
10:03:01 - [34mdebug[39m: isFileInNodeModuleDir
10:03:01 - [34mdebug[39m: isFileInNodeModuleDir
10:03:01 - [34mdebug[39m: isFileInNodeModuleDir
10:03:01 - [34mdebug[39m: isFileInNodeModuleDir
10:03:01 - [34mdebug[39m: processDirectory
10:03:01 - [34mdebug[39m: isFileInNodeModuleDir
10:03:01 - [34mdebug[39m: processFile
10:03:01 - [34mdebug[39m: isFileInNodeModuleDir
10:03:01 - [34mdebug[39m: processFile
10:03:01 - [34mdebug[39m: isFileInNodeModuleDir
10:03:01 - [34mdebug[39m: processFile
10:03:01 - [34mdebug[39m: isFileInNodeModuleDir
10:03:01 - [34mdebug[39m: processFile
10:03:01 - [34mdebug[39m: isFileInNodeModuleDir
10:03:01 - [34mdebug[39m: processFile
10:03:01 - [34mdebug[39m: isFileInNodeModuleDir
10:03:01 - [34mdebug[39m: processFile
10:03:01 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (2:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (2:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
10:03:01 - [32minfo[39m: undefined
10:53:25 - [32minfo[39m: Using current directory as template folder
10:53:25 - [32minfo[39m: Loading a default sample.txt file.
10:53:25 - [32minfo[39m: Loading a single default request.json file.
10:53:25 - [32minfo[39m: Loading a default state.json file.
10:53:25 - [34mdebug[39m: fromDirectory
10:53:25 - [34mdebug[39m: fromDirectory
10:53:25 - [34mdebug[39m: fromDirectory
10:53:25 - [34mdebug[39m: fromDirectory
10:53:25 - [34mdebug[39m: fromDirectory
10:53:25 - [34mdebug[39m: fromDirectory
10:53:25 - [34mdebug[39m: fromDirectory
10:53:25 - [34mdebug[39m: constructor
10:53:25 - [34mdebug[39m: constructor
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processDirectory
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: fromDirectory
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: fromDirectory
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:25 - [34mdebug[39m: isFileInNodeModuleDir
10:53:25 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: fromDirectory
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processDirectory
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [34mdebug[39m: isFileInNodeModuleDir
10:53:26 - [34mdebug[39m: processFile
10:53:26 - [31merror[39m: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

SyntaxError: Failed to parse /Users/joshuahoogstraat/Documents/Coding/Smart Contracts/Accord Project/Own/lib/logic.js: 'import' and 'export' may appear only with 'sourceType: module' (3:0)

    at new Script (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/introspect/script.js:57:27)
    at ScriptManager.createScript (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/composer-common/lib/scriptmanager.js:61:16)
    at Object.process (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:986:66)
    at Function.processFile (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1054:27)
    at items.forEach (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1039:22)
    at Array.forEach (<anonymous>)
    at Function.processDirectory (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:1038:15)
    at template.getModelManager.updateExternalModels.then (/usr/local/lib/node_modules/@accordproject/cicero-cli/node_modules/@accordproject/cicero-core/lib/template.js:945:22)
    at process._tickCallback (internal/process/next_tick.js:68:7)
10:53:26 - [32minfo[39m: undefined
